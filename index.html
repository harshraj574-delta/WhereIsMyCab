<!doctype html>

<html>
<head>
    <title>ETMS DRIVE- View Current Location</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="ScreenOrientation" content="autoRotate:disabled">
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"
        integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>

    <link rel="stylesheet" href="css/style.css"> 
    <link href="css/bootstrap.min.css" rel="stylesheet">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Leaflet Ant Path for animated route -->
    <script src="https://cdn.jsdelivr.net/npm/leaflet-ant-path@1.3.0/dist/leaflet-ant-path.min.js"></script>
    
    <!-- Leaflet Moving Marker for smooth animation -->
    <script src="https://cdn.jsdelivr.net/npm/Leaflet-MovingMaker@0.0.1/MovingMarker.min.js"></script>

        <!-- <script src="https://unpkg.com/leaflet.animatedmarker@1.0.0/src/AnimatedMarker.js"></script> -->

    <!-- Leaflet rotating marker -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/leaflet-rotatedmarker@0.2.0/leaflet.rotatedMarker.min.js"></script> -->
    
    <!-- Leaflet Polyline Decorator for car on route -->
    <script src="https://cdn.jsdelivr.net/npm/leaflet-polylinedecorator@1.6.0/dist/leaflet.polylineDecorator.min.js"></script>
    
    
    
    <!-- HTML 5 QR Code Scanner -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js" integrity="sha512-r6rDA7W6ZeQhvl8S7yRVQUKVHdexq+GAlNkNNqVC7YyIV+NwqCTJe2hDWCiffTyRNOeGEzRRJ9ifvRm/HCzGYg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
        }

        #map {
            position: absolute;
            width: 100%;
            height: 100vh;
            top: 0;
            left: 0;
            z-index: 0;
        }

        :root {
            --white: #fff;
            --primary: #4a36ec;
            --success: #0baa60;
            --warning: #fdba0f;
        }

        * {
            padding: 0;
            margin: 0;
        }

        a {
            text-decoration: none;
        }

        body {
            font-family: PlusJakartaSans;
            font-stretch: normal;
            font-style: normal;
        }

        h1, h2, h3, h4, h5, h6, td p {
            margin: 0;
        }

        .text_version{
            position: absolute;
            bottom: 4px;
            left: 14px;
            font-size: 8px;
            color: #000;
            font-weight: 800;
        }

        .call_action {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 20px;
            padding: 16px 30px;
            width: calc(100% - 40px);
            position: fixed;
            bottom: 0px;
            border-radius: 16px;
            -webkit-backdrop-filter: blur(20px);
            backdrop-filter: blur(20px);
            background-color: rgba(41, 41, 41, 0.6);
        }

        .icon-container {
            position: relative;
            display: inline-block;
        }

        .icon-container::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 10px;
            height: 10px;
            background-color: red;
            border-radius: 50%;
            display: none;
        }

        .red-dot-visible::after {
            display: block;
        }

        .call_btn button {
            background-color: transparent;
            border: 0;
        }

        .call_action small {
            display: block;
            text-align: center;
            margin-top: 10px;
            font-size: 11px;
            font-weight: 600;
            color: var(--white);
        }

        .call_action a {
            font-size: 11px;
            font-weight: 600;
            color: var(--white);
        }

        .call_action div {
            font-size: 11px;
            font-weight: 600;
            color: var(--white);
        }

        .call_action button {
            background-color: transparent;
            border: 0;
            color: var(--white);
        }

        .driverBx {
            width: calc(100% - 40px);
            position: absolute;
            -webkit-backdrop-filter: blur(20px);
            backdrop-filter: blur(20px);
            box-shadow: 0 0 0 0 rgba(31, 22, 95, 0.2), 0 2px 4px 0 rgba(31, 22, 95, 0.2),
                0 7px 7px 0 rgba(31, 22, 95, 0.17), 0 16px 9px 0 rgba(31, 22, 95, 0.1),
                0 28px 11px 0 rgba(31, 22, 95, 0.03), 0 44px 12px 0 rgba(31, 22, 95, 0);
            background-color: #4a36ec;
            border: solid 1px #4a36ec;
            border-radius: 24px;
            border-bottom-left-radius: 0;
            margin: 20px;
        }

        .DetalBx {
            display: flex;
            justify-content: start;
            align-items: start;
        }

        .personDetalBx {
            padding: 10px 0 0 16px;
        }

        .personDetalBx h2 {
            font-size: 21px;
            font-weight: 600;
            color: var(--white);
            margin: 10px 0;
            width: auto;
            text-overflow: ellipsis;
            white-space: nowrap;
            overflow: hidden;
        }

        .personDetalBx h3 {
            font-size: 13px;
            font-weight: normal;
            color: var(--white);
        }

        .personDetalBx td {
            font-size: 13px;
            font-weight: normal;
            color: var(--white);
        }

        .personDetalBx .otp {
            font-size: 13px;
            font-weight: 600;
            color: var(--white);
            background: var(--success);
            margin-top: 10px;
        }

        .driver_badge {
            background: #ebe7ff;
            color: var(--primary);
        }

        .guard_badge {
            background: var(--warning);
            color: var(--primary);
        }

        .carousel-indicators {
            margin-bottom: 4px;
            border-radius: 8px;
        }

        .carousel-indicators [data-bs-target] {
            width: 8px;
            height: 8px;
            border: 0;
            border-radius: 8px;
        }

        .logo_icon {
            position: absolute;
            top: 18px;
            right: 18px;
            z-index: 1024;
        }

        .reaching {
            position: absolute;
            bottom: -52px;
            border-bottom-left-radius: 24px;
            border-bottom-right-radius: 24px;
            width: 110px;
            height: 52px;
            padding-left: 18px;
            display: flex;
            align-items: center;
            left: -1px;
            padding-top: 10px;
        }

        .reaching h4 {
            font-size: 13px;
            font-weight: bold;
            color: #fff;
        }

        .reaching h4 small {
            font-size: 11px;
            font-weight: 500;
            color: #fff;
            display: block;
            margin-bottom: 4px;
        }

        /* Enhanced Leaflet Styles */
        .leaflet-control-container {
            font-family: 'PlusJakartaSans', sans-serif;
        }

        .leaflet-popup-content {
            font-family: 'PlusJakartaSans', sans-serif;
            font-size: 14px;
        }

        /* Custom car marker animation */
        @keyframes carBounce {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
        }

        .car-marker {
            animation: carBounce 2s infinite;
        }

        /* Route line styling */
        .leaflet-interactive {
            transition: all 0.3s ease;
        }

        .leaflet-interactive:hover {
            stroke-width: 6 !important;
        }

        .modal-backdrop.show {
            -webkit-backdrop-filter: blur(20px);
            backdrop-filter: blur(20px);
            background-color: rgba(28, 29, 32, 0.2);
            opacity: 1;
        }

        body.disable-modal-styles .modal-backdrop.show {
            -webkit-backdrop-filter: none;
            backdrop-filter: none;
            background-color: transparent;
            opacity: 0;
        }

        .modal-content {
            border-radius: 24px;
        }

        .modal-body {
            padding: 24px;
        }

        .modal-body p {
            font-size: 16px;
            font-weight: 600;
            color: #545557;
        }

        .modal-body h5 {
            font-size: 21px;
            font-weight: 500;
            color: #1c1d20;
            margin-bottom: 18px;
        }

        .modal-body h6 {
            font-size: 16px;
            font-weight: 500;
            color: #545557;
            margin-bottom: 36px;
            line-height: 26px;
        }

        .list li {
            font-size: 16px;
            font-weight: 500;
            color: #545557;
            padding: 10px 0;
        }

        .btn-cst {
            height: 58px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 8px;
        }

        .offWhite {
            color: #f9f9f9;
        }

        .buttons {
            display: flex;
            justify-content: space-evenly;
        }

        .bg-dark {
            background: #0baa60 !important;
        }

        .bg-success {
            background: var(--success) !important;
        }

        .badge {
            display: inline-block;
            padding: 0.35em 0.65em;
            font-size: 0.75em;
            font-weight: 700;
            line-height: 1;
            color: #4a36ec;
            text-align: center;
            white-space: nowrap;
            vertical-align: baseline;
            border-radius: 0.25rem;
        }

        .badge:empty {
            display: none;
        }

        .btn .badge {
            position: relative;
            top: -1px;
        }

        .alert {
            position: relative;
            padding: 1rem 1rem;
            margin-bottom: 1rem;
            border: 1px solid transparent;
            border-radius: 0.25rem;
        }

        .modal-driverImage {
            display: none;
            position: relative;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1;
            padding: 20px;
        }

        .btn-close1 {
            background-color: transparent;
            border: 0;
            font-size: 20px;
            cursor: pointer;
            position: absolute;
            right: 2px;
            top: 2px;
            border-radius: 50%;
            transition: all 0.2s ease-in;
        }

        .btn-close1:hover {
            opacity: 0.7;
            background-color: lightgray;
        }

        .close {
            position: absolute;
            top: 10px;
            right: 10px;
            color: white;
            font-size: 30px;
            cursor: pointer;
        }

        .close:hover,
        .close:focus {
            color: #bbb;
            text-decoration: none;
            cursor: pointer;
        }

        .sidenav {
            height: 100%;
            width: 0;
            position: fixed;
            z-index: 1024;
            top: 0;
            right: 0;
            background-color: #fff;
            overflow-x: hidden;
            transition: 0.5s;
            padding-top: 60px;
        }

        .sidenav a {
            border-width: 1px 0 1px 0;
            border-color: rgb(0, 0, 0);
            border-style: solid;
            padding: 8px 8px 8px 32px;
            text-decoration: none;
            font-size: 15px;
            font-family: Poppins;
            color: #818181;
            display: block;
            transition: 0.3s;
        }

        .sidenav a:hover {
            color: #000000;
        }

        .sidenav .closebtn {
            border-radius: 50%;
            padding: 0.5em;
            margin-top: 2%;
            width: 15px;
            height: 15px;
            border: 1px solid #1b1b1c;
            color: #f01c1c;
            font-weight: bold;
            position: absolute;
            top: 0;
            text-align: center;
            left: 0px;
            font-size: 12px;
            margin-right: 50px;
            margin-left: 2%;
        }

        .sidenav .closebtn:hover {
            border: 1px solid blue;
            background-color: yellow;
            color: #ffffff;
        }

        .sidenav .closebtn::before {
            content: " ";
            position: absolute;
            display: block;
            width: 2px;
            left: 12px;
            top: 5px;
            bottom: 5px;
            transform: rotate(45deg);
        }

        @media screen and (max-height: 450px) {
            .sidenav {
                padding-top: 15px;
            }
            .sidenav a {
                font-size: 18px;
            }
        }

        center {
            font-size: 150px;
            animation: fadeIn 15s;
        }

        @keyframes center {
            0% { opacity: 0; }
            100% { opacity: 1; }
        }

        .offcanvas-custom {
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            border-bottom-right-radius: 20px;
            border-bottom-left-radius: 20px;
            border: 0;
            height: 95%;
            display: flex;
            align-self: center;
            justify-content: center;
        }

        .offcanvas-open .offcanvas {
            overflow-y: hidden;
            -webkit-overflow-scrolling: touch;
        }

        .offcanvas-header-custom {
            background-color: #f0f0f0;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
        }

        .offcanvas-header-custom h5 {
            font-size: 18px;
            font-weight: bold;
            text-overflow: ellipsis;
            width: 90%;
        }

        .offcanvas-header-custom h5 small {
            display: block;
            font-size: 11px;
            font-weight: 500;
            margin-top: 4px;
        }

        .offcanvas-footer {
            position: relative;
            padding: 8px 16px 8px 16px;
            background: #f0e7de;
        }

        .offcanvas-footer input {
            height: 50px;
            width: 100%;
            border: 1px solid #dddddd;
            border-radius: 25px;
            padding: 0 80px 0 16px;
        }

        .offcanvas-footer input::placeholder {
            font-size: 13px;
        }

        .offcanvas-footer img {
            position: absolute;
            z-index: 9;
            top: 50%;
            right: 12px;
            transform: translateY(24%);
        }

        .chats {
            padding: 12px 16px;
            margin-bottom: 6px;
            border-radius: 20px;
            width: fit-content;
            word-wrap: break-word;
        }

        .chats.recevier {
            background-color: #ffffff;
            float: left;
            clear: both;
        }

        .chats.sender {
            background-color: #e7ffdb;
            float: right;
            clear: both;
        }

        .offcanvas-header-custom .btn-left {
            background: transparent url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%23000'%3e%3cpath d='M12 8a.5.5 0 0 1-.5.5H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H11.5a.5.5 0 0 1 .5.5z'/%3E%3C/svg%3E");
            box-sizing: content-box;
            width: 1.4em;
            height: 1.4em;
            padding: 0.25em 0.25em;
            color: #000;
            border: 0;
            border-radius: 0.25rem;
            opacity: 0.8;
        }

        .offcanvas-header-custom .btn-left {
            padding: 0.5rem 0.5rem;
            margin-top: -0.5rem;
            margin-right: -0.5rem;
            margin-bottom: -0.5rem;
        }

        .scroller {
            background: #f0e7de;
            overflow: auto;
            height: 100px;
            display: flex;
            flex-direction: column-reverse;
            -webkit-overflow-scrolling: touch;
        }

        html {
            position: static;
            overflow-y: hidden;
            height: 100%;
            max-height: 100%;
        }

        body {
            overflow: hidden;
            height: 100%;
            max-height: 100%;
        }

        ::-webkit-scrollbar {
            height: 5px;
            width: 5px;
        }

        ::-webkit-scrollbar-track {
            border-radius: 0;
            box-shadow: inset 0 0 1px rgba(0, 0, 0, 0.3);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 0;
        }

        ::-webkit-scrollbar-thumb:window-inactive {
            background: rgba(0, 0, 0, 0.3);
        }

        .scroller .scroller-content .item {
            height: 20px;
            transform: translateZ(0);
            transform: translate3d(0, 0, 0);
            z-index: 1030;
            overflow-y: auto;
            overscroll-behavior: contain;
            -webkit-overflow-scrolling: touch;
            overflow: scroll;
        }

        .offcanvasTapBtn {
            background-color: transparent !important;
            border: 0 !important;
        }

        .tap_action {
            margin: 0px;
            padding: 16px 30px;
            width: 100%;
            position: fixed;
            bottom: 0px;
            border-top-left-radius: 16px;
            border-top-right-radius: 16px;
            background-color: rgba(41, 41, 41, 0.6);
        }

        .tap_action small {
            display: block;
            text-align: center;
            margin-top: 10px;
            font-size: 11px;
            font-weight: 600;
            color: var(--white);
        }

        .tap_action a {
            display: block;
            font-size: 11px;
            font-weight: 600;
            color: var(--white);
            text-align: center;
            margin-bottom: 26px;
        }

        .tap_action div {
            width: 32%;
            display: block !important;
            float: left;
        }

        .tap_action button {
            background-color: transparent;
            border: 0;
            width: 100%;
        }

        * {
            box-sizing: border-box;
        }

        #chat-container {
            width: 100%;
            margin: 0 auto;
            flex-direction: column-reverse;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
        }

        .message-bubble {
            color: #000;
            border-radius: 10px;
            padding: 10px 15px;
            max-width: 50%;
            word-wrap: break-word;
            margin-top: 8px;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
        }

        .send-button img {
            width: 40%;
            height: 40%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #loader {
            animation: animate 1.5s linear infinite;
            clip: rect(0, 80px, 80px, 40px);
            height: 80px;
            width: 80px;
            position: absolute;
            left: calc(50% - 40px);
            top: calc(50% - 40px);
        }

        @keyframes animate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(220deg); }
        }

        #loader:after {
            animation: animate2 1.5s ease-in-out infinite;
            clip: rect(0, 80px, 80px, 40px);
            content: '';
            border-radius: 50%;
            height: 80px;
            width: 80px;
            position: absolute;
        }

        @keyframes animate2 {
            0% {
                box-shadow: inset #d12222 0 0 0 17px;
                transform: rotate(-140deg);
            }
            50% {
                box-shadow: inset #dc5b5b 0 0 0 2px;
            }
            100% {
                box-shadow: inset #712929 0 0 0 17px;
                transform: rotate(140deg);
            }
        }

        .message {
            margin-top: 5px;
            max-width: fit-content;
            border-radius: 10px;
            padding: 10px 15px;
            max-width: 50%;
            word-wrap: break-word;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
        }

        .sent {
            background-color: #DCF8C6;
            align-self: flex-end;
            margin-left: auto;
        }

        .received {
            background-color: #F5F5F5;
            align-self: flex-start;
            color: #000;
        }

        .timestamp {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
            text-align: right;
        }

        .scrollable-tabs-container {
            background: #f0e7de;
            max-width: 700px;
            margin: 5px auto;
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        .scrollable-tabs-container svg {
            width: 24px;
            height: 24px;
            padding: 8px;
            cursor: pointer;
            color: #fff;
            border-radius: 50%;
            pointer-events: auto;
        }

        .scrollable-tabs-container ul {
            display: flex;
            gap: 16px;
            padding: 12px 12px;
            margin: 0;
            list-style: none;
            overflow-x: scroll;
            -ms-overflow-style: none;
            scrollbar-width: none;
            scroll-behavior: smooth;
        }

        .scrollable-tabs-container ul.dragging a {
            pointer-events: none;
        }

        .scrollable-tabs-container ul.dragging {
            scroll-behavior: auto;
        }

        .scrollable-tabs-container ul::-webkit-scrollbar {
            display: none;
        }

        .scrollable-tabs-container a {
            color: #fff;
            text-decoration: none;
            background: #8DB5F7;
            padding: 4px 24px;
            display: inline-block;
            border-radius: 20px;
            user-select: none;
            width: 300px;
        }

        .scrollable-tabs-container a.active {
            background: #fff;
            color: #000;
        }

        .scrollable-tabs-container .right-arrow,
        .scrollable-tabs-container .left-arrow {
            position: absolute;
            height: 100%;
            width: 100px;
            top: 0;
            display: none;
            align-items: center;
            padding: 0 10px;
            pointer-events: none;
        }

        .scrollable-tabs-container .right-arrow.active,
        .scrollable-tabs-container .left-arrow.active {
            display: flex;
        }

        .scrollable-tabs-container .right-arrow {
            right: 0;
            justify-content: flex-end;
        }

        .scrollable-tabs-container svg:hover {
            background: #fff;
        }

        .modal-body.share-body {
            margin: 0px;
            padding: 16px 30px;
            width: 100%;
            position: fixed;
            bottom: 0px;
            -webkit-backdrop-filter: blur(20px);
            backdrop-filter: blur(0px);
        }

        .modal-body.share-body small {
            display: block;
            text-align: center;
            margin-top: 10px;
            font-size: 11px;
            font-weight: 600;
            color: var(--white);
        }

        .modal-body.share-body a {
            display: block;
            font-size: 11px;
            font-weight: 600;
            color: var(--white);
            text-align: center;
            margin-bottom: 26px;
        }

        .modal-body.share-body div {
            width: 32%;
            display: block !important;
            float: left;
        }

        .modal-body.share-body button {
            background-color: transparent;
            border: 0;
            width: 100%;
        }

        .modal-body.share-body img {
            width: 60px;
            height: 60px;
        }

        .popup-container {
            display: flex;
            justify-content: center;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .popup {
            background-color: #f3f3f3;
            margin: auto;
            box-shadow: 0 2px 6px rgba(0,0,0,.3);
            width: auto;
            min-width: 300px;
            max-width: 600px;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            pointer-events: auto;
        }

        .qr_code {
            position: fixed;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            z-index: 10;
        }

        #qrCodeScannerContainer {
            width: 100%;
            max-width: 300px;
            height: 300px;
            border: 2px solid #ddd;
            margin: 0 auto;
            padding: 10px;
            background: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #qr-reader {
            width: 100%;
            max-width: 280px;
            max-height: 280px;
            height: 280px;
        }

        .modal-success .modal-content {
            background-color: #d4edda;
            color: #155724;
        }

        .modal-danger .modal-content {
            background-color: #f8d7da;
            color: #721c24;
        }

        .modal-warning .modal-content {
            background-color: #fff3cd;
            color: #856404;
        }

        .modal-info .modal-content {
            background-color: #d1ecf1;
            color: #0c5460;
        }

        /* Add this to your existing <style> block */

/* Optional: Style the container div if needed, but ensure it doesn't interfere */
.car-marker-container {
    display: flex; /* Ensures image inside behaves well */
    justify-content: center;
    align-items: center;
    /* No transforms here, Leaflet will handle this div's position */
}

/* The actual image inside the divIcon that will rotate */
.car-icon-rotatable {
    /* Set width/height relative to parent for responsiveness, if parent has fixed size */
    width: 100%; 
    height: 100%;
    
    /* Crucial: Set transform-origin to center for proper rotation around its middle */
    transform-origin: center; 
    
    /* Ensure it's a block element */
    display: block; 
}

html, body {
    overflow: auto;
}


    </style>
</head>

<body class="offcanvas-open">
    <script src="https://www.gstatic.com/firebasejs/8.2.9/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.2.9/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.2.9/firebase-messaging.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Turf.js/6.5.0/turf.min.js"
        integrity="sha512-Q7HOppxoH0L2M7hreVoFCtUZimR2YaY0fBewIYzkCgmNtgOOZ5IgMNYxHgfps0qrO1ef5m7L1FeHrhXlq1I9HA=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    
    <div id="notifier" class="center" style="position:fixed;
        top: 10%;
        left: 50%;
        width:24em;
        height:18em;
        display: none;
        margin-top: -9em;
        margin-left: -12em;
        border: 1px solid #ffffff;
        background-color: #ffffff;">
        <p style="text-align:center;font-family:Poppins">Cab live tracking is not available currently,<br> as you have
            already been marked as boarded/No-Show.</p>
    </div>
    
    <div class="container2">
        <div id="output"></div>
    </div>
    
    <div id="map" tabindex="0" aria-label="Cab location map. Press Enter or tap to hear the current cab location."></div>

    <!-- First Modal -->
    <div class="modal fade" id="firstModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-body">
                    <p>IMPORTANT protocols to follow at Accenture if you are unwell or a close contact of a Coronavirus
                        positive individual.</p>
                    <ul class="list my-3" id="modal-list">
                        <li>Stay home if you are unwell.</li>
                        <li>Seek medical advice if you have a fever, cold, headache, cough or other flu-like symptoms.
                            Contact ASOC at +91 80 71641777 / 080 69541777 . Inform your supervisor/ HR representative
                            immediately</li>
                        <li>DO NOT return to office until you have been notified through e-mail by your HR
                            Representative that you can do so</li>
                    </ul>
                    <p>Regards, India Accenture Workplace Solutions</p>
                    <div class="d-grid"><button type="button" class="btn btn-dark btn-cst offWhite mt-4"
                            data-bs-toggle="modal" data-bs-target="#secondModal" data-bs-dismiss="modal">OK</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Second Modal -->
    <div class="modal fade" id="secondModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" id="modal-dialog2">
            <div class="modal-content">
                <div class="modal-body">
                    <div class="d-block text-center">
                        <p>New Features in eTMS Buddy</p>
                        <img src="images/logo.svg" alt="">
                    </div>
                    <ul class="list">
                        <li><strong class="d-block">Cab users can mark themselves as "no-show" </strong>
                            If you've missed cancelling your scheduled ride for day, you can now mark yourself as
                            "no-show" on the "Where is my cab" tab. You no longer have to wait for the transport
                            helpdesk to call you.</li>
                        <li><strong class="d-block">Check the boarding status of fellow passengers </strong>
                            You will now be able to check the boarding status of your fellow passengers under the "cab
                            info" tab. Use this feature to get real-time updates on scheduled pick-ups.</li>
                    </ul>
                    <div class="d-grid"><button type="button" class="btn btn-dark btn-cst mt-4 offWhite"
                            data-bs-dismiss="modal">OK</button></div>
                </div>
            </div>
        </div>
    </div>

    <div class="popup-container" id="popupLocationNotAccessible" style="display: none;">
        <div class="popup">
            Your Cab's current location cannot be determined as we do not seem to be receiving data from the Driver's mobile.
            Please contact the Driver to know his exact location.
        </div>
    </div>

    <div class="popup-container" id="popupNetworkConnection" style="display: none;">
        <div class="popup">
            It seems like you're in a low connectivity area, and some features couldn't function properly.
            Please swipe down to refresh once you have a better connection.
        </div>
    </div>

    <!-- QR Code Modal -->
    <div class="modal fade" id="qrCodeModal" tabindex="-1" aria-labelledby="qrCodeModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center">
                    <p>Scan QR Code</p>
                    <div id="qrCodeScannerContainer" class="d-flex justify-content-center">
                        <div id="qr-reader" class="border rounded shadow"></div>
                    </div>
                    <p class="mt-3"><strong>Place the QR code within the frame to scan</strong></p>
                    <div class="d-grid">
                        <button type="button" class="btn btn-dark btn-cst mt-4 offWhite" data-bs-dismiss="modal" id="closeButton">
                            Close
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Driver and Guard Info Box -->
    <div id="main" class="driverBx">
        <img src="images/logo_icon.svg" class="logo_icon" alt="">
        <div id="carouselExampleIndicators" class="carousel slide" data-bs-ride="carousel" data-bs-interval="false">
            <div class="carousel-indicators" id="carousel-indicators">
                <button type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide-to="0" class="active"
                    aria-current="true" aria-label="Slide 1" id="carousel-inner"></button>
                <button type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide-to="1"
                    aria-label="Slide 2" id="carousel-item"></button>
            </div>
            <div class="reaching bg-success" id="etaDiv">
                <h4 id="eta"></h4>
            </div>

            <div class="carousel-inner" id="carousel-inner">
                <div class="carousel-item active">
                    <div class="DetalBx">
                        <div class="imgBx">
                            <img id="imageDriver" height="148px" width="110px" alt="Driver's Image" style="border-top-left-radius: 24px;" onerror="this.onerror=null; this.src='images/no_driver.png'"/>
                        </div>
                        <div class="personDetalBx">
                            <span class="badge rounded-pill driver_badge">Driver</span>
                            <h2 id="tdName"></h2>
                            <h3>
                                <table>
                                    <tr>
                                        <td style="text-transform: uppercase;" id="tdVehicleType"></td>
                                        <td>&nbsp;|&nbsp;</td>
                                        <td id="tdRegistrationNo"></td>
                                    </tr>
                                </table>
                            </h3>
                            <span class="badge rounded-pill otp" id="Otp" style="display:none;"></span>
                            <span class="badge rounded-pill otp" id="boardingStatus" style="display:none;"></span>
                        </div>
                    </div>
                </div>
                <div class="carousel-item" id="carousel-item1">
                    <div class="DetalBx" id="carousel-item1">
                        <div class="imgBxGuard">
                            <img id="imageGuard" height="148px" width="110px" style="border-top-left-radius: 24px;" alt="Guard's Image" onerror="this.onerror=null; this.src='images/no_guard.png'"/>
                        </div>
                        <div class="personDetalBx">
                            <span class="badge rounded-pill driver_badge">Guard</span>
                            <h2 id="guardName"></h2>
                            <h3 id="escortId"></h3>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- <div id="etaListContainer" class="bg-light p-2 rounded mt-2" style="margin: 0 20px;">
    <h6 class="fw-bold">Upcoming Stops ETA:</h6>
    <ul id="etaList" class="list-unstyled mb-0"></ul>
</div> -->
    </div>

    <div data-bs-toggle="offcanvas" data-bs-target="#offcanvasBottom1"
    aria-controls="offcanvasBottom1" id="callAction" style="display: none;">
        <span class="call_action text-center d-block">
            <a class="fs-3">Tap For Options</a>
        </span>
    </div>

    <div class="offcanvas offcanvas-bottom offcanvasTapBtn" tabindex="-1" id="offcanvasBottom1"
        aria-labelledby="offcanvasBottomLabel">
        <div class="tap_action">
            <div>
                <button id="selfNoShowButton">
                    <span data-bs-toggle="modal" data-bs-target="#noShowModal" data-bs-dismiss="offcanvas">
                        <img src="images/icon1.png" alt="">
                        <small>Self No Show</small>
                    </span>
                </button>
            </div>

            <div id="help_btn">
                <button id="helpButton">
                    <a id="aTag" href="tel:">
                        <span>
                            <img src="images/icon4.png" alt="">
                            <small>Call Helpdesk</small>
                        </span>
                    </a>
                </button>
            </div>

            <div>
                <button>
                    <a id="callButton">
                        <span data-bs-toggle="modal" data-bs-target="#callDriverConfirmationDialog" data-bs-dismiss="offcanvas">
                            <img src="images/icon3.png" alt="">
                            <small>Call Driver</small>
                        </span>
                    </a>
                </button>
            </div>

            <div>
                <button id="shareButton">
                    <span data-bs-toggle="modal" data-bs-dismiss="offcanvas" data-bs-target="#exampleModal">
                        <img src="images/icon5.png" alt="">
                        <small>Share My Trip</small>
                    </span>
                </button>
            </div>

            <div class="icon-container">
                <button id="chatButton">
                    <span data-bs-toggle="offcanvas" data-bs-target="#chatBox">
                        <img src="images/icon6.png" alt="">
                        <small>Chat</small>
                    </span>
                </button>
            </div>

            <div>
                <button id="cabNoShowButton">
                    <a data-bs-dismiss="offcanvas">
                        <img src="images/icon2.png" alt="">
                        <small>Cab No Show</small>
                    </a>
                </button>
            </div>
        </div>
    </div>

    <div class="offcanvas offcanvas-custom offcanvas-bottom" tabindex="-1" id="chatBox"
        aria-labelledby="offcanvasBottomLabel" id="offcanvasExample">
        <div class="offcanvas-header offcanvas-header-custom">
            <div class="d-flex justify-content-start align-items-center">
                <button type="button" class="btn-left me-3" data-bs-dismiss="offcanvas" aria-label="Close"></button>
                <div class="d-flex justifiy-content-center align-items-center">
                    <div>
                        <img id="imageDriver1" src="" height="53px" width="53px" alt="Driver's Image" style="border-radius: 50%;"/>
                    </div>
                    <h5 class="ms-3">
                        <div id="tdName1"></div><small>
                            <table>
                                <tr>
                                    <td id="tdVehicleType1"></td>
                                    <td>&nbsp;|&nbsp;</td>
                                    <td id="tdRegistrationNo1"></td>
                                </tr>
                            </table>
                        </small>
                    </h5>
                </div>
            </div>
        </div>
        <div class="offcanvas-body small scroller">
            <div class="scroller-content">
                <div id="chat-messages"></div>
            </div>
        </div>

        <div class="offcanvas-footer">
            <div class="scrollable-tabs-container">
                <div class="left-arrow">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                        stroke="currentColor" class="w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
                    </svg>
                </div>
                <div id="chat-messages1-div">
                    <ul id="chat-messages1"></ul>
                </div>
                <div class="right-arrow active">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                        stroke="currentColor" class="w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" />
                    </svg>
                </div>
            </div>
            <input class="chatInput" id="message-input" placeholder="Enter Message..." type="text"
                autocomplete="off" oninput="validateInput(this)"></input>
            <img src="images/send_button_1.png" alt="" id="send-button">
        </div>
    </div>

    <!-- No Show Modal -->
    <div class="modal fade" id="noShowModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body">
                    <h5>Confirmation</h5>
                    <h6>Are you sure that you want to mark as No-Show for this trip?</h6>
                    <div class="row">
                        <div class="col-6"><button type="button" class="btn w-100 btn-outline-secondary btn-cst"
                                data-bs-dismiss="modal">Cancel</button></div>
                        <div class="col-6" id="selfNoShow"><button type="button" class="btn w-100 btn-danger btn-cst"
                                data-bs-dismiss="modal">OK</button></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Call Driver Confirmation Modal -->
    <div class="modal fade" id="callDriverConfirmationDialog" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body">
                    <h5>Confirmation</h5>
                    <h6>Do you wish to call the driver?</h6>
                    <div class="row">
                        <div class="col-6"><button type="button" class="btn w-100 btn-outline-secondary btn-cst"
                                data-bs-dismiss="modal" id="callDriverCancelButton">Cancel</button></div>
                        <div class="col-6" id="callDriverConfirmationButton"><button type="button" class="btn w-100 btn-danger btn-cst"
                                data-bs-dismiss="modal">OK</button></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Alert -->
    <div class="alert_message alert-dismissible py-2 fs-14 fw-semibold fade show" style="display: none; top: 50%; left: 0%; position: fixed; width: 100%;" id="alert">
        <div style="display: flex; justify-content: center; align-items: center;">
            <span id="message"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close" onclick="closeAlert()"></button>
        </div>
    </div>

    <!-- Message Modal -->
    <div class="modal fade" id="alertModal" tabindex="-1" aria-labelledby="alertModalLabel" aria-hidden="true" style="display: none; top: 40%;">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="alertModalLabel">Notification</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" onclick="closeModal()"></button>
                </div>
                <div class="modal-body">
                    <span id="modalMessage" class="fs-14 fw-semibold"></span>
                </div>
            </div>
        </div>
    </div>

    <!-- Share Modal -->
    <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div onclick="share()">
                        <a>
                            <img src="images/whatsapp.png" alt="WhatsApp">
                            <small>Share through WhatsApp</small>
                        </a>
                    </div>
                    <div onclick="share1()">
                        <a>
                            <img src="images/messaging_icon.png" alt="Messaging Icon">
                            <small>Share through message</small>
                        </a>
                    </div>
                </div>
                <div class="modal-footer"></div>
            </div>
        </div>
    </div>

    <div class="text_version">1.10.00</div>

    <div class="qr_code">    
        <span>
            <img src="images/qr_scanner.png" alt="" width="50vw" height="50vh" id="qrCodeButton" style="display: none;">        
        </span>
    </div>

    <!-- ARIA live region for screen reader announcements -->
    <div id="live-region" aria-live="polite" style="position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden;"></div>

    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script src="js/bootstrap.bundle.min.js"></script>
    
    <script>
       
//  FINAL REVISED OpenSourceMapService: Robust Rotation with Custom DivIcon
class OpenSourceMapService {
    constructor() {
        this.map = null;
        this.carMarker = null;
        this.routePolyline = null;
        this.antPath = null;
        this.employeeMarkers = [];
        this.previousLatLng = null; // To track previous position for rotation
    }

    // Initialize Leaflet with OpenStreetMap
    initializeMap(containerId = 'map') {
        this.map = L.map(containerId, {
            zoom: 14,
            zoomControl: false,
            scrollWheelZoom: false,   
            doubleClickZoom: true,   
            boxZoom: true,           
            keyboard: true,          
            dragging: true,          
            touchZoom: true,
        });
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors',
            maxZoom: 19,
        }).addTo(this.map);
        this.map.scrollWheelZoom.enable();
        return this.map;
    }

    // Add employee home marker
    addEmployeeMarker(lat, lng, iconUrl = 'images/home.png') {
        const homeIcon = L.icon({
            iconUrl: iconUrl,
            iconSize: [25, 25],
            iconAnchor: [12, 12],
        });
        const marker = L.marker([lat, lng], { icon: homeIcon }).addTo(this.map);
        this.employeeMarkers.push(marker);
        return marker;
    }

    // Add car marker using L.divIcon with a rotatable inner image
    addCarMarker(lat, lng, isShuttle = false) {
        const iconUrl = isShuttle ? 'images/shuttle.png' : 'images/car.svg';
        const iconSize = isShuttle ? [48, 48] : [38, 38];
        const halfWidth = iconSize[0] / 2;
        const halfHeight = iconSize[1] / 2;

        // Create a custom divIcon
        const customCarIcon = L.divIcon({
            className: 'car-marker-container', // Main container controlled by Leaflet
            html: `<img src="${iconUrl}" style="width:100%; height:100%; transform-origin: center; display: block;" class="car-icon-rotatable">`, // Inner image for rotation
            iconSize: iconSize,
            iconAnchor: [halfWidth, halfHeight], // Anchor in the center
            popupAnchor: [0, -halfHeight] // Popup position relative to anchor
        });

        if (this.carMarker) {
            this.map.removeLayer(this.carMarker);
        }

        if (typeof L.Marker.movingMarker === 'function') {
            this.carMarker = L.Marker.movingMarker([[lat, lng]], [], {
                icon: customCarIcon,
                autostart: false,
            }).addTo(this.map);
            // console.log(console.log("Using L.Marker.movingMarker for car animation."););
        } else {
            this.carMarker = L.marker([lat, lng], {
                icon: customCarIcon
            }).addTo(this.map);
            console.warn("L.Marker.movingMarker is not available. Using standard L.marker (no animation).");
        }
        
        this.previousLatLng = L.latLng(lat, lng);
        return this.carMarker;
    }

    // Helper to get the inner rotatable image element
    _getRotatableCarIconElement() {
        // The movingMarker's _icon is the outer div.
        // We need to find the img inside it.
        return this.carMarker && this.carMarker._icon ? 
               this.carMarker._icon.querySelector('.car-icon-rotatable') : null;
    }

    // Create an animated route
    createAnimatedRoute(waypoints, carPosition) {
        this.clearRoute();
        if (waypoints.length < 2) return;

        // this.routePolyline = L.polyline(waypoints, {
        //     color: '#4285F4',
        //     weight: 4,
        //     opacity: 0.8,
        // }).addTo(this.map);

        // this.antPath = L.polyline.antPath(waypoints, {
        //     color: '#FF6B6B',
        //     weight: 2,
        //     opacity: 0.6,
        //     delay: 1000,
        //     dashArray: [10, 20],
        // }).addTo(this.map);

        this.addCarOnRoute(waypoints, carPosition);
        this.map.fitBounds(this.routePolyline.getBounds(), { padding: [20, 20] });
    }

    // Add the car to the route and start animation
    addCarOnRoute(waypoints, carPosition) {
        if (!waypoints.length) return;
        this.addCarMarker(carPosition[0], carPosition[1]);
        this.animateCarAlongRoute(waypoints);
    }

    // Animate the car along the full route with rotation
    animateCarAlongRoute(waypoints) {
        if (!this.carMarker || waypoints.length < 2) return;

        if (typeof this.carMarker.moveTo !== 'function') {
            console.warn("Car marker is not a MovingMarker instance. Skipping route animation.");
            return;
        }

        const durations = [];
        for (let i = 0; i < waypoints.length - 1; i++) {
            const distance = this.calculateDistance(waypoints[i], waypoints[i + 1]);
            const duration = (distance / 30) * 3600 * 1000; // Assume 30 km/h for animation speed
            durations.push(Math.max(duration, 1000));
        }

        this.carMarker.setLatLng(waypoints);
        this.carMarker.setDurations(durations);
        this.carMarker.start();

        this.carMarker.on('move', (e) => {
            const currentLatLng = e.latlng;
            // Only rotate if there was a previous position to calculate bearing from
            if (this.previousLatLng) {
                const bearing = this._calculateBearing(
                    this.previousLatLng.lat, this.previousLatLng.lng,
                    currentLatLng.lat, currentLatLng.lng
                );
                // 🔧 FIX: Target the inner rotatable element for rotation
                const rotatableElement = this._getRotatableCarIconElement();
                if (rotatableElement) {
                    rotatableElement.style.transform = `rotate(${bearing}deg)`;
                }
            }
            this.previousLatLng = currentLatLng;
        });
    }

    // Update car position with rotation
    updateCarPosition(newLat, newLng, animate = true) {
        if (!this.carMarker) {
            this.addCarMarker(newLat, newLng);
            return;
        }

        const newLatLng = L.latLng(newLat, newLng);
        
        if (animate && typeof this.carMarker.moveTo === 'function') {
            const currentPos = this.carMarker.getLatLng();
            const distance = currentPos.distanceTo(newLatLng);
            const duration = Math.max((distance / 25) * 1000, 2000); // Assume 25 m/s

            // Calculate bearing from current position to new position
            const bearing = this._calculateBearing(
                currentPos.lat, currentPos.lng,
                newLat, newLng
            );
            
            // 🔧 FIX: Target the inner rotatable element for rotation
            const rotatableElement = this._getRotatableCarIconElement();
            if (distance > 1 && rotatableElement) { 
                rotatableElement.style.transform = `rotate(${bearing}deg)`;
            }

            this.carMarker.moveTo(newLatLng, duration);
            this.previousLatLng = newLatLng; // Update previous position for next bearing calculation
        } else {
            this.carMarker.setLatLng(newLatLng);
            this.previousLatLng = newLatLng; // Update previous position even if not animating
        }

        this.map.panTo(newLatLng);
    }
    
    // Helper to calculate bearing between two points
    _calculateBearing(lat1, lon1, lat2, lon2) {
        const toRadians = (deg) => deg * Math.PI / 180;
        const toDegrees = (rad) => rad * 180 / Math.PI;

        const φ1 = toRadians(lat1);
        const φ2 = toRadians(lat2);
        const Δλ = toRadians(lon2 - lon1);

        const y = Math.sin(Δλ) * Math.cos(φ2);
        const x = Math.cos(φ1) * Math.sin(φ2) - Math.sin(φ1) * Math.cos(φ2) * Math.cos(Δλ);

        let bearing = toDegrees(Math.atan2(y, x));
        return (bearing + 360) % 360;
    }

    
    // Add markers for each employee stop
    addRouteMarkers(employeeData) {
        employeeData.forEach(employee => {
            if (employee.lat && employee.lng) {
                const iconUrl = employee.trackingStatus === 'Boarded' 
                    ? `images/boarded/number-${employee.stopNo}.png`
                    : `images/not_boarded/number-${employee.stopNo}.png`;

                const markerIcon = L.icon({
                    iconUrl: iconUrl,
                    iconSize: [24, 24],
                    iconAnchor: [12, 12],
                });

                const marker = L.marker([employee.lat, employee.lng], { 
                    icon: markerIcon 
                }).addTo(this.map);

                marker.bindPopup(`
                    <div>
                        <strong>${employee.empName || 'Employee'}</strong><br>
                        Stop: ${employee.stopNo}<br>
                        Status: ${employee.trackingStatus}
                    </div>
                `);
                this.employeeMarkers.push(marker);
            }
        });
    }

    // Calculate distance between two points (using Leaflet's built-in method for LatLng objects)
    calculateDistance(point1, point2) {
        return L.latLng(point1).distanceTo(L.latLng(point2)) / 1000; // returns distance in km
    }

    // Clear existing route layers
    clearRoute() {
        if (this.routePolyline) this.map.removeLayer(this.routePolyline);
        if (this.antPath) this.map.removeLayer(this.antPath);
        this.employeeMarkers.forEach(marker => this.map.removeLayer(marker));
        this.routePolyline = null;
        this.antPath = null;
        this.employeeMarkers = [];
    }

    // Create a simple straight-line route
    createSimpleRoute(start, waypoints, end) {
        const allPoints = [start, ...waypoints, end];
        this.createAnimatedRoute(allPoints, start);
        return allPoints;
    }

    // In OpenSourceMapService

async fetchLiveETAs(driverLat, driverLng, employees, city = "delhi") {
    const coords = [[driverLng, driverLat], ...employees.map(e => [e.lng, e.lat])];

    try {
        const response = await fetch('https://mapapi.etmsonline.in/table?annotations=duration,distance', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                city,
                coordinates: coords
            })
        });
        const data = await response.json();

        if (data && data.durations && data.durations.length) {
            return data.durations[0]; // first row: driver to employees
        }
        return [];
    } catch (error) {
        console.error("Error fetching ETA from OSRM:", error);
        return [];
    }
}

updateEtaListUI(employees, durations) {
    const etaListEl = document.getElementById('etaList');
    if (!etaListEl) return;

    // Clear previous
    etaListEl.innerHTML = '';

    durations.forEach((seconds, index) => {
        const etaMins = Math.round(seconds / 60);
        const emp = employees[index];
        const li = document.createElement('li');
        li.className = 'mb-1';
        li.innerHTML = `
            <strong>${emp.empName || 'Employee'}</strong> 
            (Stop ${emp.stopNo}): 
            ETA <span class="badge bg-success">${etaMins} mins</span>
        `;
        etaListEl.appendChild(li);
    });
}


async updateEmployeeETAs(driverLat, driverLng, employees) {
    // const durations = await this.fetchLiveETAs(driverLat, driverLng, employees, "delhi");
    // durations.forEach((seconds, index) => {
    //     const etaMins = Math.round(seconds / 60);
    //     const emp = employees[index];
    //     if (emp.marker) {
    //         emp.marker.setPopupContent(`
    //             <div>
    //                 <strong>${emp.empName || 'Employee'}</strong><br>
    //                 Stop: ${emp.stopNo}<br>
    //                 Status: ${emp.trackingStatus}<br>
    //                 ETA: ${etaMins} mins
    //             </div>
    //         `);
    //     }
    // });

    // ✏ Also update list in UI
    // this.updateEtaListUI(employees, durations);
}



    centerMap(lat, lng, zoom = 14) {
        this.map.setView([lat, lng], zoom);
    }

    panTo(lat, lng) {
        this.map.panTo([lat, lng]);
    }
}

// Global variables
        var BASE_URL;
        var URL_CabValidation;
        var URL_ProfilePicture;
        var URL_CallingApi;
        var URL_RouteInfo;
        var URL_RouteDetail;
        var URL_RouteDetailShuttle;
        var URL_GetGpsLogger;
        var URL_UpdateCabNoShow;
        var URL_UpdateTrackingSelf;

        var directionsService;
        var distanceMatrixService;
        var directionsRenderer;
        var value;
        var value1;
        var vs;
        var routeid;
        var empid;
        var clientid;
        var locupdate;
        var showMapUpdate;
        var facility;
        var cabnoshowradius;
        var driver_contact = [];
        var driver_contact1;
        var empname;
        var emp_contact;
        var homelatlng;
        var profileurl;
        var EscortImage;
        var driverName;
        var vehicleRegNo = [];
        var vehicleType;
        var tptContactNo;
        var b2bFlag = 1;
        var emplatlng1;
        var emplatlng;
        var pp = [];
        var myTrackingStatus = '';
        var isproximity = 1;
        var eta = '';
        var b2bflag = 1;
        var url = [];
        var fromloc;
        var toloc = '';
        var OTP;
        var gender;
        var tripType;
        var employeeid;
        var poly = [];
        var decorator;
        var line;
        var interval = 0;
        var first = true;
        var first1 = true;
        var driverlat; 
        var driverlng;
        var position = [];
        var marker;
        var marker3;
        var heading = [];
        var driverMarker;
        var driverMarkerMmi;
        let path = [];
        var newPosition;
        var mNewPosition = [];
        var routeDetFrequency = 90000;
        var myUrl = window.location.href;
        var exoPhone;
        var isShuttle = false;
        let employeeData = []; // define globally

        // Map service instance
        let mapService;

        const monthAbbr = [
            "JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"
        ];

        // DOM elements
        const firstModal = document.getElementById('firstModal');
        const secondModal = document.getElementById('secondModal');
        const cabNoShowButton = document.getElementById('cabNoShowButton');
        const aTag = document.getElementById('aTag');
        const chatButton = document.getElementById('chatButton');
        const shareButton = document.getElementById('shareButton');
        const callButton = document.getElementById('callButton');
        const helpButton = document.getElementById('helpButton');
        const selfNoShowButton = document.getElementById('selfNoShowButton');
        const qrCodeButton = document.getElementById('qrCodeButton');
        const selfNoShow = document.getElementById('selfNoShow');
        const carouselIndicators = document.getElementById('carousel-indicators');
        const carouselItem1 = document.getElementById('carousel-item1');
        const escortId = document.getElementById('escortId');
        const guardName = document.getElementById('guardName');
        const tdName = document.getElementById('tdName');
        const tdName1 = document.getElementById('tdName1');
        const tdRegistrationNo = document.getElementById('tdRegistrationNo');
        const tdRegistrationNo1 = document.getElementById('tdRegistrationNo1');
        const tdVehicleType = document.getElementById('tdVehicleType');
        const tdVehicleType1 = document.getElementById('tdVehicleType1');
        const imageDriver = document.getElementById('imageDriver');
        const imageDriver1 = document.getElementById('imageDriver1');
        const imageGuard = document.getElementById('imageGuard');
        const boardingStatus = document.getElementById('boardingStatus');
        const Otp = document.getElementById('Otp');
        const etaDiv = document.getElementById('etaDiv');
        const offCanvasBottom = document.getElementById('offCanvasBottom1');
        const chatBox = document.getElementById('chatBox');
        const callAction = document.getElementById('callAction');
        const callDriverConfirmationButton = document.getElementById('callDriverConfirmationButton');
        const popupLocationNotAccessible = document.getElementById('popupLocationNotAccessible');
        const popupNetworkConnection = document.getElementById('popupNetworkConnection');          
        const qrCodeModal = document.getElementById('qrCodeModal');

        // Initialize on DOM content loaded
        document.addEventListener('DOMContentLoaded', function(){
            getRouteDetailsFromQueryString();
            startRouteDetUpdates();
            loadMap(facility);
        });

        // Helper functions
        function ajaxRequest(url, data, callback, method, username, password) {
            const ajaxOptions = {
                type: method,
                url: url,
                cache: false,
                crossDomain: true,
                data: method === "GET" ? data : JSON.stringify(data),
                contentType: method === "GET" ? undefined : "application/json; charset=utf-8",
                dataType: "json",
                success: callback,
                failure: function (response) {
                    console.error("Failure:", response.d);
                },
                error: function (response) {
                    console.error("Error:", response.d);
                }
            };

            if (username && password) {
                ajaxOptions.username = username;
                ajaxOptions.password = password;
            }

            $.ajax(ajaxOptions);
        }

        function ajaxRequestPromise(url, data, method, username, password) {
            return new Promise((resolve, reject) => {
                ajaxRequest(url, data, resolve, method, username, password);
            });
        }

        function checkForAccenture(clientid, appwimc){
            if ((clientid == '4' || clientid == '14' || clientid == '13' || clientid == '15' || clientid == '10' || clientid == '25' || clientid == '26' || clientid == '22') && (appwimc == 0)) {
                $('#firstModal').modal('show');
                cabNoShowButton.style.display = 'block';
                chatButton.style.display = 'block';
                return;
            }
            
            firstModal.style.display = 'none';
            cabNoShowButton.style.display = 'block';
            chatButton.style.display = 'block';
            selfNoShowButton.style.display = 'block';
            return;
        }

        function getQueryStringValue(key) {
            return unescape(
                window.location.search.replace(
                    new RegExp(
                        "^(?:.*[&\\?]" +
                        escape(key).replace(/[\.\+\*]/g, "\\$&") +
                        "(?:\\=([^&]*))?)?.*$",
                        "i"
                    ),
                    "$1"
                )
            );
        }

        function getRouteDetailsFromQueryString(){
            value = getQueryStringValue("v");
            // console.log(console.log("value: ", value););
            value1 = getQueryStringValue("s");
            // console.log(console.log("value1: ", value1););
            vs = value.substring(4, value.length);
            
            clientid = parseInt(value.substring(0, 4));
            // console.log(console.log("clientid: ", clientid););

            const shuttleRoute = monthAbbr.find(month => vs.includes(month));
            if(shuttleRoute){
                // console.log(console.log(`Found month: ${shuttleRoute}`););
                routeid = vs.substring(0, vs.indexOf(shuttleRoute) + 5);
                empid = vs.substring(vs.indexOf(shuttleRoute) + 5, vs.length);    
                // console.log(console.log("routeid: ", routeid););
                // console.log(console.log("empid: ", empid););
            }
            else{
                if (value.length == 25) {
                    empid = (value.slice(value.length - 8, value.length));
                    routeid = vs.substring(0, vs.length - 8);
                    // console.log(console.log("empid: ", empid););
                    // console.log(console.log("routeid: ", routeid););
                }
                else if (value.length == 24) {
                    empid = (value.slice(value.length - 7, value.length));
                    routeid = vs.substring(0, vs.length - 7);
                    // console.log(console.log(empid););
                    // console.log(console.log(routeid););
                }
                else if (value.length == 23 || value.length == 21) {
                    empid = (value.slice(value.length - 6, value.length));
                    routeid = vs.substring(0, vs.length - 6);
                    // console.log(console.log(empid););
                    // console.log(console.log(routeid););
                }
                else if (value.length == 22 || value.length == 20) {
                    empid = (value.slice(value.length - 5, value.length));
                    routeid = vs.substring(0, vs.length - 5);
                    // console.log(console.log(empid););
                    // console.log(console.log(routeid););
                }
                else if (value.length == 19) {
                    empid = (value.slice(value.length - 4, value.length));
                    routeid = vs.substring(0, vs.length - 4);
                    // console.log(console.log(empid););
                    // console.log(console.log(routeid););
                }
            }

            var murl = myUrl.split("&");
            var appwimc = 0;
            var surl;
            if (murl[1] == 'app=1') {
                appwimc = 1;
                surl = murl[2];
            }
            else if (murl[2] == 'app=1') {
                appwimc = 1;
                surl = murl[1];
            }
            else {
                surl = murl[1];
                appwimc = 0;
            }

            // console.log(console.log("empid: ", empid););

            checkForAccenture(clientid, appwimc);
            fetchGetClientDetailsById(value, value1, clientid);
        }

        function arePointsNear(checkPoint, centerPoint, km) {
            var ky = 40000 / 360;
            var kx = Math.cos((Math.PI * centerPoint.lat) / 180.0) * ky;
            var dx = Math.abs(centerPoint.lng - checkPoint.lng) * kx;
            var dy = Math.abs(centerPoint.lat - checkPoint.lat) * ky;
            return Math.sqrt(dx * dx + dy * dy) <= km;
        }

        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(showPosition, showError);
            } else {
                alert("Geolocation is not supported by this browser.");
            }
        }

        function showError(error) {
            switch (error.code) {
                case error.PERMISSION_DENIED:
                    alert("User denied the request for Geolocation.");
                    break;
                case error.POSITION_UNAVAILABLE:
                    alert("Location information is unavailable.");
                    break;
                case error.TIMEOUT:
                    alert("The request to get user location timed out.");
                    break;
                case error.UNKNOWN_ERROR:
                    alert("An unknown error occurred.");
                    break;
            }
        }

        async function showPosition(position) {
            var homelatlng = { lat: position.coords.latitude, lng: position.coords.longitude };
            var n = arePointsNear(homelatlng, emplatlng1, cabnoshowradius);
            if (n == true) {
                var confirmArrived = confirm('Do you want to mark the cab as no-show?');
                if (confirmArrived == true) {
                    const response = await ajaxRequestPromise(URL_UpdateCabNoShow, {"routeid": routeid, "empid": empid, "trackingaction": employeeid, "lat": '0', "lng": '0'}, "POST", null, null);
                    const details  = JSON.parse(response.d);
                    if(details != null){
                        // console.log(console.log("cabNoShowData: ", details););
                        alert('Thank you for the NO Show alert, we will notify the driver immediately.');
                        cabNoShowButton.style.display = 'none';
                    }  
                }
                else {
                    // console.log(console.log('cab no show cancelled'));
                }
            }
            else {
                alert('Current location does not match pick-up location. Reach pick-up point to confirm Cab as No show. ');
            }
        }

        cabNoShowButton.addEventListener("click", function(event){
            event.preventDefault();
            getLocation();
        });

        // QR Code functionality
        document.getElementById("qrCodeButton").addEventListener("click", function () {
            var qrModal = new bootstrap.Modal(document.getElementById("qrCodeModal"));
            qrModal.show();
            startQRScanner();
        });

        function startQRScanner() {
            const qrCodeScanner = new Html5Qrcode("qr-reader");

            qrCodeScanner.start(
                { facingMode: "environment" },
                {
                    fps: 10,
                    qrbox: { width: 250, height: 250 }
                },
                (decodedText, decodedResult) => {
                    // console.log(console.log("Scanned Code:", decodedText););
                    alert("QR Code Scanned: " + decodedText);
                    // Close modal after successful scan
                    var modal = bootstrap.Modal.getInstance(document.getElementById("qrCodeModal"));
                    modal.hide();
                },
                (errorMessage) => {
                    console.warn("QR Code scan error:", errorMessage);
                }
            ).catch((err) => {
                console.error("Failed to start QR scanner:", err);
            });

            // Stop scanner when modal is closed
            document.getElementById("qrCodeModal").addEventListener("hidden.bs.modal", function () {
                qrCodeScanner.stop().catch((err) => console.error("Error stopping scanner:", err));
            });
        }
        function share() {
            var isMobile = {
                Android: function () {
                    return navigator.userAgent.match(/Android/i);
                },
                BlackBerry: function () {
                    return navigator.userAgent.match(/BlackBerry/i);
                },
                iOS: function () {
                    return navigator.userAgent.match(/iPhone|iPad|iPod/i);
                },
                Opera: function () {
                    return navigator.userAgent.match(/Opera Mini/i);
                },
                Windows: function () {
                    return navigator.userAgent.match(/IEMobile/i);
                },
                any: function () {
                    return (
                        isMobile.Android() ||
                        isMobile.BlackBerry() ||
                        isMobile.iOS() ||
                        isMobile.Opera() ||
                        isMobile.Windows()
                    );
                }
            };

            if (isMobile.any()) {
                var url;
                if (gender == 'M') {
                    url = (empname != null && empname != undefined && empname != "") ? empname : "user" + " wants you to view his trip details. Kindly click on the link below : \n" + myUrl + "&s=s";
                }
                else if (gender == 'F') {
                    url = (empname != null && empname != undefined && empname != "") ? empname : "user" + " wants you to view her trip details. Kindly click on the link below : \n" + myUrl + "&s=s";
                }
                else {
                    url = (empname != null && empname != undefined && empname != "") ? empname : "user" + " wants you to view their trip details. Kindly click on the link below : \n" + myUrl + "&s=s";
                }
                var message = encodeURIComponent(url);
                var whatsapp_url = "whatsapp://send?text=" + message;
                window.location.href = whatsapp_url;
            } else {
                alert("Please share this article in mobile device");
            }
        }

        function share1() {
            var getOS = function () {
                var userAgent = navigator.userAgent || navigator.vendor || window.opera;
                if (
                    userAgent.match(/iPad/i) ||
                    userAgent.match(/iPhone/i) ||
                    userAgent.match(/iPod/i)
                ) {
                    return "iOS";
                } else if (userAgent.match(/Android/i)) {
                    return "Android";
                } else {
                    return "unknown";
                }
            }

            var device = getOS();
            var url;

            if (gender == 'M') {
                url = (empname != null && empname != undefined && empname != "") ? empname : "user" + " wants you to view his trip details. Kindly click on the link below : \n" + myUrl + "&s=s";
            }
            else if (gender == 'F') {
                url = (empname != null && empname != undefined && empname != "") ? empname : "user" + " wants you to view her trip details. Kindly click on the link below : \n" + myUrl + "&s=s";
            }
            else {
                url = (empname != null && empname != undefined && empname != "") ? empname : "user" + " wants you to view their trip details. Kindly click on the link below : \n" + myUrl + "&s=s";
            }

            var message = encodeURIComponent(url);
            // console.log(console.log("message ", message););
            
            if (device == "iOS") {
                window.location.href = "sms: &body=" + message;
            }
            if (device == "Android") {
                window.location.href = "sms:?body=" + message;
            }
        }

        function secondsToHms(d) {
            d = Number(d);
            var h = Math.floor(d / 3600);
            var m = Math.floor(d % 3600 / 60);
            var s = Math.floor(d % 3600 % 60);

            var hDisplay = "", mDisplay = "", sDisplay = "";
            if (h > 0) {
                if (h == 1) {
                    hDisplay = h + " hr ";
                }
                else {
                    hDisplay = h + " hrs ";
                }
            }
            if (m > 0) {
                if (m == 1) {
                    mDisplay = m + " min ";
                } else {
                    mDisplay = m + " mins ";
                }
            }
            if (s > 0) {
                sDisplay = s + "s";
            }
            if (!(h > 0) && !(m > 0) && s > 0) {
                return "Soon";
            }

            return hDisplay + mDisplay;
        }
        
        async function fetchGetClientDetailsById(value, value1, clientid){
            if(value || value1){
                const response = await ajaxRequestPromise("https://www.etmsdrive.in/appControlRest/api/v1/getClientDetailById", {CID: clientid}, "GET", "user1", "Acc@bang10");
                const details = JSON.parse(response);
                // console.log(console.log("GetClientDetailByIdData: ", details););
                createUrlFromClientDetails(details[0]);
            }
        }

        function createUrlFromClientDetails(data){
            BASE_URL = data.trackurl;
            URL_CabValidation = BASE_URL + "MyCabValidation";
            URL_ProfilePicture = data.photourl;
            URL_CallingApi = BASE_URL + "CallingAPI";
            URL_RouteInfo = BASE_URL + "GetRouteInfoMyCab";
            // console.log(console.log("URL_RouteInfo: ", URL_RouteInfo););
            URL_RouteDetail = BASE_URL + "GetRouteDetail";
            URL_RouteDetailShuttle = BASE_URL + "GetRouteDetailShuttle";
            URL_GetGpsLogger = BASE_URL + "GetGPSLogger";
            URL_UpdateCabNoShow = BASE_URL + 'UpdateCabNoShow';
            URL_UpdateTrackingSelf = BASE_URL + 'UpdateTrackingSelf';

            fetchRouteInfoData();
        }

        async function fetchRouteInfoData(){
            const response = await ajaxRequestPromise(URL_RouteInfo, {RouteId: routeid}, "POST", "user1", "Acc@bang10");
            const details = JSON.parse(response);
            // console.log(console.log("fetchRouteInfoData: ", details););
            displayDetails(details[0]);
        }

        async function displayDetails(data){
            if(data.routeID != 'NA'){
                facility = data.facility;
                // console.log(console.log("facility: " + facility););

                if(data.chatonlyforpwd == '0'){
                    chatButton.style.display = 'block';
                }
                else if(data.chatonlyforpwd == '1'){
                    if(data.is_pwd == '1'){
                        chatButton.style.display = 'block';
                    }
                    else{
                        chatButton.style.display = 'none';
                    }
                }
                else{
                    chatButton.style.display = 'none';
                }

                if(data.isshuttle == 1){
                    isShuttle = true;
                    selfNoShowButton.style.display = 'none';
                    cabNoShowButton.style.display = 'none';
                    callButton.style.display = 'none';
                    etaDiv.style.display = 'none';
                    qrCodeButton.style.display = 'none';
                }
            }

            cabnoshowradius = data.cabnoshowradius / 1000;
            driver_contact.push(data.driverContact);
            driver_contact1 = data.driverContact;
            var profileUrl = URL_ProfilePicture + data.driverContact + ".jpeg";
            var guardImage = data.guardphotourl;

            var p = data.vehicleRegNo;
            if (data.isb2b == "1") {
                b2bFlag = "3";
            } else {
                b2bFlag = "1";
            }
            
            if (data.guardid == '' || data.guardid == null) {
                // console.log(console.log('no guard'););
                carouselIndicators.style.display = 'none';
                carouselItem1.style.display = 'none';
                const carouselExampleIndicators = document.getElementById('carouselExampleIndicators');
                carouselExampleIndicators.setAttribute('data-bs-touch', "false");
            }
            else {
                // console.log(console.log('guard'););
            }

            driverName = data.driverName;
            vehicleRegNo.push(p);
            vehicleType = data.vehicleType;
            tptContactNo = data.tptContactNo;
            // console.log(console.log("tptContactNo: ", tptContactNo););
            aTag.setAttribute('data-rel', 'external');
            aTag.setAttribute('href', 'tel:' + tptContactNo);

            guardName.innerText = data.guardname;
            escortId.innerText = data.guardid;

            tdName.innerText = driverName;
            tdName1.innerText = driverName;
            tdRegistrationNo.innerText = vehicleRegNo;
            tdRegistrationNo1.innerText = vehicleRegNo;
            tdVehicleType.innerText = vehicleType;
            tdVehicleType1.innerText = vehicleType;

            document.getElementById("imageDriver").src = profileUrl;
            document.getElementById("imageDriver1").src = profileUrl;
            document.getElementById('imageGuard').src = guardImage;
            
            fetchRouteDetailData();
        }

        async function fetchRouteDetailData(){
            var response;
            // console.log(console.log("isShuttle: ", isShuttle););
            if(isShuttle){
               response = await ajaxRequestPromise(URL_RouteDetailShuttle, {RouteId: routeid, flag: b2bFlag}, "POST", "user1", "Acc@bang10");     
            }
            else{
                response = await ajaxRequestPromise(URL_RouteDetail, {RouteId: routeid, flag: b2bFlag}, "POST", "user1", "Acc@bang10");
            }
            
            const details = JSON.parse(response);
            const details1 = details;
            // console.log(console.log("fetchRouteDetailData: ", details););
                                
            const filteredData = details.filter(item => (item.id == empid));
            // console.log(console.log("filteredData: ", filteredData););
                                
            displayDetails1(filteredData[0], details1);
        }

        function displayDetails1(data, details){
            // --- SHUTTLE ROUTE HANDLING ---
            if (isShuttle && Array.isArray(details)) {
                cabNoShowButton.style.display = 'none';
                chatButton.style.display = 'none';
                selfNoShowButton.style.display = 'none';
                etaDiv.style.display = 'none';
                Otp.style.display = 'none';
                if (value1 == 's') {
                    callButton.style.display = 'none';
                    callAction.style.display = 'none';
                } else {
                    callButton.style.display = 'block';
                    callAction.style.display = 'block';
                }
                // Plot the shuttle route
                if (mapService) {
                    const waypoints = details
                        .filter(item => item.lat && item.lng)
                        .map(item => [parseFloat(item.lat), parseFloat(item.lng)]);
                    if (waypoints.length > 1) {
                        if (mapService.routePolyline) {
                            mapService.map.removeLayer(mapService.routePolyline);
                        }
                        mapService.routePolyline = L.polyline(waypoints, {
                            color: '#4285F4',
                            weight: 4,
                            opacity: 0.8,
                        }).addTo(mapService.map);
                        mapService.map.fitBounds(mapService.routePolyline.getBounds(), { padding: [20, 20] });
                        mapService.addCarMarker(waypoints[0][0], waypoints[0][1], true);
                    }
                }
                fetchGpsLoggerData(details);
                return; // Do not process further for shuttle
            }
            // --- TRIP ENDED CHECK ---
            if (data.actVehicleEndTime && data.actVehicleEndTime !== "Date(0)" && data.actVehicleEndTime !== null) {
                tripEnded = true;
                // Show "Trip Ended" in the UI
                boardingStatus.innerHTML = `<h3><strong>TRIP ENDED</strong></h3>`;
                boardingStatus.style.display = 'inline-block';
                Otp.style.display = 'none';
                // Hide/disable other UI elements as needed
                callButton.style.display = 'none';
                helpButton.style.display = 'none';
                selfNoShowButton.style.display = 'none';
                chatButton.style.display = 'none';
                etaDiv.style.display = 'none';
                chatBox.style.display = 'none';
                cabNoShowButton.style.display = 'none';
                callAction.style.display = 'none';
                // Stop all intervals
                if (typeof locupdate !== 'undefined') clearInterval(locupdate);
                if (typeof showMapUpdate !== 'undefined') clearInterval(showMapUpdate);
                // Optionally, clear map markers
                if (mapService) {
                    mapService.clearRoute();
                    if (typeof currentEmployeeHomeMarker !== 'undefined' && currentEmployeeHomeMarker) {
                        mapService.map.removeLayer(currentEmployeeHomeMarker);
                        currentEmployeeHomeMarker = null;
                    }
                    if (mapService.carMarker) {
                        mapService.map.removeLayer(mapService.carMarker);
                        mapService.carMarker = null;
                    }
                }
                if (typeof employeeEtaInterval !== 'undefined') clearInterval(employeeEtaInterval);
                return; // Exit early, don't process further
            }
            else{
                // console.log(console.log('::::::::::>' + data.trackingStatus););
                // console.log(console.log(data.id););
                // console.log(console.log(data.tripType););
                // console.log(console.log(data.empName););
                // console.log(console.log(data.lat););
                // console.log(console.log(data.lng););
            }

            if(data.id == empid){
                gender = data.Gender;
                exoPhone = data.exophone;
                // console.log(console.log(gender););
                employeeid = data.employeeID;
                tripType = data.tripType;

                if ((data.CabNoShow == 0) && (clientid == '10' || clientid == '14' || clientid == '15' || clientid == '22')) {
                    cabNoShowButton.style.display = 'block';
                }
                else {
                    cabNoShowButton.style.display = 'none';
                }

                if (data.tripType == 'D') {
                    cabNoShowButton.style.display = 'none';
                    chatButton.style.display = 'none';
                }

                if (clientid == '10' || clientid == '14' || clientid == '15' || clientid == '22' || clientid == '25') {
                    shareButton.style.display = 'block';
                }
                else {
                    shareButton.style.display = 'none';
                }

                empname = data.empName;
                emp_contact = data.EmpMobile;
                // console.log(console.log(emp_contact););

                emplatlng1 = { lat: data.lat, lng: data.lng };
                // console.log(console.log(emplatlng1););

                myTrackingStatus = data.trackingStatus;
                if ((myTrackingStatus == "Boarded" || tripType == 'D') || (myTrackingStatus == "No-Show" || tripType == 'D')) {
                    routeDetFrequency = 10000000;
                }
                
                if (myTrackingStatus != '----') {
                    boardingStatus.innerHTML = `<h3><strong>${myTrackingStatus.toUpperCase()}</strong></h3>`;
                    boardingStatus.style.display = 'inline-block';
                }
                else {
                    boardingStatus.style.display = 'none';
                    OTP = data.boardingOTP;
                    // console.log(console.log(OTP););
                    if (OTP != null) {
                        Otp.innerHTML = `<h3><strong>OTP: ${OTP} </strong></h3>`;
                        Otp.style.display = 'inline-block';
                    }
                }

                if (myTrackingStatus == "No-Show" || data.tripType == 'D') {
                    callButton.style.display = 'none';
                    helpButton.style.display = 'block';
                    selfNoShowButton.style.display = 'none';
                    chatButton.style.display = 'none';
                    etaDiv.style.display = 'none';
                    Otp.style.display = 'none';
                    chatBox.style.display = 'none';
                    cabNoShowButton.style.display = 'none';
                } 
                else if (myTrackingStatus == "Boarded" || data.tripType == 'D') {
                    callButton.style.display = 'none';
                    helpButton.style.display = 'block';
                    selfNoShowButton.style.display = 'none';
                    chatButton.style.display = 'none';
                    etaDiv.style.display = 'none';
                    Otp.style.display = 'none';
                    chatBox.style.display = 'none';
                    cabNoShowButton.style.display = 'none';
                }
                else if (myTrackingStatus == "De-Boarded" || data.tripType == 'D') {
                    callButton.style.display = 'none';
                    helpButton.style.display = 'block';
                    selfNoShowButton.style.display = 'none';
                    chatButton.style.display = 'none';
                    etaDiv.style.display = 'none';
                    Otp.style.display = 'none';
                    offCanvasBottom.style.display = 'none';
                    chatBox.style.display = 'none';
                    cabNoShowButton.style.display = 'none';
                }
                else if(clientid =='28' || clientid == '60'){
                    selfNoShowButton.style.display = 'none';
                    callButton.style.display = 'block';
                    helpButton.style.display = 'block';
                    etaDiv.style.display = 'none';
                    Otp.style.display = 'block';
                }
                else {
                    callButton.style.display = 'block';
                    helpButton.style.display = 'block';
                    etaDiv.style.display = 'none';
                    Otp.style.display = 'block';
                }

                callAction.style.display = 'block';

                if (value1 == 's') {
                    callButton.style.display = 'none';
                    helpButton.style.display = 'block';
                    selfNoShowButton.style.display = 'none';
                    chatButton.style.display = 'none';
                    etaDiv.style.display = 'none';
                    Otp.style.display = 'none';
                    chatBox.style.display = 'none';
                    cabNoShowButton.style.display = 'none';
                    callAction.style.display = 'none';
                }
                
                callDriverConfirmationButton.addEventListener('click', function(event){
                    event.preventDefault();
                    callLatch();
                });

                function callLatch() {
                    callApi();
                }

                var lathome = data.lat;
                var lnghome = data.lng;
                
                toloc = data.lat + ',' + data.lng;
                // console.log(console.log("toloc: ", toloc););

                // Add employee marker to map
                if(toloc != null && mapService){
                    mapService.addEmployeeMarker(data.lat, data.lng);
                }
                        
                fetchGpsLoggerData(details);
            }
        }

        async function callApi(){
            try {
                const response = await ajaxRequestPromise(URL_CallingApi, {empid: empid, drivermobile: driver_contact[0], type: "sun"}, "POST", null, null);
                // console.log(console.log("API call successful: ", response););
                updateModal("Please wait while your call is being connected", 'success');
            } catch(error) {
                // console.log(console.log("API call failed: ", error););
                updateModal("The call cannot be connected as an error was encountered", 'danger');
            }
        }

        // 🔧 CORRECTED Data Handling
        // 🔧 FINAL CORRECTED Data Handling (Direct JSON String)
        // 🔧 REVISED fetchGpsLoggerData: Corrected variable name in catch block
async function fetchGpsLoggerData(data){
    try {
        const rawResponse = await ajaxRequestPromise(URL_GetGpsLogger, {deviceId: routeid, vendorid: 0}, "POST", "user1", "Acc@bang10");
        
        const details = JSON.parse(rawResponse); 

        if (details && details.length > 0 && details[0].lat && details[0].lng) {
            // console.log(console.log("Successfully parsed GPS data:", details););
            displayDetails2(details[0], data);
        } else {
            console.warn("GPS data received, but it's empty or invalid after parsing.", details);
            popupLocationNotAccessible.style.display = 'block';
        }

    } catch(error) {
        console.error("Error fetching or parsing GPS data:", error);
        // 🔧 FIX: Use the correct variable name defined in your HTML
        if (popupNetworkConnection) { // Check if the element exists before trying to access its style
            popupNetworkConnection.style.display = 'block'; 
        } else {
            console.error("Error: popupNetworkConnection element not found in DOM.");
        }
    }
}

function displayDetails2(data, details){
            // console.log(console.log("lat: ", data.lat););
            // console.log(console.log("lng: ", data.lng););
            
            var lat = data.lat;
            var lng = data.lng;
            
            if (lat == null || lat == undefined || lat === 0 || lng == null || lng == undefined || lng === 0) {
                popupLocationNotAccessible.style.display = 'block';
                return;
            } else {
                popupLocationNotAccessible.style.display = 'none';
            }

            driverlat = data.lat;
            driverlng = data.lng;
            position = [driverlat, driverlng];
            fromloc = [lat, lng];
            
            // console.log(console.log("fromloc: ", fromloc););

            // Initialize map service and add car marker
            if (mapService) {
                mapService.addCarMarker(lat, lng, isShuttle);
                mapService.centerMap(lat, lng);
            }
        }

        // 🔧 Updated map loading functions
        async function loadMap(facility) {
            return await loadOpenSourceMap();
        }

        async function loadOpenSourceMap() {
            try {
                mapService = new OpenSourceMapService();
                mapService.initializeMap('map');
                // console.log(console.log('Open source map loaded successfully'););
                return mapService;
            } catch (error) {
                console.error('Failed to load map:', error);
                throw error;
            }
        }

        // 🔧 Updated marker movement function
        async function moveMarker1() {
            if (tripEnded) return; // Prevent further execution if trip is ended
            try {
                const response = await ajaxRequestPromise(URL_GetGpsLogger, {deviceId: routeid, vendorid: 0}, "POST", "user1", "Acc@bang10");
                const details = JSON.parse(response);
                // console.log(console.log("moveMarkerData: ", details););
                
                if (details[0] && details[0].lat && details[0].lng) {
                    const newLat = details[0].lat;
                    const newLng = details[0].lng;
                    
                    // Update car position with smooth animation
                    if (mapService && mapService.carMarker) {
                        mapService.updateCarPosition(newLat, newLng, true);
                    }
                    
                    // Update stored position
                    position = [newLat, newLng];
                    newPosition = [newLat, newLng];
                }
            } catch (error) {
                console.error('Error updating marker position:', error);
            }
        }

// Global variable to hold the employee's specific marker, if needed
// This might be redundant if addRouteMarkers handles it cleanly
let currentEmployeeHomeMarker = null;

// Ensure `routeDetFrequency` is set to a constant, regular interval globally
// e.g., var routeDetFrequency = 60000; // 1 minute, or 30000 for 30 seconds

async function calculateEtaAndPlotPath() {
    // console.log(console.log("Fetching route details for status update and map plotting..."););

    try {
        const response = await ajaxRequestPromise(URL_RouteDetail, { RouteId: routeid, flag: b2bFlag }, "POST", "user1", "Acc@bang10");
        const parsedData = JSON.parse(response);
        // console.log(console.log("calculateEtaAndPlotPathData: ", parsedData););
        employeeData = parsedData; // Store the employee data globally

        // Find the current employee's details
        const currentEmployee = parsedData.find(item => item.id == empid);

        if (!currentEmployee || !currentEmployee.lat || !currentEmployee.lng) {
            console.warn("Current employee details not found or invalid coordinates.");
            // Even if details are missing, call displayDetails1 with a default or last known state
            // to ensure UI cleanup if needed. For now, we'll just return.
            return;
        }

        // --- THE CRITICAL CHANGE: ALWAYS CALL displayDetails1 HERE ---
        // This ensures that the UI (OTP, Boarded status, and all buttons)
        // is updated with the latest `trackingStatus` from the server.
        displayDetails1(currentEmployee, parsedData);

        // --- Now, apply the conditions for stopping map/ETA updates ---
        // If the current user's trip segment is "Boarded", "No-Show", "De-Boarded", or a "Drop" trip,
        // then we don't need to show map tracking or ETA for them anymore.
        if (currentEmployee.trackingStatus === 'Boarded' ||
            currentEmployee.trackingStatus === 'No-Show' ||
            currentEmployee.trackingStatus === 'De-Boarded' || // Added De-Boarded for completeness
            currentEmployee.tripType === 'D') {
            
            // console.log(console.log(`Trip for employee ${empid} is completed (${currentEmployee.trackingStatus}));. Hiding ETA and clearing map.`);
            document.getElementById('etaDiv').style.display = 'none'; // Hide ETA
            
            // Clear map elements if the trip is complete for this user
            if (mapService) {
                // mapService.clearRoute(); // Clears polylines and general employee markers
                if (currentEmployeeHomeMarker) { // Explicitly remove the home marker too if it's there
                    mapService.map.removeLayer(currentEmployeeHomeMarker);
                    currentEmployeeHomeMarker = null;
                }
                if (mapService.carMarker) { // Remove the car marker itself
                    mapService.map.removeLayer(mapService.carMarker);
                    mapService.carMarker = null; // Clear reference
                }
            }
            return; // Exit here if no further map/ETA updates are needed
        }

        // --- Continue with Map Plotting and ETA Calculation (ONLY if trip is active) ---
        // console.log(console.log("Proceeding with map plotting and ETA calculation..."););

        // Clear existing route and employee markers from the map before plotting new ones
        if (mapService) {
            mapService.clearRoute(); // This will clear previous route and employee markers
        }

        // --- Plot the Current Employee's Home Icon ---
        // We will add it directly here, not relying on mapService.addRouteMarkers
        // to avoid other numbered markers appearing.
        // console.log(console.log("Current Employee's Home Location:", currentEmployee.lat, currentEmployee.lng););
        if (mapService && currentEmployee.lat && currentEmployee.lng) {
            const homeIcon = L.icon({
                iconUrl: 'images/home.png', // Always use the home icon for the current user
                iconSize: [25, 25],
                iconAnchor: [12, 12],
            });
            // Ensure you remove the old one if it exists to prevent duplicates on redraw
            if (currentEmployeeHomeMarker) {
                mapService.map.removeLayer(currentEmployeeHomeMarker);
            }
            currentEmployeeHomeMarker = L.marker([currentEmployee.lat, currentEmployee.lng], { icon: homeIcon }).addTo(mapService.map);
        }

        // --- Determine the route waypoints from cab to current employee's stop ---
        let routeWaypoints = [];
        let destinationLatLng = [currentEmployee.lat, currentEmployee.lng];

        // Filter for stops *before or at* the current employee's stop, including only unboarded ones
        // This ensures the route only shows progression towards *this* employee
        const relevantStops = parsedData
            .filter(item =>
                item.trackingStatus === "----" && // Only unboarded stops
                item.stopNo <= currentEmployee.stopNo // Stops on or before current employee's stop number
            )
            .sort((a, b) => a.stopNo - b.stopNo); // Ensure stops are in correct sequence

        // Construct the waypoints for the polyline.
        // The first point will be the cab's current position (newPosition).
        // Then, intermediate points will be all relevant stops *before* the current employee's stop.
        // The final point will be the current employee's stop.
        if (newPosition) { // `newPosition` comes from `moveMarker1` (GPSLogger)
            // Add intermediate stops between cab and current employee (if any)
            // Filter out the current employee's own stop from intermediate waypoints
            // as it will be the 'end' point.
            const intermediatePoints = relevantStops
                .filter(item => item.id !== empid)
                .map(item => [item.lat, item.lng]);

            // Create the route on the map
            // Note: The createSimpleRoute will handle adding the car marker
            // and connecting the points for the polyline.
            mapService.createSimpleRoute(
                newPosition,          // Start point: Cab's current location
                intermediatePoints,   // Intermediate points: Other unboarded stops on the way
                destinationLatLng     // End point: Current employee's home location
            );

            // console.log(console.log('Route created from cab to employee:', newPosition, intermediatePoints, destinationLatLng););

            // --- Calculate and display ETA ---
            // Recalculate ETA only considering the path from cab to current employee
            await calculateEtaOpenSource(relevantStops, currentEmployee);

        } else {
            console.warn("Cab's current position (newPosition) not available.");
            // Optionally hide ETA if cab position isn't known
            document.getElementById('etaDiv').style.display = 'none';
        }

    } catch (error) {
        console.error('Error calculating ETA and plotting path:', error);
        // Display network connection popup if there's a fetch error
        if (popupNetworkConnection) {
            popupNetworkConnection.style.display = 'block';
        }
    }
}

// Add at the top of your global variables
var tripEnded = false;
var employeeEtaInterval;

// Replace the setInterval for updateEmployeeETAs with:
employeeEtaInterval = setInterval(async () => {
    if (!driverlat || !driverlng || !mapService || tripEnded) return;
    await mapService.updateEmployeeETAs(driverlat, driverlng, employeeData);
}, 10000); // every 10 seconds


// You will also need to adjust calculateEtaOpenSource slightly
// to work with the 'relevantStops' parameter you pass it.

async function calculateEtaOpenSource(stopsOnRoute, currentEmployee) {
    if (!stopsOnRoute.length || !newPosition || !currentEmployee) return;

    try {
        let totalDistance = 0;
        let currentPathPoint = newPosition; // Start from cab's current location

        // Calculate distance to each stop in order, until the current employee's stop
        // 'stopsOnRoute' is already filtered and sorted
        for (let i = 0; i < stopsOnRoute.length; i++) {
            const stop = stopsOnRoute[i];
            const nextPoint = [stop.lat, stop.lng];
            const distanceSegment = mapService.calculateDistance(currentPathPoint, nextPoint);
            totalDistance += distanceSegment;
            currentPathPoint = nextPoint; // Move to the next stop for the next segment calculation

            // If we've reached the current employee's stop, break
            if (stop.id === currentEmployee.id) {
                break;
            }
        }

        // Assume average speed of 25 km/h in city traffic
        const etaMinutes = (totalDistance / 25) * 60;
        const etaText = secondsToHms(etaMinutes * 60);

        if (etaText && etaText !== "Soon") {
            document.getElementById('eta').innerHTML = '<small>Reaching in<br></small>' + etaText;
            document.getElementById('etaDiv').style.display = 'block';
        } else {
            document.getElementById('eta').innerHTML = '<small>Reaching<br></small>Soon';
            document.getElementById('etaDiv').style.display = 'block';
        }

    } catch (error) {
        console.error('ETA calculation error:', error);
    }
}

        // Interval management
        document.addEventListener("visibilitychange", () => {
            if(document.hidden){
                clearInterval(locupdate);
                clearInterval(showMapUpdate);
                // console.log(console.log('Intervals stopped'););
            }
            else{
                if (tripEnded) return;
                startRouteDetUpdates();
            }
        });

        function startRouteDetUpdates() {
            if (tripEnded) return;
            setTimeout(function() {
                calculateEtaAndPlotPath();
                locupdate = setInterval(calculateEtaAndPlotPath, routeDetFrequency);
                showMapUpdate = setInterval(moveMarker1, 5000);
            }, 3000);
        }

        // Self no-show functionality
        function selfNoShowEvent(){
            // console.log(console.log("self no show clicked"););
            if(myTrackingStatus != '----'){
                updateModal(`You cannot mark yourself as No-Show for this trip as you are already marked as ${myTrackingStatus} for this trip.`, 'danger');
            }
            else{
                if(tripType != 'D'){
                    $.ajax({
                        type: 'POST',
                        cache: false,
                        url: URL_UpdateTrackingSelf,
                        data: JSON.stringify({
                            routeid: routeid,
                            empid: empid,
                            trackingaction: 'N',
                            actionby: '0',
                            distance: employeeid
                        }),
                        crossDomain: true,
                        contentType: 'application/json; charset=utf-8',
                        dataType: 'json'
                    })
                    .done(function (data) {
                        updateModal("You have marked yourself as No-Show.", 'success');
                    })
                    .fail(function (e) {
                        updateModal(`Error: ${e.statusText}`, 'danger');
                    });
                }
            }
        }

        selfNoShow.addEventListener('click', function(event){
            event.preventDefault();
            selfNoShowEvent();
        });

        // Modal functions
        function updateModal(message, alertType) {
            const modal = document.getElementById('alertModal');
            const modalMessage = document.getElementById('modalMessage');

            modal.className = 'modal fade';

            switch (alertType) {
                case 'success':
                    modal.classList.add('modal-success');
                    break;
                case 'danger':
                    modal.classList.add('modal-danger');
                    break;
                case 'warning':
                    modal.classList.add('modal-warning');
                    break;
                case 'info':
                    modal.classList.add('modal-info');
                    break;
                default:
                    modal.classList.add('modal-info');
                    break;
            }

            modalMessage.textContent = message;
            const bootstrapModal = new bootstrap.Modal(modal);
            bootstrapModal.show();
        }

        function closeModal() {
            const modal = document.getElementById('alertModal');
            const bootstrapModal = bootstrap.Modal.getInstance(modal);
            if (bootstrapModal) {
                bootstrapModal.hide();
            }
        }

        function validateInput(inputElement) {
            var emojiRegex = /[\u{1F600}-\u{1F64F}\u{1F300}-\u{1F5FF}\u{1F680}-\u{1F6FF}\u{1F700}-\u{1F77F}\u{1F780}-\u{1F7FF}\u{1F800}-\u{1F8FF}\u{1F900}-\u{1F9FF}\u{1FA00}-\u{1FA6F}\u{2600}-\u{26FF}\u{2700}-\u{27BF}]/gu;

            if (emojiRegex.test(inputElement.value)) {
                alert('Emojis are not allowed in the input!');
                inputElement.value = inputElement.value.replace(emojiRegex, '');
            }
        }

        // Chat and Firebase initialization (keeping the original Firebase chat functionality)
        setTimeout(function () {
            // Chat scrollable tabs initialization
            const tabs = document.querySelectorAll(".scrollable-tabs-container a");
            const rightArrow = document.querySelector(".scrollable-tabs-container .right-arrow svg");
            const leftArrow = document.querySelector(".scrollable-tabs-container .left-arrow svg");
            const tabsList = document.querySelector(".scrollable-tabs-container ul");
            const leftArrowContainer = document.querySelector(".scrollable-tabs-container .left-arrow");
            const rightArrowContainer = document.querySelector(".scrollable-tabs-container .right-arrow");

            const removeAllActiveClasses = () => {
                tabs.forEach((tab) => {
                    tab.classList.remove("active");
                });
            };

            tabs.forEach((tab) => {
                tab.addEventListener("click", () => {
                    removeAllActiveClasses();
                    tab.classList.add("active");
                });
            });

            const manageIcons = () => {
                if (tabsList.scrollLeft >= 20) {
                    leftArrowContainer.classList.add("active");
                } else {
                    leftArrowContainer.classList.remove("active");
                }

                let maxScrollValue = tabsList.scrollWidth - tabsList.clientWidth - 20;

                if (tabsList.scrollLeft >= maxScrollValue) {
                    rightArrowContainer.classList.remove("active");
                } else {
                    rightArrowContainer.classList.add("active");
                }
            };

            rightArrow.addEventListener("click", () => {
                tabsList.scrollLeft += 200;
                manageIcons();
            });

            leftArrow.addEventListener("click", () => {
                tabsList.scrollLeft -= 200;
                manageIcons();
            });

            tabsList.addEventListener("scroll", manageIcons);

            let dragging = false;

            const drag = (e) => {
                if (!dragging) return;
                tabsList.classList.add("dragging");
                tabsList.scrollLeft -= e.movementX;
            };

            tabsList.addEventListener("mousedown", () => {
                dragging = true;
            });

            tabsList.addEventListener("mousemove", drag);

            document.addEventListener("mouseup", () => {
                dragging = false;
                tabsList.classList.remove("dragging");
            });

            // Load chat messages
            var messageElement1 = document.getElementById('chat-messages1');
            $.ajax({
                url: 'https://www.etmsdrive.in/appControlRest/api/v1/application/chat/22/0',
                method: 'GET',
                success: OnSuccess,
                error: onError
            });

            function OnSuccess(response) {
                const parsedData = JSON.parse(response);
                const messageInput = document.getElementById("message-input");
                const list = document.querySelector('#chat-messages1');
                
                for (let i = 0; i < parsedData.length; i++) {
                    const li = document.createElement('li');
                    const a = document.createElement('a');
                    a.href = "#";
                    a.textContent = parsedData[i].text;
                    li.addEventListener("click", function () {
                        const messageText = li.textContent;
                        if (messageText !== '') {
                            messageInput.value = messageText;
                        }
                    });
                    li.appendChild(a);
                    list.appendChild(li);
                }
            }

            function onError(xhr, status, error) {
                console.error('Error loading chat messages:', error);
            }

            // Firebase Chat Implementation
            const firebaseConfig = {
                apiKey: "AIzaSyA09UwnVN0gTIHXjZokBBBXCEGyWrZ9rBk",
                authDomain: "etmsdrive-89370.firebaseapp.com",
                databaseURL: "https://etmsdrive-89370.firebaseio.com/",
                projectId: "etmsdrive-89370",
                storageBucket: "etmsdrive-89370.appspot.com",
                messagingSenderId: "351746301370",
                appId: "1:351746301370:android:361973f28e3375bc"
            };

            let isNewMessage = false;
            var _routeId = routeid;
            var _driverNo = driver_contact1;
            var _empName = emp_contact;

            // console.log(console.log('Route ID:', _routeId););
            // console.log(console.log('Driver Number:', _driverNo););
            // console.log(console.log('Employee Number:', _empName););

            firebase.initializeApp(firebaseConfig);
            const database = firebase.database();

            if (firebase.messaging.isSupported()) {
                const messaging = firebase.messaging();

                if ("serviceWorker" in navigator) {
                    navigator.serviceWorker
                        .register("/firebase-messaging-sw.js")
                        .then((registration) => {
                            messaging.useServiceWorker(registration);
                        })
                        .catch((error) => {
                            console.error("Service Worker registration failed:", error);
                        });
                }

                messaging.requestPermission()
                    .then(() => {
                        return messaging.getToken();
                    })
                    .then(token => {
                        // console.log(console.log('FCM Token:', token););
                    }).catch((error) => {
                        // console.log(console.log('Error requesting permission:', error););
                    });

                messaging.onMessage(function (message) {
                    // console.log(console.log("onMessage event fired", message););
                });
            }

            const messageInput = document.getElementById('message-input');
            const sendButton = document.getElementById('send-button');
            const chatMessages = document.getElementById('chat-messages');

            const routeID = _routeId;
            const driverID = _driverNo;
            const currentUserID = _empName;
            var driverFCMToken;

            const messagesRef = database.ref(`chats/trips/${routeID}`);

            messagesRef.once("value")
                .then(function (snapshot) {
                    const tripData = snapshot.val();
                    if (tripData) {
                        driverFCMToken = tripData.driverFCMToken;
                        if (driverFCMToken && typeof driverFCMToken === 'string' && driverFCMToken.trim() !== '') {
                            // console.log(console.log("Driver's FCM Token:", driverFCMToken););
                        } else {
                            // console.log(console.log("Driver's FCM Token is not available or invalid."););
                        }
                    } else {
                        // console.log(console.log("Trip data not found."););
                    }
                })
                .catch(function (error) {
                    console.error("Error fetching trip data:", error);
                });

            messageInput.addEventListener('keyup', function (event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    sendMessage();
                }
            });

            sendButton.addEventListener('click', () => {
                sendMessage();
            });

            function sendMessage() {
                const messageText = messageInput.value.trim();
                if (messageText !== '') {
                    const newMessageRef = database.ref(`chats/trips/${routeID}/messages`).push();
                    newMessageRef.set({
                        sender: currentUserID,
                        receiver: driverID,
                        content: messageText,
                        is_read: false,
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    });
                    
                    const tokenReference = database.ref(`chats/trips/${routeID}`);
                    tokenReference.once("value").then(function(snapshot){
                        const tripData = snapshot.val();
                        if(tripData){
                            driverFCMToken = tripData.driverFCMToken;
                            if (driverFCMToken && typeof driverFCMToken === 'string' && driverFCMToken.trim() !== '') {
                                // console.log(console.log('FCM Token:', driverFCMToken););
                                sendPushNotification(driverFCMToken, messageText);
                                messageInput.value = '';
                            }
                        }
                    });
                }
            }

            database.ref(`chats/trips/${routeID}/messages`).on('child_added', snapshot => {
                const message = snapshot.val();

                if (message.receiver === currentUserID) {
                    // Handle incoming message
                }

                if (message.sender === currentUserID || message.receiver === currentUserID) {
                    // console.log(console.log("this_user_message", message););
                    const messageElement = document.createElement('div');
                    const messageContent = document.createElement('div');
                    const timestampElement = document.createElement('div');
                    messageContent.innerText = message.content;
                    const timestamp = new Date(message.timestamp);
                    const formattedTime = timestamp.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit', hour12: true });
                    timestampElement.classList.add('timestamp');
                    timestampElement.innerText = formattedTime;

                    messageElement.appendChild(messageContent);
                    messageElement.appendChild(timestampElement);

                    if (message.sender === currentUserID) {
                        messageElement.classList.add('chats', 'sender');
                    } else {
                        if (isNewMessage) {
                            showNotification('New Message', message.content);
                        }
                        isNewMessage = true;
                        messageElement.classList.add('chats', 'recevier');
                    }
                    messageElement.classList.add('animate__animated', 'animate__headShake');
                    chatMessages.appendChild(messageElement);
                }
            });

            function sendPushNotification(recipientFCMToken, message) {
                fetch('https://fcm.googleapis.com/fcm/send', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        Authorization: 'Bearer AAAAUeW2nbo:APA91bFykoDdjXFrBo4qoRh0SvR7twUvPet-onaHvy29OGV7eJR7uMSaw042aEtC0VAEZmlYUd9eeVNfFz4DuifRAiePprBKf2cE7pHIkF1DZdY5fHG7NDqOazTna5rlFkxUlXrOcEpgtSJPL27-l_QGLlmhutR_Hg',
                    },
                    body: JSON.stringify({
                        to: recipientFCMToken,
                        notification: {
                            title: 'New Message',
                            body: message,
                            click_action: 'your-action-url',
                        },
                    }),
                })
                .then(response => response.json())
                .then(data => {
                    // console.log(console.log('Push notification sent:', data););
                })
                .catch(error => {
                    console.error('Error sending push notification:', error);
                });
            }

            function showNotification(title, body) {
                if (!('Notification' in window)) {
                    // console.log(console.log('This browser does not support notifications.'););
                    return;
                }

                if (Notification.permission === 'granted') {
                    const notification = new Notification(title, { body });
                } else if (Notification.permission !== 'denied') {
                    Notification.requestPermission().then(permission => {
                        if (permission === 'granted') {
                            const notification = new Notification(title, { body });
                        }
                    });
                }
            }

        }, 3000);        
    </script>

    <!-- Accessibility: Announce cab location on map keyboard/tap for blind users -->
    <script>
    (function() {
        const mapDiv = document.getElementById('map');
        if (mapDiv) {
            mapDiv.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    announceCabLocation();
                }
            });
            mapDiv.addEventListener('click', function(e) {
                announceCabLocation();
            });
        }

        async function announceCabLocation() {
            // Use the latest cab coordinates
            const lat = window.driverlat;
            const lng = window.driverlng;
            if (!lat || !lng) {
                announce('Cab location is not available at the moment.');
                return;
            }
            const apiKey = "AIzaSyDKatXVfQNHCj7iNP95PhsOkO9vFmYI-bA";
            const url = `https://maps.googleapis.com/maps/api/geocode/json?latlng=${lat},${lng}&key=${apiKey}`;
            try {
                const response = await fetch(url);
                const data = await response.json();
                if (data.status === 'OK' && data.results.length > 0) {
                    const address = data.results[0].formatted_address;
                    announce('Current cab location: ' + address);
                } else {
                    announce('Unable to retrieve the cab address.');
                }
            } catch (err) {
                announce('Error fetching cab address.');
            }
        }

        function announce(message) {
            const liveRegion = document.getElementById('live-region');
            if (liveRegion) liveRegion.textContent = message;
            // Optional: Use speech synthesis for immediate feedback
            if ('speechSynthesis' in window) {
                const utter = new SpeechSynthesisUtterance(message);
                window.speechSynthesis.speak(utter);
            }
        }
    })();
    </script>

    <!-- Ensure all images have alt text and all buttons/inputs have accessible labels -->
    <script>
    (function() {
        // Add alt text to images if missing
        document.querySelectorAll('img').forEach(function(img) {
            if (!img.hasAttribute('alt') || img.getAttribute('alt') === '') {
                img.setAttribute('alt', 'Image');
            }
        });
        // Add aria-label to buttons if missing
        document.querySelectorAll('button').forEach(function(btn) {
            if (!btn.hasAttribute('aria-label') && btn.textContent.trim() === '') {
                btn.setAttribute('aria-label', 'Button');
            }
        });
        // Add aria-label to inputs if missing
        document.querySelectorAll('input').forEach(function(input) {
            if (!input.hasAttribute('aria-label') && !input.hasAttribute('placeholder')) {
                input.setAttribute('aria-label', 'Input field');
            }
        });
    })();
    </script>
</body>
</html>