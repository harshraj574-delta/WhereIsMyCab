 <!DOCTYPE html> 
 <head>
    <title>ETMS DRIVE- View Current Location</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-control" content="no-cache">
    <meta http-equiv="X-UA-Compatible" content="IE=EDGE">
    <script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

 <style>
 html,
 body,
 #map {
   margin: 0;
   padding: 0;
   width: 100%;
   height: 100%;
   
 }
 button {
-webkit-appearance: none;
-moz-appearance: none;
appearance: none;
}
 p{
 margin:0.1rem;
 font-family:Roboto,Arial,sans-serif;
 }
 
 #driverbox{

    left: 50%;
    transform: translate(-50%, 20%);
    width: 90%;
    z-index: 1023;
    position: absolute;
    top: 65%;
    height: 27%;
background-Color:#fff;box-shadow:0 2px 6px rgba(0,0,0,.3)
 
 }
  #recentre{

    width: 10%;
    z-index: 1023;
    position: absolute;
    top: 55%;
    height: 5%;
    right: 1%;
    background-Color: #2a445b;
    box-shadow: 0 2px 6px rgba(0,0,0,.3);
 
 }
 .tabs .tab a {
    color:blue !important;
	}
	
	
	#myImg {
  border-radius: 5px;
  cursor: pointer;
  transition: 0.3s;
}

#myImg:hover {opacity: 0.7;}

/* The Modal (background) */
.modal {
  display: none; /* Hidden by default */
  position: fixed; /* Stay in place */
  z-index: 1567; /* Sit on top */
  padding-top: 100px; /* Location of the box */
  left: 0;
  top: 0;
  width: 100%; /* Full width */
  height: 100%; /* Full height */
  overflow: auto; /* Enable scroll if needed */
  background-color: rgb(0,0,0); /* Fallback color */
  background-color: rgba(0,0,0,0.9); /* Black w/ opacity */
}

/* Modal Content (image) */
.modal-content {
  margin: auto;
  display: block;
  width: 80%;
  max-width: 700px;
}

/* Caption of Modal Image */
#caption {
  margin: auto;
  display: block;
  width: 80%;
  max-width: 700px;
  text-align: center;
  color: #ccc;
  padding: 10px 0;
  height: 150px;
}

/* Add Animation */
.modal-content, #caption {  
  -webkit-animation-name: zoom;
  -webkit-animation-duration: 0.6s;
  animation-name: zoom;
  animation-duration: 0.6s;
}

@-webkit-keyframes zoom {
  from {-webkit-transform:scale(0)} 
  to {-webkit-transform:scale(1)}
}

@keyframes zoom {
  from {transform:scale(0)} 
  to {transform:scale(1)}
}

/* The Close Button */
.close {
  position: absolute;
  top: 15px;
  right: 35px;
  color: #f1f1f1;
  font-size: 40px;
  font-weight: bold;
  transition: 0.3s;
  
}

.close:hover,
.close:focus {
  color: #bbb;
  text-decoration: none;
  cursor: pointer;
}

/* 100% Image Width on Smaller Screens */
@media only screen and (max-width: 700px){
  .modal-content {
    width: 100%;
  }
}
	
	
	
.sidenav {
  height: 100%;
  width: 0;
  position: fixed;
  z-index: 1024;
  top: 0;
  right: 0;
  background-color: #fff;
  overflow-x: hidden;
  transition: 0.5s;
  padding-top: 60px;
}

.sidenav a {
  padding: 8px 8px 8px 32px;
  text-decoration: none;
  font-size: 15px;
  font-family:Roboto,Arial,sans-serif;
  color: #818181;
  display: block;
  transition: 0.3s;
}

.sidenav a:hover {
  color: #000000;
}

.sidenav .closebtn {
  position: absolute;
  top: 0;
  left: 0px;
  font-size: 36px;
  margin-right: 50px;
}

@media screen and (max-height: 450px) {
  .sidenav {padding-top: 15px;}
  .sidenav a {font-size: 18px;}
}
	
</style>

</head>

<body>
<script src="https://apis.mapmyindia.com/advancedmaps/v1/hqnk8oeamxr1takexcxs2vlibib59hpp/map_load?v=1.3&plugin=polylinedecorator,path.drag"></script>

    <div id="loader" style='position:absolute;width:70px;height:70px;margin:auto;top:0;left:0;right:0;bottom:0;    z-index: 12223;'>
        <i class="fa fa-spinner fa-pulse fa-3x fa-fw"></i>
        <span class="sr-only">Loading...</span>
    </div>
	
	
    <div class="container2">
        <div id="output"></div>

    </div>
	
	
	
	
<div id="map">



</div>
<div id='hamburgernav' style="z-index: 1023;position: absolute;top: 0%;right: 5px;display:block">
	<span style="vertical-align: middle;border-style: none;height: 100%;width: 100%;" onclick="openNav()"><i class="fa fa-bars  fa-2x" aria-hidden="true"></i></span>
</div>	

<div id="mySidenav" class="sidenav">
  <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
  <a id="selfnoshow"> Self No Show
  </a>
  <a id ="cabnoshow" style="display:none">Cab No Show</a>
  <a id="sharebut" style="display:none">Share Cab Details</a>
  
      <a id="whatsapp" style="display:none">&emsp; Whatsapp</a>
      <a id="sms" style="display:none">&emsp; SMS</a>

</div>	

<div id="popup" style="width: 90%;z-index: 1023;position: absolute;top: 10%;height: 20%;right: 5%;background-Color: #f3f3f3;box-shadow: 0 2px 6px rgba(0,0,0,.3);display:none;"> 
<div style="margin: 5%;text-align: center;font-size: LARGE;">Your Cab's current location cannot be determined as we do not seem to be receiving data from the Driver's mobile.
Please contact the Driver to know his exact location.</div></div>

<!-- <div id="popupcovid" style="width: 90%;z-index: 1024;position: absolute;top: 5%;height: 60%;right: 5%;background-Color: #f3f3f3;box-shadow: 0 2px 6px rgba(0,0,0,.3);display:none;"> 
<div style="margin: 3% 2% 1% 2%;text-align: left;">
<b>IMPORTANT</b> protocols to follow at Accenture if you are unwell or a close contact of a Coronavirus positive individual.</br>
	<ul style=" list-style-type: circle;">
  <li><b>Stay home</b> if you are unwell</li>
  </br>
  <li>Seek medical advice if you have a fever, cold, headache, cough or other flu-like symptoms. Contact <b>ASOC at +91 80 4106 2762.</b> Inform your supervisor/ HR representative immediately</li>
  </br>
  <li>	<b>DO NOT</b> return to office until you have been notified through e-mail by your HR Representative that you can do so</li>
</ul>


By Accenture Team </br></br>
<button id='covidok' style="box-shadow:0 2px 6px rgba(0,0,0,.6);height: 55%;width: 15%;margin-top:6px;border:none;color: blue;"> OK </button>	
</div>
</div> -->

<div id="popupcovid"  class="card" style="z-index: 1024;position: absolute;top: 2%;height: 66%;width: 90%;right: 5%;background-Color: aliceblue;box-shadow: 0 2px 6px rgba(0,0,0,.3);display:none;border-style: groove;" >
 
  <div class="container" style="margin: 5% 5% 0% 5%;text-align: left;;font-family: Roboto,Arial,sans-serif;">
  <b>IMPORTANT</b> protocols to follow at Accenture if you are unwell or a close contact of a Coronavirus positive individual.</br>
	<ul style=" list-style-type: circle;">
  <li><b>Stay home</b> if you are unwell</li>
  </br>
  <li>Seek medical advice if you have a fever, cold, headache, cough or other flu-like symptoms. Contact <b>ASOC at +91 80 4106 2762.</b> Inform your supervisor/ HR representative immediately</li>
  </br>
  <li>	<b>DO NOT</b> return to office until you have been notified through e-mail by your HR Representative that you can do so</li>
</ul>


Regards, India Accenture Workplace Solutions

  <p><button id='covidok' style='  border: none; outline: 0; display: inline; padding: 8px; color: white; background-color: #000; text-align: center; cursor: pointer; width: 60%; font-size: 18px; margin:5% 20% 5% 20%'>OK</button></p>
  </div>
</div>


<div id="popupcovid2"  class="card" style="z-index: 1024;position: absolute;top: 2%;height: 67%;width: 90%;right: 5%;background-Color: aliceblue;box-shadow: 0 2px 6px rgba(0,0,0,.3);display:none;border-style: groove;" >
 
  <div class="container" style="margin: 5% 5% 0% 5%;text-align: left;;font-family: Roboto,Arial,sans-serif;">
<p><b>New Features in eTMS Buddy</b></p>
<ul style=" list-style-type: circle;">
  
  <li>
  <b>Cab users can mark themselves as “no-show”</b>  </br>
If you’ve missed cancelling your scheduled ride for day, you can now mark yourself 
as “no-show” on the “Where is my cab” tab. You no longer have to wait for the 
transport helpdesk to call you.

  </li>
    </br>
  <li>
  <b>Check the boarding status of fellow passengers</b>  </br>
You will now be able to check the boarding status of your fellow passengers under 
the “cab info” tab. Use this feature to get real-time updates on scheduled pick-ups. 
</li>

</ul>
  <p><button id='covidok2' style='  border: none; outline: 0; display: inline; padding: 8px; color: white; background-color: #000; text-align: center; cursor: pointer; width: 60%; font-size: 18px; margin:1% 20% 1% 20%'>OK</button></p>
  </div>
</div>
  
<div id="recentre" style='display:none'><img style='margin: 25%;margin-block-end: auto;width: 50%;height: 50%;' src="gps.png" ></i></div>

 <div id="myModal" class="modal">
  <span class="close">&times;</span>
  <img class="modal-content" id="img01">
  <div id="caption"></div>
</div>	



<div id='driverbox'>

	<div id='main' style='height:75%'>
 							
    <div id='circlemain' style='width:30%;float:left;height:64%;margin-top:3px;margin-top:.8rem;margin-left:5px;border-radius: 50%;'>
										
	<div id='circle' style='margin-top:2px;margin-left:5%;'>
			
                        
	</div>
                        
	</div>
				
		
	<div id='textcontent' style='width:40%;float:left;height:100%;margin-left:20px;'>
	
	<div style="display:flex; flex-direction:column; margin-top:.7rem;text-align:left;">
				<p style="margin-bottom:.1rem;font-weight:bold;" id="tdname"></p>
				<p style="margin-bottom:.1rem;" id="td_regno"></p>
				<p style="margin-bottom:.1rem;" id="td_vtype"></p>
				<p style="margin-bottom:.1rem;" id="boarding_status"></p>
				<p style="margin-bottom:.1rem;" id="eta"></p>
				<p id="Otp"></p>
			</div>
						
					
					</div>
						
				
							
						<div id='call_btn' style='width:15%;float:right;display:none;margin-bottom:1rem; margin-right: 5%;'>
										
											<button id='driver' style='box-shadow:0 2px 6px rgba(0,0,0,.6);height:30%;width:90%;margin-top:1.5rem;border:none;'>
			
											<img style="width:100%;height:100%;border:none !important;" src="phone.svg"></img>
											
											</button>
                        
							</div>
							
								<div id='help_btn' style='width:15%;float:right;display:none;    margin-right: 5%;'>
										
											<button id='helpbutton' style='box-shadow:0 2px 6px rgba(0,0,0,.6);height:30%;width:90%;margin-top:6px;border:none;'>
			
											<a id='aTag'>
											
											<img style="width:100%;height:100%;border:none !important;" src="headset.svg"></img>
											
											</a>
										
											
											</button>
                        
							</div>
							
							
							
                        
             </div>  
			 
			 
			 
			 
			 
			 
			           <div id='mainG' style='display:none ;height:75%'>

			 
			 
			  <div id='Ecirclemain' style='width:30%;float:left;height:64%;margin-top:3px;margin-top:.8rem;margin-left:5px;border-radius: 50%;'>
										
	<div id='Ecircle' style='margin-top:2px;margin-left:5%;'>
			
                        
	</div>
                        
	</div>

                    <div id='textcontentG' style='width:40%;float:left;height:100%;margin-left:12px;'>

                      <div style="display:flex; flex-direction:column; margin-top:.7rem;text-align:left;margin-left:1rem;">
						<p id='Escortdetails' style="margin-bottom:.5rem;font-weight:bold;">Escort Details:</p>
						<p style="margin-bottom:.5rem" id="guardname"></p>
						<p id="escortid"></p>
					</div>
				
					</div>

                    <div id='call_btn' style='width:15%;float:right;display:none;margin-bottom:1rem;'>

                        <button id='driver' style='box-shadow:0 2px 6px rgba(0,0,0,.6);height:30%;width:90%;margin-top:6px;border:none;'>

                            <img style="width:100%;height:100%;border:none !important;" src="phone.svg"></img>

                        </button>

                    </div>

                    <div id='help_btn' style='width:15%;float:right;display:none;'>

                        <button id='helpbutton' style='box-shadow:0 2px 6px rgba(0,0,0,.6);height:30%;width:90%;margin-top:6px;border:none;'>

                            <a id='aTag'>

                                <img style="width:100%;height:100%;border:none !important;" src="headset.svg"></img>

                            </a>


                        </button>

                    </div>
				
			</div>	
			<div style='height: 20%;position: absolute;left: 7.5em; '>
				<div style="display:flex;flex-direction:row;margin-top: 5%;">
						<button id='wheelicon' style='display:none;margin-right: 20%;'>  
							<img  src="wheel.svg" style="padding: 10%;"></img> 
							</button>
					<button id='guardicon' style='display:none'>
					
					  <img  src="guard.svg"  style="padding: 10%;"></img>
					
					</button>
					</div>
			</div>
			 
<script>

	function openNav() {
  document.getElementById("mySidenav").style.width = "250px";
}

function closeNav() {
  document.getElementById("mySidenav").style.width = "0";
     $("#whatsapp").hide();   $("#sms").hide();
}
		var locupdate;
		var marker=[];
		var etainterval;
		var eta='';
		var b2bflag=1;
		var url=[];
		var URL_RouteDetail='';
		var URL_GetGPSLogger='';
		var fromloc='77.087353,28.462420';
		var toloc='';
		 var OTP='';	
		var map = null;
var gender;
var employeeid ;
        var poly = [];
        var decorator;
        var line;
        var interval = 0;
		var driver_contact=[];
		var drivername=[];
		var vehicleRegNo=[];
		var vehicletype=[];
		var tptContactNo=[];
		var emplatlng;
		var emplatlng1;
		var empname='';
		var cabnoshowradius='';
		var homelatlng='';
		 var URL_UpdateCabNoShow='';
		 											 var myTrackingStatus='';
		 var isproximity=1;
     //   var pp = [[28.56731, 77.346355], [28.567074, 77.346022]];
		 var pp = [];
		 var center = new L.LatLng(28.549948, 77.268241);
		 var empcode=[];
	
		 
		 $(document).on('click', '#guardicon', function(){
			
			 $('#main').hide();
			 $('#mainG').show();
			  $("#wheelicon").css("background-color", "white"); $("#guardicon").css("background-color", "Yellow");
																  
			
			});
					

			$(document).on('click', '#wheelicon', function(){
			
		 $('#mainG').hide();
		 $('#main').show();
		 	  $("#guardicon").css("background-color", "white"); $("#wheelicon").css("background-color", "Yellow");
		  
			});
	
	function getQueryStringValue(key) {
  return unescape(
    window.location.search.replace(
      new RegExp(
        "^(?:.*[&\\?]" +
        escape(key).replace(/[\.\+\*]/g, "\\$&") +
        "(?:\\=([^&]*))?)?.*$",
        "i"
      ),
      "$1"
    )
  );
}

function getQueryStringValue1(key) {
  return unescape(
    window.location.search.replace(
      new RegExp(
        "^(?:.*[&\\?]" +
        escape(key).replace(/[\.\+\*]/g, "\\$&") +
        "(?:\\=([^&]*))?)?.*$",
        "i"
      ),
      "$2"
    )
  );
}

var value = getQueryStringValue("v");
var value1 = getQueryStringValue("s");
//parses the string to get the value for route id , client id and empid
//its of the form clientid-routeid-empid
var vs = value.substring(4, value.length);


var clientid = parseInt(value.substring(0, 4));
var routeid='';
var empid='';

if(clientid=='4'||clientid=='10'||clientid=='14'||clientid=='13'||clientid=='15'){
$('#hamburgernav').show();
}
else{
$('#hamburgernav').hide();
}


 
  if(value.length==25){
empid = (value.slice(value.length - 8, value.length));
   routeid = vs.substring(0, vs.length - 8);
console.log(empid);
console.log(routeid);
}  
else if(value.length==24){
empid = (value.slice(value.length - 7, value.length));
   routeid = vs.substring(0, vs.length - 7);
console.log(empid);
console.log(routeid);
}
else if(value.length==23||value.length==21)
{	
empid = (value.slice(value.length - 6, value.length));
   routeid = vs.substring(0, vs.length - 6);
console.log(empid);
console.log(routeid);
}
else if(value.length==22||value.length==20)
{	
empid = (value.slice(value.length - 5, value.length));
   routeid = vs.substring(0, vs.length - 5);
console.log(empid);
console.log(routeid);
}
else if(value.length==19)
{	
empid = (value.slice(value.length - 4, value.length));
   routeid = vs.substring(0, vs.length - 4);
console.log(empid);
console.log(routeid);
}
			 
			 
			 
			var myUrl = window.location.href;
//alert(myUrl);
var murl = myUrl.split("&");
var surl = murl[1];

 
       $("#sharebut").on("click", function(){
  //  $("#sharebut1").slideToggle(500);
   // $("#share").show();
  //  $("#popupshare").toggle();
  
   $("#whatsapp").show();   $("#sms").show();
	
//share();
  });
			
    $("#whatsapp").on("click", function(){
  //  $("#sharebut1").slideToggle(500);
   // $("#share").show();
 
	
share();
  });
      $("#sms").on("click", function(){
  //  $("#sharebut1").slideToggle(500);
   // $("#share").show();
 
	
share1();
  });
  
  if(clientid==4||clientid==14||clientid=='13'||clientid=='15'||clientid=='10'){
  
   $("#popupcovid").show();
  
  }
     $("#covidok").on("click", function(){
	    $("#popupcovid").hide();
		  $("#popupcovid2").show();
	 });
	    $("#covidok2").on("click", function(){
	    $("#popupcovid2").hide();
	 });



   $("#selfnoshow").on("click", function(){
   
     var selfnoshowconfirm = confirm('Do you want to mark the cab as no-show?');
          if (selfnoshowconfirm == true) {
     if(myTrackingStatus!= '----'){
	 alert("You cannot mark yourself as No-Show for this trip as you are already marked as "+myTrackingStatus+" for this trip.");
	 }
	 else{
	 $.ajax({
                          type: 'POST',
                          cache: false,
                          url: URL_UpdateTrackingSelf,
                          data: JSON.stringify({
                            routeid: routeid,
                            empid: empid,
                            trackingaction: 'N',
                            actionby: '0',
                            distance: employeeid
                          }),
                          crossDomain: true,

                          contentType: 'application/json; charset=utf-8',
                          dataType: 'json'
                        })
                          .done(function(data) {

                     alert("You have marked yourself as No-Show.")       

                   
                          })
                          .fail(function(e) {
                            alert('Error: ' + e.statusText);
                          })
                          .always(function() {});
   
		}
		}
		else{
		console.log("cancelled");
		}
   });
 

  $("#cabnoshow").on("click", function(){
   function arePointsNear(checkPoint, centerPoint, km) {
        var ky = 40000 / 360;
        var kx = Math.cos((Math.PI * centerPoint.lat) / 180.0) * ky;
        var dx = Math.abs(centerPoint.lng - checkPoint.lng) * kx;
        var dy = Math.abs(centerPoint.lat - checkPoint.lat) * ky;
        return Math.sqrt(dx * dx + dy * dy) <= km;
      }
  getLocation();

function getLocation() {




  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(showPosition, showError);
  } else { 
 alert("Geolocation is not supported by this browser.");
  }
}



 
 
function showPosition(position) {

  
        var homelatlng = { lat: position.coords.latitude, lng: position.coords.longitude  };
  
 
   var n = arePointsNear(homelatlng, emplatlng1,cabnoshowradius);
   
          if (n == true) {
	   
  	          var confirmArrived = confirm('Do you want to mark the cab as no-show?');
          if (confirmArrived == true) {
		
        $.ajax({
        
          type: 'POST',
          cache: false,
          url: URL_UpdateCabNoShow,
          data: JSON.stringify({
            "routeid": routeid,
            "empid": empid,
            "trackingaction": employeeid ,
            "lat": '0',

            "lng": '0'
          }),
          crossDomain: true,

    contentType: 'application/json; charset=utf-8',
    dataType: 'json'
        })
          .then(function(data) {
           console.log(' updated');
         alert('Thank you for the NO Show alert, we will notify the driver immediately.');
		 $("#cabnoshow").hide();
          })
          .fail(function(e) {
          console.log('Error : '+e);
          });
        }
       else {
        console.log('cab no show cancelled')
}
}
 else{
      alert('Current location does not match pick-up location. Reach pick-up point to confirm vehicle No show. ');
  
  }
  
}
  





function showError(error) {
  switch(error.code) {
    case error.PERMISSION_DENIED:
     alert("User denied the request for Geolocation.");
      break;
    case error.POSITION_UNAVAILABLE:
     alert("Location information is unavailable.");
      break;
    case error.TIMEOUT:
alert("The request to get user location timed out.");
      break;
    case error.UNKNOWN_ERROR:
      alert("An unknown error occurred.");
      break;
  }
}


   // $("#cabnoshow").hide();


  });

  function share() {
    $(document).ready(function () {
      var isMobile = {
        Android: function () {
          return navigator.userAgent.match(/Android/i);
        },
        BlackBerry: function () {
          return navigator.userAgent.match(/BlackBerry/i);
        },
        iOS: function () {
          return navigator.userAgent.match(/iPhone|iPad|iPod/i);
        },
        Opera: function () {
          return navigator.userAgent.match(/Opera Mini/i);
        },
        Windows: function () {
          return navigator.userAgent.match(/IEMobile/i);
        },
        any: function () {
          return (
            isMobile.Android() ||
            isMobile.BlackBerry() ||
            isMobile.iOS() ||
            isMobile.Opera() ||
            isMobile.Windows()
          );
        }
      };
      //alert(isMobile)
      if (isMobile.any()) {

if(gender=='M'){

        var url = empname+" wants you to view his cab details. Kindly click on the link below : \n"+myUrl + "&s=s";
}
else if(gender=='F'){

        var url = empname+" wants you to view her cab details. Kindly click on the link below : \n"+myUrl + "&s=s";
}
else{
var url = empname+" wants you to view their cab details. Kindly click on the link below : \n"+myUrl + "&s=s";
}
        var message = encodeURIComponent(url);
        //sharedStat=1;
        var whatsapp_url = "whatsapp://send?text=" + message;
        window.location.href = whatsapp_url;
      } else {
        alert("Please share this article in mobile device");

      }
    });

  }

  
  function share1() {
    var getOS = function () {
      var userAgent = navigator.userAgent || navigator.vendor || window.opera;

      if (
        userAgent.match(/iPad/i) ||
        userAgent.match(/iPhone/i) ||
        userAgent.match(/iPod/i)
      ) {
        return "iOS";
      } else if (userAgent.match(/Android/i)) {
        return "Android";
      } else {
        return "unknown";
      }
    }

    var device = getOS();

   


if(gender=='M'){

    var url = empname+" wants you to view his cab details. Kindly click on the link below : \n"+myUrl + "&s=s";
}
else if(gender=='F'){

    var url = empname+" wants you to view her cab details. Kindly click on the link below : \n"+myUrl + "&s=s";
}
else{
 var url = empname+" wants you to view their cab details. Kindly click on the link below : \n"+myUrl + "&s=s";
}


    var message = encodeURIComponent(url);


    if (device == "iOS") {
      window.location.href = "sms: &body=" + message;
    }

    if (device == "Android") {
      window.location.href = "sms:?body=" + message;
    }
  }			 
			 
function secondsToHms(d) {
    d = Number(d);
    var h = Math.floor(d / 3600);
    var m = Math.floor(d % 3600 / 60);
    var s = Math.floor(d % 3600 % 60);
	
	
	if(h>0){
	hDisplay=h + "hr";
	mDisplay="";
	sDisplay="";
	}
	else{
		if (m>0){
				mDisplay=m + "min";
					hDisplay="";
					sDisplay="";
	
		}
		else{
		sDisplay=s + "sec";
					hDisplay="";
					mDisplay="";
		}
	
	}
	

    return hDisplay + mDisplay + sDisplay; 
}		 
			 
			 if (value || value1) {

		     $('#noteBox').hide();
		
        $.ajax({
            cache: false,
            type: "GET",
            username: "user1",
            password: "Acc@bang10",
            url: "https://www.etmsdrive.in/appControlRest/api/v1/getClientDetailById",
            data: {
                CID: clientid
            },
            crossDomain: true,
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: OnSuccess3,
            error: OnError3
        });
		function OnSuccess3(data, status) { 
          $("#loader").hide();
                    $("#output").empty();
				$.each(JSON.parse(data), function(key, val) {
                url.push(val.URL);
                //BASE_URL = url[0];
                //TrackURL = val.dashboardurl; // uncommnent this one when this comes from api
                TrackURL = val.trackurl; //Changed by Anurag, On 29-11-17, to implemnet in amex
                BASE_URL = val.trackurl; //Changed by Anurag, On 29-11-17, to implemnet in amex				
                // //until then use this one below.
                //TrackURL = "https://www.etmsdrive.in/etmsDrive/api/tracking/v1/";
                MEDIA_URL = "";
                //#change
					var URL_cabvalidation = TrackURL + "MyCabValidation";
				var URL_ProfilePicture=val.photourl;
				URL_CallingAPI = TrackURL + "CallingAPI";
				URL_RouteInfo = TrackURL + "GetRouteInfoMyCab";
				URL_RouteDetail = TrackURL + "GetRouteDetail";
				URL_GetGPSLogger = TrackURL + "GetGPSLogger";
				 URL_UpdateCabNoShow = TrackURL +'UpdateCabNoShow';
				 URL_UpdateTrackingSelf=TrackURL +'UpdateTrackingSelf';
                
				
				 $.ajax({
                                type: "POST",
                                username: "user1",
                                password: "Acc@bang10",
                                url: URL_RouteInfo, //URL_RouteInfo = BASE_URL+"GetRouteInfoMyCab";
                                data: "{RouteID:'" + routeid + "'}",
                                crossDomain: true,
                                contentType: "application/json; charset=utf-8",
                                dataType: "json",
                                success: OnSuccess2,
                                error: OnError2
                            });
							 function OnSuccess2(data, status) {
							 
							   $.each(JSON.parse(data), function(key, val) {
                                    //	console.log(JSON.stringify(data, null, 4))
                                    if (val.routeID != 'NA') {
                                        //var profileurl = MEDIA_URL + "ProfilePicture/" + val.ProfilePicture;	
cabnoshowradius=val.cabnoshowradius/1000;										
                                        driver_contact.push(val.driverContact);
                                        var profileurl = URL_ProfilePicture + val.driverContact + ".jpeg";
										   var EscortImage = val.guardphotourl;
										
                                        //var profileurl =URL_ProfilePicture
                                        var p = val.vehicleRegNo.toUpperCase();
                                        if (val.isb2b == "1") {
                                            b2bflag = "3";
                                        } else {
                                            b2bflag = "1";
                                        }
										 if(val.guardid==''||val.guardid==null){
															 
															  console.log('no guard');
															
															 }
															else{
															$('#guardicon').show();
																$('#wheelicon').show();
															 console.log('guard');
															
															}
										
										  drivername.push(val.driverName); 
										  vehicleRegNo.push(p); 
										  vehicletype.push(val.vehicleType); 
										  tptContactNo.push(val.tptContactNo);
										     $("#guardname").html(val.gaurdname);
												$("#escortid").html(val.guardid);
																
										  
										  center = new L.LatLng(val.faclat,val.faclng);
										  
									 $('#tdname').html(drivername);
										   $('#td_regno').html(vehicleRegNo); 
										     $('#td_vtype').html(vehicletype);
											 
											 
											 var img = new Image();
                                            var div = document.getElementById('circle');
                                            img.id = "driverImage";
                                            img.src = profileurl;
                                         img.style.width = '100%';
										 
										img.style.borderRadius ='50%';
                                            // img.style.height = 'auto';
                                            
                                            img.style.boxShadow = '0px 3px 10px rgba(0,0,0,0.5)';
                                            img.style.Border = '20px solid red';
                                            div.appendChild(img);
											
                                           // img.style.borderRadius = '50%';
                                          
                                            $("#driverImage").on("error", function() {
                                                $(this).attr('src', 'img_avatar.png');
                                            });
																	
													var imgE = new Image();
                                            var divE = document.getElementById('Ecircle');
                                            imgE.id = "EscortImage";
                                            imgE.src = EscortImage;
                                         imgE.style.width = '100%';
										 imgE.style.borderRadius ='50%';
                                            // img.style.height = 'auto';
                                            
                                            imgE.style.boxShadow = '0px 3px 10px rgba(0,0,0,0.5)';
                                            imgE.style.Border = '20px solid red';
                                            divE.appendChild(imgE);
											
                                           // img.style.borderRadius = '50%';
                                          
                                            $("#EscortImage").on("error", function() {
                                                $(this).attr('src', 'img_avatar.png');
                                            });
							 
							 }
});
							 
	}										  function OnError2(request, status, error) {
										 $("#loader").hide();
                                                    $("#output").empty();
                                                    $("#output").html(
                                                        "Error: Connecting to server");

                                                    $("#height").css("output", "2%");
																		
														
											  }
							 
											  $.ajax({
                                type: "POST",
                                username: "user1",
                                password: "Acc@bang10",
                              url:URL_RouteDetail, 					
                               // data: "{RouteID: '" + routeid + "',flag:'3'}",
                               data: "{RouteID: '" + routeid + "',flag:'" + b2bflag + "'}",
                                crossDomain: true,
                                contentType: "application/json; charset=utf-8",
                                dataType: "json",
                                success: sucess1,
                                error: err1
                            });

                            function sucess1(data, status) {
							               $.each(JSON.parse(data), function(key, val) {
										      if (val.id == empid) {
											gender=val.Gender;
										employeeid =val.employeeID;
											  
											  if((val.CabNoShow==0) && (clientid=='4'||clientid=='10'||clientid=='14'||clientid=='13'||clientid=='15')){
											  
											 
											 // $('#cabnoshow').show();

											  }
											  else{
											 // 		  $('#cabnoshow').hide();
											  }
											  
											  if(val.tripType=='D'){
											 //  $('#cabnoshow').hide();
											  }
											  
											  if(clientid=='4'||clientid=='10'||clientid=='14'||clientid=='13'||clientid=='15'){
											 // $("#sharebut").show();
											  }
											  else{
											//  $("#sharebut").hide();
											  }
											  
											 empname=val.empName;
							emplatlng=new L.LatLng(val.lat,val.lng);
							   emplatlng1 = { lat: val.lat, lng: val.lng };
						 
											  
											  myTrackingStatus = val.trackingStatus
														   if (myTrackingStatus != '----') {
                                                	    $("#boarding_status").show();
												document.getElementById('boarding_status').innerHTML = '<strong style="background-color: #42f474;">' + myTrackingStatus.toUpperCase() + '</strong>';
                                     
											} else {
											         
													  
                                                document.getElementById('boarding_status').innerHTML = '<strong></strong>';
												    $("#boarding_status").hide();
												  
												 
                                            }
												OTP = val.boardingOTP;
												 	if(OTP!='')
											{
											document.getElementById('Otp').innerHTML = '<strong>OTP :</strong>' +' '+ OTP;
												
											}
											
											
												 		
										 if ( myTrackingStatus == "No-Show") {
                                                    var call_btn = document.getElementById('call_btn');
                                                    call_btn.style.display = 'none';
                                                    var help_btn = document.getElementById('help_btn');
                                                    help_btn.style.display = 'inherit';
													//  $("#Otp").hide();
													   //  $("#boarding_status").hide();
													   
													  	 clearInterval(etainterval); 
													   
													   	$('#eta').hide();
														$("#Otp").hide();
														
													   
												
                                                } else if (myTrackingStatus == "Boarded") {
                                                    var call_btn = document.getElementById('call_btn');
                                                    call_btn.style.display = 'none';
                                                    var help_btn = document.getElementById('help_btn');
                                                    help_btn.style.display = 'inherit';
						  $('#cabnoshow').hide();
													 // $("#Otp").hide();
													  //   $("#boarding_status").hide();
													    	$('#eta').hide();
														$("#Otp").hide();
														 clearInterval(etainterval); 
													   
											
												
                                                } 
												else {
                                                    var call_btn = document.getElementById('call_btn');
                                                    call_btn.style.display = 'inherit';
                                                    var help_btn = document.getElementById('help_btn');
                                                    help_btn.style.display = 'inherit';
														$('#eta').show();
							     $("#Otp").show();
                                                }
												
												
												if(value1 == 's'){
												  var call_btn = document.getElementById('call_btn');
                                                    call_btn.style.display = 'none';
                                                    var help_btn = document.getElementById('help_btn');
                                                    help_btn.style.display = 'inherit';
													//  $("#Otp").hide();
													   //  $("#boarding_status").hide();
													   
													  	 clearInterval(etainterval); 
													   
													   	$('#eta').hide();
														$("#Otp").hide();	$("#cabnoshow").hide();$("#sharebut").hide();
														
												
												
												
												}
											
											 var aTag = document.getElementById('aTag');
                                            aTag.setAttribute('data-rel', 'external');
                                            aTag.setAttribute('href', 'tel:' +  tptContactNo[0]);
											
										
											
											
							              
											
											$('#driver').on("click", function () {
														callLatch();
													  });
													  
													  function callLatch() {
													  confirm1 = confirm("Do you wish to call the driver?");
													  if (confirm1 == true) {
														callapi();
													  }
													}

													
													
													
													
													
													
													var modal = document.getElementById("myModal");

// Get the image and insert it inside the modal - use its "alt" text as a caption
var img = document.getElementById("driverImage");
var modalImg = document.getElementById("img01");
var captionText = document.getElementById("caption");
img.onclick = function(){
  modal.style.display = "block";
  modalImg.src = this.src;
  captionText.innerHTML = this.alt;
}

// Get the <span> element that closes the modal
var span = document.getElementsByClassName("close")[0];

// When the user clicks on <span> (x), close the modal
span.onclick = function() { 
  modal.style.display = "none";
}
	

													
													var modal = document.getElementById("myModal");

// Get the image and insert it inside the modal - use its "alt" text as a caption
var img = document.getElementById("EscortImage");
var modalImg = document.getElementById("img01");
var captionText = document.getElementById("caption");
img.onclick = function(){
  modal.style.display = "block";
  modalImg.src = this.src;
  captionText.innerHTML = this.alt;
}

// Get the <span> element that closes the modal
var span = document.getElementsByClassName("close")[0];

// When the user clicks on <span> (x), close the modal
span.onclick = function() { 
  modal.style.display = "none";
}	
													
													
													
											function callapi() {
											  $("#loader").show();
											  $.ajax({
												cache: false,
												type: "POST",
												url: URL_CallingAPI,
												data: "{empid: '" +
												  empid +
												  "',drivermobile: '" +
												  driver_contact[0] +
												  "',type:'sun'}",
												crossDomain: true,
												contentType: "application/json; charset=utf-8",
												dataType: "json",
												success: OnSuccess2,
												error: OnError2
											  });

											  function OnSuccess2(data, status) {
												$("#loader").hide();
												$("#output").empty();
												alert("Please wait while your call is being connected");
												$.each(JSON.parse(data), function (key, val) {
												  //call????
												});
											  }

											  function OnError2(request, status, error) {
												$("#loader").hide();
												$("#output").empty();
												$("#output").html(request.statusText);
																		
														
											  }
											}
										      var lathome = val.lat;
                                        var lnghome = val.lng;
										toloc=lnghome+','+lathome;
										   }
										          });
												  
												  
												  
												  
												
              
												              map = new MapmyIndia.Map('map', {
                center: center,
            zoomControl: true,
   hybrid: false,
   search: false,
   location: false
				
            });

				 $('#flsc_dv').hide();
function addMarker(position, icon, title,i) {
  /*** position must be instance of L.LatLng ***/
 
  if (icon == '') {
    var mk;
    /***Marker with a default icon and optional parameter draggable, title***/
     mk = new L.Marker(position, {
      draggable: true,
      title: title
    });
  } else {
    /***Marker with a custom icon and optional parameter draggable, title***/
    var mk;
	 mk = new L.Marker(position, {
      icon: icon,
      draggable: true,
      title: title
    });
  }
  /*Add the marker to the map*/
  map.addLayer(mk);
  /**Marker events**/

  return mk;
} 


													 var icon = L.icon({
         iconUrl: "home.png",
         iconRetinaUrl: 'home.png',
         iconSize: [30, 30]
       });
			
				setTimeout(function () {
						  marker.push(addMarker(emplatlng, icon, "Home",'').addTo(map));
						  	map.panTo(pp[0]);
				
							
						  },3000);
		//	map.on("load", function (e) 
//{ 
			
//});
			

		
			
					$('#recentre').on("click", function () {
					map.panTo(pp[0]);
						setTimeout(function () {
							map.setZoom(16);
						},500);
					
					});
			hi();
			
			function hi(){	
		$.ajax({
                        type: "POST",
                        username: "user1",
                        password: "Acc@bang10",
						   url: URL_GetGPSLogger,
                            data: "{deviceId: '" + routeid + "',vendorid:'0'}",
					crossDomain: true,
                        contentType: "application/json; charset=utf-8",
                        dataType: "json",
                        success: OnSuccess5,
                        error: OnError5
                    });
		
		      function OnSuccess5(data, status) {
              
                        $.each(JSON.parse(data), function(key, val) {
						$('#recentre').show();
                        console.log(val.lat);
                         var lat = val.lat;
                          var  lng = val.lng;
						  if(lat==null||lat==undefined){
						  $("#popup").show();
						//  alert ("Your Cab's current location cannot be determined as we do not seem to be receiving data from the Driver's mobile.Please contact the Driver to know his exact location.")
						  }
						  console.log("null lat"+lat);
						  var latlng=[];
						    latlng.push(lat);
						  latlng.push(lng);
						  var lnglat=[];
							lnglat.push(lng);
						    lnglat.push(lat);
						  fromloc=lnglat;
						//if (latlng[0]!= pp[pp.length-1][0]){
						 pp.push(latlng);
						 	 pp.push(latlng);
							  	map.panTo(pp[0]);
							
							setTimeout(function () {
							map.setZoom(16);
						},500);
						
						
						 
			etainterval=setInterval(function () {
				$.ajax({
                    cache: false,
            type: "GET",
           
            url: "https://apis.mapmyindia.com/advancedmaps/v1/rqk346pt2yk6ej68los7jqythfwhiful/distance_matrix/driving/"+fromloc+";"+toloc+"?rtype=1&region=ind",
       
            crossDomain: true,
            contentType: "application/json; charset=utf-8",
            dataType: "jsonp",
		
                        success: OnSuccess7,
                        error: OnError7
                    });
					
							      function OnSuccess7(data, status) {
              
                       
                        console.log(data);
						eta=secondsToHms(data.results.durations[0][1]);
				
						
					console.log(eta);
					document.getElementById('eta').innerHTML = '<strong>' + eta + '</strong>';
						}
						
						 function OnError7(request, status, error) {
                  //      $("#output").html(request.statusText);
																
																
                    }
                       
							}, 30000);
					 
	
		

						 
				   drawCarMarkerOnPolyline();
				//   }
				   
			});
			}
			
			     function OnError5(request, status, error) {
                  //      $("#output").html(request.statusText);
																
																
                    }
						
			}
			
            //draw polyline
         
     //   }

        function drawCarMarkerOnPolyline(hi) {
	
						  
		
           removePolyline();
            var offset = 0; //intial offset value
            var w = 14, h = 33;
            //Polyline css
            var linecss = {
                color: 'transparent',
                weight: 3,
                opacity: 1
            };
            line = L.polyline(pp, linecss).addTo(map); //add polyline on map
            decorator = L.polylineDecorator(line).addTo(map);
		//create a polyline decorator instance.

            //offset and repeat can be each defined as a number,in pixels,or in percentage of the line's length,as a string 
            interval = window.setInterval(function () {
                decorator.setPatterns([{
                        offset: offset + '%', //Offset value for first pattern symbol,from the start point of the line. Default is 0.
                        repeat: 0, //repeat pattern at every x offset. 0 means no repeat.
                        //Symbol type.
                        symbol: L.Symbol.marker({
                            rotate: true, //move marker along the line. false value may cause the custom marker to shift away from a curved polyline. Default is false. 
                            markerOptions: {
                                icon: L.icon({
                                    iconUrl: 'https://www.mapmyindia.com/api/advanced-maps/doc/sample/images/car.png',
                                    iconAnchor: [w / 2, h / 2], //Handles the marker anchor point. For a correct anchor point [ImageWidth/2,ImageHeight/2]
                                    iconSize: [14, 33]
                                })
                            }
                        })
                    }
                ]);
                if ((offset += 0.33) > 100) //Sets offset. Smaller the value smoother the movement.
                    {//offset = 0;
					}
            }, 10); //Time in ms. Increases/decreases the speed of the marker movement on decrement/increment of 1 respectively. values should not be less than 1.
            poly.push(line);
            poly.push(decorator);
		
           // map.fitBounds(line.getBounds());
			setInterval(function () {
						if(pp.length<3){
			
			hi2();
			} 
			
							}, 15000);
			
			
			
			
			
			
			
			
			
			
			
			
							function hi2(){	
		$.ajax({
                        type: "POST",
                        username: "user1",
                        password: "Acc@bang10",
                     url: URL_GetGPSLogger,
                            data: "{deviceId: '" + routeid + "',vendorid:'0'}", 
							crossDomain: true,
                        contentType: "application/json; charset=utf-8",
                        dataType: "json",
                        success: OnSuccess6,
                        error: OnError6
                    });
		
		      function OnSuccess6(data, status) {
              
                        $.each(JSON.parse(data), function(key, val) {
                        console.log(val.lat);
                         var lat = val.lat;
                          var  lng = val.lng;
						  var latlng=[];
						    latlng.push(lat);
						  latlng.push(lng);
						  	  var lnglat=[];
							lnglat.push(lng);
						    lnglat.push(lat);
						  fromloc=lnglat;
						  	map.panTo(pp[0]);
							
			
						if (latlng[0]!= pp[pp.length-1][0]){
						 pp.push(latlng);
						 pp.shift();
				   drawCarMarkerOnPolyline();
				   
				   }
			});
			}
			
			     function OnError6(request, status, error) {
                  //      $("#output").html(request.statusText);
																
																
                    }
						
			}
        }
		
		 var removePolyline = function () {
            var polylength = poly.length;
            if (polylength > 0) {
                for (var i = 0; i < polylength; i++) {
                    if (poly[i] !== undefined) {
                        map.removeLayer(poly[i]);
                    }
                }
                poly = new Array();
                window.clearInterval(interval);
            }
        }
												  
												  
												  
												  
												  
												  
												  
												  
                            }

                            function err1(request, status, error) {
                          console.log('ERROR')
												
												
							
                            }
				
			  });
			 }
			 
			    function OnError3(request, status, error) {
                  //      $("#output").html(request.statusText);
				    $("#loader").hide();
                    $("#output").empty();
                    $("#output").html(request.statusText);
																
																
                    }
			}
			
			 else {
                $("#loader").hide();
                $("#output").empty();
                $("#output").html("Incorrect Parameters");


            }
			 
			 
			 
			      locupdate=setInterval(function () { //Iterative call for marker movement, as well as the interval
                    Routedet();
                }, 7000);
		
		function Routedet(){
											  $.ajax({
                                type: "POST",
                                username: "user1",
                                password: "Acc@bang10",
                              url:URL_RouteDetail, 					
                               // data: "{RouteID: '" + routeid + "',flag:'3'}",
                                data: "{RouteID: '" + routeid + "',flag:'" + b2bflag + "'}",
                                crossDomain: true,
                                contentType: "application/json; charset=utf-8",
                                dataType: "json",
                                success: sucess1,
                                error: err1
                            });

                            function sucess1(data, status) {
							               $.each(JSON.parse(data), function(key, val) {
										      if (val.id == empid) {
	employeeid =val.employeeID;
gender=val.Gender;
  if((val.CabNoShow==0) && (clientid=='4'||clientid=='10'||clientid=='14'||clientid=='13'||clientid=='15')){
											//  $('#cabnoshow').show();
											  }
											  else{
											  //		  $('#cabnoshow').hide();
											  }
											    if(val.tripType=='D'){
											   //$('#cabnoshow').hide();
											  }
											    
											  if(clientid=='4'||clientid=='10'||clientid=='14'||clientid=='13'||clientid=='15'){
											  //$("#sharebut").show();
											  }
											  else{
											  //$("#sharebut").hide();
											  }

											  myTrackingStatus = val.trackingStatus
														   if (myTrackingStatus != '----') {
                                                	    $("#boarding_status").show();
												document.getElementById('boarding_status').innerHTML = '<strong style="background-color: #42f474;">' + myTrackingStatus.toUpperCase() + '</strong>';
                                     
											} else {
											         
													  
                                                document.getElementById('boarding_status').innerHTML = '<strong></strong>';
												    $("#boarding_status").hide();
												  
												 
                                            }
												OTP = val.boardingOTP;
												 	if(OTP!='')
											{
											document.getElementById('Otp').innerHTML = '<strong>OTP :</strong>' +' '+ OTP;
												
											}
											
											
												 		
										 if ( myTrackingStatus == "No-Show") {
                                                    var call_btn = document.getElementById('call_btn');
                                                    call_btn.style.display = 'none';
                                                    var help_btn = document.getElementById('help_btn');
                                                    help_btn.style.display = 'inherit';
													//  $("#Otp").hide();
													   //  $("#boarding_status").hide();
													   
													  	 clearInterval(etainterval); 
													   
													   	$('#eta').hide();
														$("#Otp").hide();
													    clearInterval(locupdate);
												
                                                } else if (myTrackingStatus == "Boarded") {
                                                    var call_btn = document.getElementById('call_btn');
                                                    call_btn.style.display = 'none';
                                                    var help_btn = document.getElementById('help_btn');
                                                    help_btn.style.display = 'inherit';
							  $('#cabnoshow').hide();
													 // $("#Otp").hide();
													  //   $("#boarding_status").hide();
													    	$('#eta').hide();
														$("#Otp").hide();
														 clearInterval(etainterval); 
													   
											 clearInterval(locupdate);
												
                                                } 
																						
												else {
                                                    var call_btn = document.getElementById('call_btn');
                                                    call_btn.style.display = 'inherit';
                                                    var help_btn = document.getElementById('help_btn');
                                                    help_btn.style.display = 'inherit';
														$('#eta').show();
							     $("#Otp").show();
                                                }
												
												
														if(value1 == 's'){
												  var call_btn = document.getElementById('call_btn');
                                                    call_btn.style.display = 'none';
                                                    var help_btn = document.getElementById('help_btn');
                                                    help_btn.style.display = 'inherit';
													//  $("#Otp").hide();
													   //  $("#boarding_status").hide();
													   
													  	 clearInterval(etainterval); 
													   
													   	$('#eta').hide();
														$("#Otp").hide();	$("#cabnoshow").hide();$("#sharebut").hide();
														
												
												
												
												}
											
											
											 var aTag = document.getElementById('aTag');
                                            aTag.setAttribute('data-rel', 'external');
                                            aTag.setAttribute('href', 'tel:' +  tptContactNo[0]);
											
										}
											
											});
											
											
											}
											
                            function err1(request, status, error) {
                          console.log('ERROR')
												
												
							
                            }
		
		
		
		}
	
     //   window.onload = function () {
       


 
</script>
</body>
</html>