<!doctype html>

<html>
  <head>
    <title>ETMS DRIVE- View Current Location</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="ScreenOrientation" content="autoRotate:disabled">
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"
        integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>

    <link rel="stylesheet" href="css/style.css"> 
    <link href="css/bootstrap.min.css" rel="stylesheet">

    
    <!-- <link href="https://maps-gl.nextbillion.io/maps/v2/api/css" rel="stylesheet" /> -->

    <style>
        html,
        body,

        /* #map {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
        } */

        #map {
            position: absolute;
            width: 100%;
            height: 100vh;
            top: 0;
            left: 0;
            z-index: -1;
        }

        :root {
            --white: #fff;
            --primary: #4a36ec;
            --success: #0baa60;
            --warning: #fdba0f;
        }

        * {
            padding: 0;
            margin: 0;
        }

        a {
            text-decoration: none;
        }

        /* .no-scroll {
            overflow: hidden !important;
        } */

        /* button {
            text-decoration: none;
        } */

        body {
            font-family: PlusJakartaSans;
            font-stretch: normal;
            font-style: normal;
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6,
        td p {
            margin: 0;
        }

        .text_version{
            position: absolute;
            bottom: 4px;
            left: 14px;
            font-size: 8px;
            color: #000;
            font-weight: 800;
        }


        .call_action {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 20px;
            padding: 16px 30px;
            width: calc(100% - 40px);
            position: fixed;
            bottom: 0px;
            border-radius: 16px;
            -webkit-backdrop-filter: blur(20px);
            backdrop-filter: blur(20px);
            background-color: rgba(41, 41, 41, 0.6);

        }

        .icon-container {
            position: relative;
            display: inline-block;
        }

        .icon-container::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 10px;
            height: 10px;
            background-color: red;
            border-radius: 50%;
            display: none;
            /* initially hide the dot */
        }

        .red-dot-visible::after {
            display: block;
            /* show the dot when this class is present */
        }

        .call_btn button {
            background-color: transparent;
            border: 0;
        }

        .call_action small {
            display: block;
            text-align: center;
            margin-top: 10px;
            font-size: 11px;
            font-weight: 600;
            color: var(--white);
        }

        .call_action a {
            font-size: 11px;
            font-weight: 600;
            color: var(--white);
        }

        .call_action div {
            font-size: 11px;
            font-weight: 600;
            color: var(--white);
        }

        .call_action button {
            background-color: transparent;
            border: 0;
            color: var(--white);
        }

        .driverBx {
            width: calc(100% - 40px);
            position: absolute;
            -webkit-backdrop-filter: blur(20px);
            backdrop-filter: blur(20px);
            box-shadow: 0 0 0 0 rgba(31, 22, 95, 0.2), 0 2px 4px 0 rgba(31, 22, 95, 0.2),
                0 7px 7px 0 rgba(31, 22, 95, 0.17), 0 16px 9px 0 rgba(31, 22, 95, 0.1),
                0 28px 11px 0 rgba(31, 22, 95, 0.03), 0 44px 12px 0 rgba(31, 22, 95, 0);
            background-color: #4a36ec;
            border: solid 1px #4a36ec;
            border-radius: 24px;
            border-bottom-left-radius: 0;
            margin: 20px;
        }

        .DetalBx {
            display: flex;
            justify-content: start;
            align-items: start;
        }

        .personDetalBx {
            padding: 10px 0 0 16px;
        }

        .personDetalBx h2 {
            font-size: 21px;
            font-weight: 600;
            color: var(--white);
            margin: 10px 0;
            width: auto;
            text-overflow: ellipsis;
            white-space: nowrap;
            overflow: hidden;
        }

        .personDetalBx h3 {
            font-size: 13px;
            font-weight: normal;
            color: var(--white);
        }

        .personDetalBx td {
            font-size: 13px;
            font-weight: normal;
            color: var(--white);
        }

        .personDetalBx .otp {
            font-size: 13px;
            font-weight: 600;
            color: var(--white);
            background: var(--success);
            margin-top: 10px;
        }

        .driver_badge {
            background: #ebe7ff;
            color: var(--primary);
        }

        .guard_badge {
            background: var(--warning);
            color: var(--primary);
        }


        .carousel-indicators {
            margin-bottom: 4px;
            border-radius: 8px;
        }

        .carousel-indicators [data-bs-target] {
            width: 8px;
            height: 8px;
            border: 0;
            border-radius: 8px;
        }

        .logo_icon {
            position: absolute;
            top: 18px;
            right: 18px;
            z-index: 1024;
        }

        /* .imgBx {
            position: relative;
        }

        .imgBx .reaching {
            position: absolute;
            bottom: -52px;
            border-bottom-left-radius: 24px;
            border-bottom-right-radius: 24px;
            background: #1c1d20;
            width: 100%;
            height: 52px;
            padding-left: 18px;
            display: flex;
            align-items: center;
        }

        .imgBx .reaching h4 {
            font-size: 13px;
            font-weight: bold;
            color: #fff;
        }

        .imgBx .reaching h4 small {
            font-size: 11px;
            font-weight: 500;
            color: #fff;
            display: block;
            margin-bottom: 6px;
        } */


        .reaching {
            position: absolute;
            bottom: -52px;
            border-bottom-left-radius: 24px;
            border-bottom-right-radius: 24px;
            width: 110px;
            height: 52px;
            padding-left: 18px;
            display: flex;
            align-items: center;
            left: -1px;
            padding-top: 10px;
        }

        .reaching h4 {
            font-size: 13px;
            font-weight: bold;
            color: #fff;
        }

        .reaching h4 small {
            font-size: 11px;
            font-weight: 500;
            color: #fff;
            display: block;
            margin-bottom: 4px;
            /*6px*/
        }



        /* .chat {
            background-color: var(--warning);
            border-top-left-radius: 22px;
            border-bottom-left-radius: 22px;
            position: absolute;
            bottom: 200px;
            right: 0;
            font-size: 13px;
            font-weight: 600;
            color: #1c1d20;
            padding: 12px 14px;
        } */


        .modal-backdrop.show {
            -webkit-backdrop-filter: blur(20px);
            backdrop-filter: blur(20px);
            background-color: rgba(28, 29, 32, 0.2);
            opacity: 1;
        }

        body.disable-modal-styles .modal-backdrop.show {
            -webkit-backdrop-filter: none;
            backdrop-filter: none;
            background-color: transparent;
            opacity: 0;
        }

        .modal-content {
            border-radius: 24px;
        }

        .modal-body {
            padding: 24px;
        }

        .modal-body p {
            font-size: 16px;
            font-weight: 600;
            color: #545557;
        }

        .modal-body h5 {
            font-size: 21px;
            font-weight: 500;
            color: #1c1d20;
            margin-bottom: 18px;
        }

        .modal-body h6 {
            font-size: 16px;
            font-weight: 500;
            color: #545557;
            margin-bottom: 36px;
            line-height: 26px;
        }


        .list li {
            font-size: 16px;
            font-weight: 500;
            color: #545557;
            padding: 10px 0;
        }

        .btn-cst {
            height: 58px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 8px;
        }

        .offWhite {
            color: #f9f9f9;
        }

        .buttons {
            display: flex;
            justify-content: space-evenly;
        }

        .bg-dark {
            background: #0baa60 !important;
        }

        .bg-success {
            background: var(--success) !important;
        }


        /* Styles for badges */
        .badge {
            display: inline-block;
            padding: 0.35em 0.65em;
            font-size: 0.75em;
            font-weight: 700;
            line-height: 1;
            color: #4a36ec;
            text-align: center;
            white-space: nowrap;
            vertical-align: baseline;
            border-radius: 0.25rem;
        }

        .badge:empty {
            display: none;
        }

        /* Styles for badges within buttons */
        .btn .badge {
            position: relative;
            top: -1px;
        }

        /* Styles for alerts */
        .alert {
            position: relative;
            padding: 1rem 1rem;
            margin-bottom: 1rem;
            border: 1px solid transparent;
            border-radius: 0.25rem;
        }

        /* p {
            margin: 0;
        } */

        /* The Modal (background) */
        .modal-driverImage {
            display: none;
            position: relative;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1;
            padding: 20px;

        }

        .btn-close1 {
            background-color: transparent;
            border: 0;
            font-size: 20px;
            cursor: pointer;
            position: absolute;
            right: 2px;
            top: 2px;
            border-radius: 50%;
            transition: all 0.2s ease-in;
        }

        .btn-close1:hover {
            opacity: 0.7;
            background-color: lightgray;
        }

        /* The Close Button */
        .close {
            position: absolute;
            top: 10px;
            right: 10px;
            color: white;
            font-size: 30px;
            cursor: pointer;
        }

        .close:hover,
        .close:focus {
            color: #bbb;
            text-decoration: none;
            cursor: pointer;
        }



        .sidenav {
            height: 100%;
            width: 0;
            position: fixed;
            z-index: 1024;
            top: 0;
            right: 0;
            background-color: #fff;
            overflow-x: hidden;
            transition: 0.5s;
            padding-top: 60px;
        }


        .sidenav a {
            border-width: 1px 0 1px 0;
            border-color: rgb(0, 0, 0);
            border-style: solid;
            padding: 8px 8px 8px 32px;
            text-decoration: none;
            font-size: 15px;
            font-family: Poppins;
            color: #818181;
            display: block;
            transition: 0.3s;
        }

        .sidenav a:hover {
            color: #000000;
        }

        .sidenav .closebtn {
            border-radius: 50%;
            padding: 0.5em;
            margin-top: 2%;
            width: 15px;
            height: 15px;
            border: 1px solid #1b1b1c;
            color: #f01c1c;
            font-weight: bold;
            position: absolute;
            top: 0;
            text-align: center;
            left: 0px;
            font-size: 12px;
            margin-right: 50px;
            margin-left: 2%;
        }

        .sidenav .closebtn:hover {
            border: 1px solid blue;
            background-color: yellow;
            color: #ffffff;
        }

        .sidenav .closebtn::before {
            content: " ";
            position: absolute;
            display: block;
            width: 2px;
            left: 12px;
            top: 5px;
            bottom: 5px;
            transform: rotate(45deg);
        }

        @media screen and (max-height: 450px) {
            .sidenav {
                padding-top: 15px;
            }

            .sidenav a {
                font-size: 18px;
            }
        }



        center {
            font-size: 150px;
            animation: fadeIn 15s;
        }

        @keyframes center {
            0% {
                opacity: 0;
            }

            100% {
                opacity: 1;
            }
        }


        /* New Css */

        .offcanvas-custom {
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            border-bottom-right-radius: 20px;
            border-bottom-left-radius: 20px;
            border: 0;
            height: 95%;
            /* width: calc(100% - 40px); */
            display: flex;
            align-self: center;
            justify-content: center;
            /* margin-left: 20px;
            margin-bottom: 40px; */
        }

        /* body.offcanvas-open {
            overflow: hidden;
            position: fixed;
        } */

        .offcanvas-open .offcanvas {
            overflow-y: hidden;
            -webkit-overflow-scrolling: touch;
        }

        .offcanvas-header-custom {
            /* justify-content: flex-start; */
            background-color: #f0f0f0;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
        }

        .offcanvas-header-custom h5 {
            font-size: 18px;
            font-weight: bold;
            text-overflow: ellipsis;
            width: 90%;
        }

        .offcanvas-header-custom h5 small {
            display: block;
            font-size: 11px;
            font-weight: 500;
            margin-top: 4px;
        }

        .offcanvas-footer {
            position: relative;
            padding: 8px 16px 8px 16px;
            background: #f0e7de;
        }

        .offcanvas-footer input {
            height: 50px;
            width: 100%;
            border: 1px solid #dddddd;
            border-radius: 25px;
            padding: 0 80px 0 16px;
        }

        .offcanvas-footer input::placeholder {
            font-size: 13px;
        }

        .offcanvas-footer img {
            position: absolute;
            z-index: 9;
            top: 50%;
            right: 12px;
            transform: translateY(24%);
        }

        .chats {
            padding: 12px 16px;
            margin-bottom: 6px;
            border-radius: 20px;
            width: fit-content;
            word-wrap: break-word;
        }

        .chats.recevier {
            background-color: #ffffff;
            float: left;
            clear: both;
        }

        .chats.sender {
            background-color: #e7ffdb;
            float: right;
            clear: both;
        }



        .offcanvas-header-custom .btn-left {
            background: transparent url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%23000'%3e%3cpath d='M12 8a.5.5 0 0 1-.5.5H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H11.5a.5.5 0 0 1 .5.5z'/%3E%3C/svg%3E");
            box-sizing: content-box;
            width: 1.4em;
            height: 1.4em;
            padding: 0.25em 0.25em;
            color: #000;
            border: 0;
            border-radius: 0.25rem;
            opacity: 0.8;
        }

        .offcanvas-header-custom .btn-left {
            padding: 0.5rem 0.5rem;
            margin-top: -0.5rem;
            margin-right: -0.5rem;
            margin-bottom: -0.5rem;
        }

        .scroller {
            background: #f0e7de;
            overflow: auto;
            height: 100px;
            display: flex;
            flex-direction: column-reverse;
            -webkit-overflow-scrolling: touch;

        }

        html {
            position: static;
            overflow-y: hidden;
            height: 100%;
            max-height: 100%;
        }

        body {
            overflow: hidden;
            height: 100%;
            max-height: 100%;
        }

        ::-webkit-scrollbar {
            height: 5px;
            width: 5px;
        }

        ::-webkit-scrollbar-track {
            border-radius: 0;
            box-shadow: inset 0 0 1px rgba(0, 0, 0, 0.3);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 0;
        }

        ::-webkit-scrollbar-thumb:window-inactive {
            background: rgba(0, 0, 0, 0.3);
        }

        .scroller .scroller-content .item {
            height: 20px;
            transform: translateZ(0);
            transform: translate3d(0, 0, 0);
            z-index: 1030;
            overflow-y: auto;
            overscroll-behavior: contain;
            -webkit-overflow-scrolling: touch;
            overflow: scroll;
            /* fixes a bug in Safari iOS where the scroller doesn't update */
        }


        .offcanvasTapBtn {
            background-color: transparent !important;
            border: 0 !important;
        }

        .tap_action {
            margin: 0px;
            padding: 16px 30px;
            width: 100%;
            position: fixed;
            bottom: 0px;
            border-top-left-radius: 16px;
            border-top-right-radius: 16px;
            /* -webkit-backdrop-filter: blur(20px); */
            /*backdrop-filter: blur(20px);*/
            background-color: rgba(41, 41, 41, 0.6);
        }

        .tap_action small {
            display: block;
            text-align: center;
            margin-top: 10px;
            font-size: 11px;
            font-weight: 600;
            color: var(--white);
        }

        .tap_action a {
            display: block;
            font-size: 11px;
            font-weight: 600;
            color: var(--white);
            text-align: center;
            margin-bottom: 26px;
        }

        .tap_action div {
            width: 32%;
            display: block !important;
            float: left;
        }

        .tap_action button {
            background-color: transparent;
            border: 0;
            width: 100%;
        }

        /* chat */
        /* Reset default margin and padding */
        /* body,
        h1,
        h2,
        h3,
        p,
        ul,
        li {
            margin: 0;
            padding: 0;
            list-style: none;
            
        } */

        /* Set a consistent box-sizing */
        * {
            box-sizing: border-box;
        }

        /* Basic styling for the chat container */
        body,
        html {
            height: 100%;

        }

        #chat-container {
            width: 100%;
            margin: 0 auto;
            flex-direction: column-reverse;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);

        }

        /* Styling for chat messages */
        /* .chat-messages {
            display: flex;
            flex-direction: column-reverse;
            align-items: flex-end;
            max-height: 120vh;
            overflow-y: auto;
            padding: 0 20px;
            border-bottom: 1px solid #ccc;
        } */

        /* Styling for individual chat messages */
        .message-bubble {
            color: #000;
            border-radius: 10px;
            padding: 10px 15px;
            max-width: 50%;
            word-wrap: break-word;
            margin-top: 8px;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
        }

        /* #message-input {
            width: 82%;
            padding: 10px;

        } */

        /* #send-button {
            width: 60px;
            height: 60px;
            padding: 0;
            background-color: #FFBD21; 
            color: white;
            border: none;
            border-radius: 70%;
            margin-top: 1px;
            cursor: pointer;
            float: right;

        } */

        .send-button img {
            width: 40%;
            height: 40%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #loader {
            animation: animate 1.5s linear infinite;
            clip: rect(0, 80px, 80px, 40px);
            height: 80px;
            width: 80px;
            position: absolute;
            left: calc(50% - 40px);
            top: calc(50% - 40px);
        }

        @keyframes animate {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(220deg);
            }
        }

        #loader:after {
            animation: animate2 1.5s ease-in-out infinite;
            clip: rect(0, 80px, 80px, 40px);
            content: '';
            border-radius: 50%;
            height: 80px;
            width: 80px;
            position: absolute;
        }

        @keyframes animate2 {
            0% {
                box-shadow: inset #d12222 0 0 0 17px;
                transform: rotate(-140deg);
            }

            50% {
                box-shadow: inset #dc5b5b 0 0 0 2px;
            }

            100% {
                box-shadow: inset #712929 0 0 0 17px;
                transform: rotate(140deg);
            }
        }

        /* Common styles for sent and received messages */
        .message {
            margin-top: 5px;
            max-width: fit-content;
            border-radius: 10px;
            padding: 10px 15px;
            max-width: 50%;
            word-wrap: break-word;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
        }

        .sent {
            background-color: #DCF8C6;
            align-self: flex-end;
            margin-left: auto;
        }

        .received {
            background-color: #F5F5F5;
            align-self: flex-start;
            color: #000;
        }

        .timestamp {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
            text-align: right;
        }

        .call_action {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 20px;
            padding: 16px 30px;
            width: calc(100% - 40px);
            position: fixed;
            bottom: 0px;
            border-radius: 16px;
            -webkit-backdrop-filter: blur(20px);
            backdrop-filter: blur(20px);
            background-color: rgba(41, 41, 41, 0.6);

        }

        /* chat */

        /*scrollable text messages*/
        .scrollable-tabs-container {
            background: #f0e7de;
            max-width: 700px;
            margin: 5px auto;
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        .scrollable-tabs-container svg {
            width: 24px;
            height: 24px;
            padding: 8px;
            cursor: pointer;
            color: #fff;
            border-radius: 50%;
            pointer-events: auto;
        }

        .scrollable-tabs-container ul {
            display: flex;
            gap: 16px;
            padding: 12px 12px;
            margin: 0;
            list-style: none;
            overflow-x: scroll;
            -ms-overflow-style: none;
            scrollbar-width: none;
            scroll-behavior: smooth;
        }

        .scrollable-tabs-container ul.dragging a {
            pointer-events: none;
        }

        .scrollable-tabs-container ul.dragging {
            scroll-behavior: auto;
        }

        .scrollable-tabs-container ul::-webkit-scrollbar {
            display: none;
        }

        .scrollable-tabs-container a {
            color: #fff;
            text-decoration: none;
            background: #8DB5F7;
            padding: 4px 24px;
            display: inline-block;
            border-radius: 20px;
            user-select: none;
            width: 300px;
        }

        .scrollable-tabs-container a.active {
            background: #fff;
            color: #000;
        }

        .scrollable-tabs-container .right-arrow,
        .scrollable-tabs-container .left-arrow {
            position: absolute;
            height: 100%;
            width: 100px;
            top: 0;
            display: none;
            align-items: center;
            padding: 0 10px;
            pointer-events: none;
        }

        .scrollable-tabs-container .right-arrow.active,
        .scrollable-tabs-container .left-arrow.active {
            display: flex;
        }

        .scrollable-tabs-container .right-arrow {
            right: 0;
            justify-content: flex-end;
        }

        .scrollable-tabs-container .left-arrow {}

        .scrollable-tabs-container svg:hover {
            background: #fff;
        }

        /*scrollable text messages*/

        .modal-body.share-body {
            margin: 0px;
            padding: 16px 30px;
            width: 100%;
            position: fixed;
            bottom: 0px;
            -webkit-backdrop-filter: blur(20px);
            backdrop-filter: blur(0px);
        }

        .modal-body.share-body small {
            display: block;
            text-align: center;
            margin-top: 10px;
            font-size: 11px;
            font-weight: 600;
            color: var(--white);
        }

        .modal-body.share-body a {
            display: block;
            font-size: 11px;
            font-weight: 600;
            color: var(--white);
            text-align: center;
            margin-bottom: 26px;
        }

        .modal-body.share-body div {
            width: 32%;
            display: block !important;
            float: left;
        }

        .modal-body.share-body button {
            background-color: transparent;
            border: 0;
            width: 100%;
        }

        .modal-body.share-body img {
            width: 60px;
            height: 60px;
        }

        /* Container for positioning */
        .popup-container {
            display: flex;
            justify-content: center;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* Allows clicks to pass through */
        }

        /* Popup styling */
        .popup {
            background-color: #f3f3f3;
            margin: auto; /* Helps with centering in IE11 */
            box-shadow: 0 2px 6px rgba(0,0,0,.3);
            width: auto; /* Adjust based on content */
            min-width: 300px; /* Minimum width */
            max-width: 600px; /* Maximum width */
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            pointer-events: auto; /* Enables clicks on the popup */
        }
    </style>



  </head>

  <body class="offcanvas-open">

    <script src="https://www.gstatic.com/firebasejs/8.2.9/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.2.9/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.2.9/firebase-messaging.js"></script>
    <!-- <script src="app.js"></script> -->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Turf.js/6.5.0/turf.min.js"
        integrity="sha512-Q7HOppxoH0L2M7hreVoFCtUZimR2YaY0fBewIYzkCgmNtgOOZ5IgMNYxHgfps0qrO1ef5m7L1FeHrhXlq1I9HA=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    
    

    
    <div id="notifier" class="center" style="position:fixed;
        top: 10%;
        left: 50%;
        width:24em;
        height:18em;
        display: none;
        margin-top: -9em; /*set to a negative number 1/2 of your height*/
        margin-left: -12em; /*set to a negative number 1/2 of your width*/
        border: 1px solid #ffffff;
        background-color: #ffffff;">
        <p style="text-align:center;font-family:Poppins">Cab live tracking is not available currently,<br> as you have
            already been marked as boarded/No-Show.</p>
        
    </div>
    <div class="container2">
        <div id="output"></div>
    </div>
    <div id="map">
    </div>


    <!-- First Modal -->
    <div class="modal fade" id="firstModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-body">
                    <p>IMPORTANT protocols to follow at Accenture if you are unwell or a close contact of a Coronavirus
                        positive individual.</p>

                    <ul class="list my-3" id="modal-list">
                        <li>Stay home if you are unwell.</li>
                        <li>Seek medical advice if you have a fever, cold, headache, cough or other flu-like symptoms.
                            Contact ASOC at +91 80 71641777 / 080 69541777 . Inform your supervisor/ HR representative
                            immediately</li>
                        <li>DO NOT return to office until you have been notified through e-mail by your HR
                            Representative that you can do so</li>
                    </ul>

                    <p>Regards, India Accenture Workplace Solutions</p>

                    <div class="d-grid"><button type="button" class="btn btn-dark btn-cst offWhite mt-4"
                            data-bs-toggle="modal" data-bs-target="#secondModal" data-bs-dismiss="modal">OK</button>
                    </div>

                </div>
            </div>
        </div>
    </div>
    <!-- First Modal -->

    <!-- Second Modal -->
    <div class="modal fade" id="secondModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" id="modal-dialog2">
            <div class="modal-content">
                <div class="modal-body">

                    <div class="d-block text-center">
                        <p>New Features in eTMS Buddy</p>
                        <img src="images/logo.svg" alt="">
                    </div>

                    <ul class="list">
                        <li><strong class="d-block">Cab users can mark themselves as "no-show" </strong>
                            If you've missed cancelling your scheduled ride for day, you can now mark yourself as
                            "no-show" on the "Where is my cab" tab. You no longer have to wait for the transport
                            helpdesk to call you.</li>

                        <li><strong class="d-block">Check the boarding status of fellow passengers </strong>
                            You will now be able to check the boarding status of your fellow passengers under the "cab
                            info" tab. Use this feature to get real-time updates on scheduled pick-ups.</li>
                    </ul>

                    <div class="d-grid"><button type="button" class="btn btn-dark btn-cst mt-4 offWhite"
                            data-bs-dismiss="modal">OK</button></div>

                </div>
            </div>
        </div>
    </div>
    <!-- Second Modal -->

    <div class="popup-container" id="popupLocationNotAccessible">
        <div class="popup">
            Your Cab's current location cannot be determined as we do not seem to be receiving data from the Driver's mobile.
            Please contact the Driver to know his exact location.
        </div>
    </div>

    <!-- Driver and Guard Info Box -->

    <div id="main" class="driverBx">
        <img src="images/logo_icon.svg" class="logo_icon" alt="">
        <div id="carouselExampleIndicators" class="carousel slide" data-bs-ride="carousel" data-bs-interval="false">
            <div class="carousel-indicators" id="carousel-indicators">
                <button type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide-to="0" class="active"
                    aria-current="true" aria-label="Slide 1" id="carousel-inner"></button>
                <button type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide-to="1"
                    aria-label="Slide 2" id="carousel-item"></button>
            </div>
            <div class="reaching bg-success" id="etaDiv">
                <h4 id="eta"></h4>


            </div>

            <div class="carousel-inner" id="carousel-inner">
                <div class="carousel-item active">
                    <div class="DetalBx">
                        <div class="imgBx">
                            <img id="imageDriver" height="148px" width="110px" alt="Driver's Image" style="border-top-left-radius: 24px;" onerror="this.onerror=null; this.src='images/no_driver.png'"/>
                        </div>
                        <div class="personDetalBx">
                            <span class="badge rounded-pill driver_badge">Driver</span>
                            <h2 id="tdName">
                            </h2>
                            <h3>
                                <table>
                                    <tr>
                                        <td style="text-transform: uppercase;" id="tdVehicleType"></td>
                                        <td>&nbsp;|&nbsp;</td>
                                        <td id="tdRegistrationNo"></td>
                                    </tr>
                                </table>
                            </h3>
                            <span class="badge rounded-pill otp" id="Otp" style="display:none;">
                            </span>
                            <span class="badge rounded-pill otp" id="boardingStatus" style="display:none;">
                            </span>

                        </div>
                    </div>

                </div>
                <div class="carousel-item" id="carousel-item1">
                    <div class="DetalBx" id="carousel-item1">
                        <div class="imgBxGuard">
                            <img id="imageGuard" height="148px" width="110px" style="border-top-left-radius: 24px;" alt="Guard's Image" onerror="this.onerror=null; this.src='images/no_guard.png'"/>
                        </div>
                        <div class="personDetalBx">
                            <span class="badge rounded-pill driver_badge">Guard</span>
                            <h2 id="guardName"></h2>
                            <h3 id="escortId"></h3>
                            <!-- <span class="badge rounded-pill otp"> -->
                            </span>
                        </div>
                    </div>

                </div>
            </div>
        </div>

    </div>

    <!-- Driver and Guard Info Box -->

    <div id="callAction" data-bs-toggle="offcanvas" data-bs-target="#offcanvasBottom1"
    aria-controls="offcanvasBottom1">
        <span class="call_action text-center d-block" >
            <a href="#!" class="fs-3" id="">Tap For Options</a>
        </span>
    </div>
    <div class="offcanvas offcanvas-bottom offcanvasTapBtn" tabindex="-1" id="offcanvasBottom1"
        aria-labelledby="offcanvasBottomLabel">
        <div class="tap_action">

            <div>
                <button id="selfNoShowButton">
                    <a href="#!" data-bs-toggle="modal" data-bs-target="#noShowModal" data-bs-dismiss="offcanvas">
                        <img src="images/icon1.png" alt="">
                        <small>Self No Show</small>
                    </a>
                </button>
            </div>


            <div id="help_btn">
                <button id="helpButton">
                    <a href="#!" id="aTag" data-bs-dismiss="offcanvas"  >
                        <img src="images/icon4.png" alt="">
                        <small>Call Helpdesk</small>
                    </a>
                </button>
            </div>

            <div>
                <button id="callButton">
                    <a id="driver" data-bs-dismiss="offcanvas">
                        <img src="images/icon3.png" alt="">
                        <small>Call Driver</small>
                    </a>
                </button>
            </div>

            <div>
                <button id="shareButton">
                    <a href="#!"  data-bs-toggle="modal"  data-bs-dismiss="offcanvas" data-bs-target="#exampleModal">
                        <img src="images/icon5.png" alt="">
                        <small>Share My Trip</small>
                    </a>
                </button>
            </div>

            <div class="icon-container" >
                <button id="chatButton">
                    <a href="#!" data-bs-toggle="offcanvas" data-bs-target="#chatBox" >
                        <img src="images/icon6.png" alt="">
                        <small>Chat</small>
                    </a>
                </button>
            </div>

            <div>
                <button id="cabNoShowButton">
                    <a href="#!" data-bs-dismiss="offcanvas">
                        <img src="images/icon2.png" alt="">
                        <small>Cab No Show</small>
                    </a>
                </button>
            </div>

        </div>
    </div>

    <div class="offcanvas offcanvas-custom offcanvas-bottom " tabindex="-1" id="chatBox"
        aria-labelledby="offcanvasBottomLabel" id="offcanvasExample">
        <div class="offcanvas-header offcanvas-header-custom">
            <div class="d-flex justify-content-start align-items-center">
                <button type="button" class="btn-left me-3" data-bs-dismiss="offcanvas" aria-label="Close"></button>
                <div class="d-flex justifiy-content-center align-items-center">
                    <div>
                        <img id="imageDriver1" src="" height="53px" width="53px" alt="Driver's Image" style="border-radius: 50%;"/>
                    </div>
                    <h5 class="ms-3">
                        <div id="tdName1"></div><small>
                            <table>
                                <tr>
                                    <td id="tdVehicleType1"></td>
                                    <td>&nbsp;|&nbsp;</td>
                                    <td id="tdRegistrationNo1"></td>
                                </tr>
                            </table>
                        </small>
                    </h5>
                </div>
            </div>
            <!-- <div class="d-flex justify-content-end">
                <button class="btn" id="dropDown" data-bs-toggle="dropdown" aria-expanded="false">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor"
                        class="bi bi-three-dots-vertical" viewBox="0 0 16 16">
                        <path
                            d="M9.5 13a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z" />
                    </svg>
                </button>
                <div class="dropdown-menu" aria-labelledby="dropDown">
                    <a class="dropdown-item" href="#" id="shareLocation">
                        <img src="images/location_icon.png" alt="location" width="24" height="24">
                        Share Location
                    </a>

                </div>
            </div> -->

        </div>
        <div class="offcanvas-body small scroller">
            <div class="scroller-content">
                <div id="chat-messages"></div>
            </div>
        </div>


        <div class="offcanvas-footer">
            <div class="scrollable-tabs-container">
                <div class="left-arrow">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                        stroke="currentColor" class="w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
                    </svg>
                </div>
                <div id="chat-messages1-div">
                    <ul id="chat-messages1">
                    </ul>
                </div>
                <div class="right-arrow active">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                        stroke="currentColor" class="w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" />
                    </svg>
                </div>
            </div>
            <input class="chatInput" id="message-input" placeholder="Enter Message..." type="text"
                autocomplete="off" oninput="validateInput(this)"></input>
            <img src="images/send_button_1.png" alt="" id="send-button">
        </div>

    </div>

    <!-- No Show Modal -->
    <div class="modal fade" id="noShowModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body">

                    <h5>Confirmation</h5>
                    <h6>Are you sure that you want to mark as No-Show for this trip?</h6>

                    <div class="row">
                        <div class="col-6"><button type="button" class="btn w-100 btn-outline-secondary btn-cst"
                                data-bs-dismiss="modal">Cancel</button></div>
                        <div class="col-6" id="selfnoshow"><button type="button" class="btn w-100 btn-danger btn-cst"
                                data-bs-dismiss="modal">OK</button></div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- No Show Modal -->

    <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div onclick="share()">
                        <a href="#!">
                            <img src="images/whatsapp.png" alt="WhatsApp">
                            <small>Share through WhatsApp</small>
                        </a>
                    </div>
                    <div onclick="share1()">
                        <a href="#!">
                            <img src="images/messaging_icon.png" alt="Messaging Icon">
                            <small>Share through message</small>
                        </a>
                    </div>
                </div>
                <div class="modal-footer">

                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="imageDriver" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div>
                        <p>Hello World</p>
                    </div>
                </div>
                <div class="modal-footer">

                </div>
            </div>
        </div>
    </div>

    <div class="text_version">1.10.00</div>


    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script src="js/bootstrap.bundle.min.js"></script>
    
    <script>

        function ajaxRequest(url, data, callback, method, username, password) {
            const ajaxOptions = {
                type: method,
                url: url,
                cache: false,
                crossDomain: true,
                data: method === "GET" ? data : JSON.stringify(data),
                contentType: method === "GET" ? undefined : "application/json; charset=utf-8",
                dataType: "json",
                success: callback,
                failure: function (response) {
                    alert(response.d);
                    console.error("Failure:", response.d);
                },
                error: function (response) {
                    alert(response.d);
                    console.error("Error:", response.d);
                }
            };

            // Add username and password if provided
            if (username && password) {
                ajaxOptions.username = username;
                ajaxOptions.password = password;
            }

            $.ajax(ajaxOptions);
        }

        

        // Helper function to wrap ajaxRequest in a Promise
        function ajaxRequestPromise(url, data, method, username, password) {
            return new Promise((resolve, reject) => {
                ajaxRequest(url, data, resolve, method, username, password);
            });
        }


        
        var BASE_URL;
        var URL_CabValidation;
        var URL_ProfilePicture;
        var URL_CallingApi;
        var URL_RouteInfo;
        var URL_RouteDetail;
        var URL_GetGpsLogger;
        var URL_UpdateCabNoShow;
        var URL_UpdateTrackingSelf;

        var directionsService;
        var distanceMatrixService;
        var directionsRenderer;
        var value;
        var value1;
        var vs;
        var routeid;
        var empid;
        var clientid;
        var locupdate;
        var showMapUpdate;
        var facility;
        var cabnoshowradius;
        var driver_contact = [];
        var driver_contact1;
        var empname;
        var emp_contact;
        var homelatlng;
        var profileurl;
        var EscortImage;
        var driverName;
        var vehicleRegNo = [];
        var vehicleType;
        var tptContactNo;
        var b2bFlag = 1;
        var emplatlng1;
        var emplatlng;
        var pp = [];
        var myTrackingStatus = '';
        var isproximity = 1;
        var eta = '';
        var b2bflag = 1;
        var url = [];
        var fromloc;
        //var fromloc = '77.087353,28.462420';
        var toloc = '';
        var OTP;
        var map = null;
        var gender;
        var tripType;
        var employeeid;
        var poly = [];
        var decorator;
        var line;
        var interval = 0;
        var first = true;
        var first1 = true;
        var driverlat; var driverlng
        var position = [];
        var googleMap;
        var nbMap;
        var mmiMap;
        var marker;
        var marker3;
        var nbMarker;
        var heading = [];
        var driverMarker;
        var driverMarkerMmi;
        let path = [];
        var newPosition;
        var mNewPosition = [];
        
        
        const firstModal = document.getElementById('firstModal');
        const secondModal = document.getElementById('secondModal');
        const cabNoShowButton = document.getElementById('cabNoShowButton');
        const chatButton = document.getElementById('chatButton');
        const shareButton = document.getElementById('shareButton');
        const callButton = document.getElementById('callButton');
        const helpButton = document.getElementById('helpButton');
        const selfNoShowButton = document.getElementById('selfNoShowButton');
        const carouselIndicators = document.getElementById('carousel-indicators');
        const carouselItem1 = document.getElementById('carousel-item1');
        const escortId = document.getElementById('escortId')
        const guardName = document.getElementById('guardName');
        const tdName = document.getElementById('tdName');
        const tdName1 = document.getElementById('tdName1');
        const tdRegistrationNo = document.getElementById('tdRegistrationNo');
        const tdRegistrationNo1 = document.getElementById('tdRegistrationNo1');
        const tdVacStatus = document.getElementById('tdVacStatus');
        const tdVacStatus1 = document.getElementById('tdVacStatus1');
        const tdVehicleType = document.getElementById('tdVehicleType');
        const tdVehicleType1 = document.getElementById('tdVehicleType1');
        const imageDriver = document.getElementById('imageDriver');
        const imageDriver1 = document.getElementById('imageDriver1');
        const imageGuard = document.getElementById('imageGuard');
        const boardingStatus = document.getElementById('boardingStatus');
        const Otp = document.getElementById('Otp');
        const etaDiv = document.getElementById('etaDiv');
        const offCanvasBottom = document.getElementById('offCanvasBottom1');
        const chatBox = document.getElementById('chatBox');
        const callAction = document.getElementById('callAction');
        const popupLocationNotAccessible = document.getElementById('popupLocationNotAccessible');
                    
        document.addEventListener('DOMContentLoaded', function(){
            getRouteDetailsFromQueryString();
            startRouteDetUpdates();
            
        });
        // document.addEventListener("load", function(){
            
        // });

        

        function checkForAccenture(clientid, appwimc){
            if ((clientid == '4' || clientid == '14' || clientid == '13' || clientid == '15' || clientid == '10' || clientid == '25' || clientid == '26' || clientid == '22') && (appwimc == 0)) {
                $('#firstModal').modal('show');
                // firstModal.style.display = 'block';
                cabNoShowButton.style.display = 'block';
                chatButton.style.display = 'block';
                return;
            }
            
            firstModal.style.display = 'none';
            cabNoShowButton.style.display = 'block';
            chatButton.style.display = 'block';
            selfNoShowButton.style.display = 'block';
            return;
        }

        function getQueryStringValue(key) {
            return unescape(
                window.location.search.replace(
                    new RegExp(
                        "^(?:.*[&\\?]" +
                        escape(key).replace(/[\.\+\*]/g, "\\$&") +
                        "(?:\\=([^&]*))?)?.*$",
                        "i"
                    ),
                    "$1"
                )
            );
        }

        function getQueryStringValue1(key) {
            return unescape(
                window.location.search.replace(
                    new RegExp(
                        "^(?:.*[&\\?]" +
                        escape(key).replace(/[\.\+\*]/g, "\\$&") +
                        "(?:\\=([^&]*))?)?.*$",
                        "i"
                    ),
                    "$2"
                )
            );
        }

        
        //parses the string to get the value for route id , client id and empid
        //its of the form clientid-routeid-empid
        function getRouteDetailsFromQueryString(){
            value = getQueryStringValue("v");
            console.log("value: ", value);
            value1 = getQueryStringValue("s");
            console.log("value1: ", value1);
            vs = value.substring(4, value.length);
            
            clientid = parseInt(value.substring(0, 4));
            console.log("clientid: ", clientid);

            if (value.length == 25) {
                empid = (value.slice(value.length - 8, value.length));
                routeid = vs.substring(0, vs.length - 8);
                console.log("empid: ", empid);
                console.log("routeid: ", routeid);
            }
            else if (value.length == 24) {
                empid = (value.slice(value.length - 7, value.length));
                routeid = vs.substring(0, vs.length - 7);
                console.log(empid);
                console.log(routeid);
            }
            else if (value.length == 23 || value.length == 21) {
                empid = (value.slice(value.length - 6, value.length));
                routeid = vs.substring(0, vs.length - 6);
                console.log(empid);
                console.log(routeid);
            }
            else if (value.length == 22 || value.length == 20) {
                empid = (value.slice(value.length - 5, value.length));
                routeid = vs.substring(0, vs.length - 5);
                console.log(empid);
                console.log(routeid);
            }
            else if (value.length == 19) {
                empid = (value.slice(value.length - 4, value.length));
                routeid = vs.substring(0, vs.length - 4);
                console.log(empid);
                console.log(routeid);
            }
            var myUrl = window.location.href;
            //alert(myUrl);
            var murl = myUrl.split("&");
            var appwimc = 0;
            var surl;
            if (murl[1] == 'app=1') {
                appwimc = 1;
                surl = murl[2];
            }
            else if (murl[2] == 'app=1') {
                appwimc = 1;
                surl = murl[1];
            }
            else {
                surl = murl[1];
                appwimc = 0;
            }

            console.log("empid: ", empid);

            checkForAccenture(clientid, appwimc);

            fetchGetClientDetailsById(value, value1, clientid);

        }
        
        function arePointsNear(checkPoint, centerPoint, km) {
            var ky = 40000 / 360;
            var kx = Math.cos((Math.PI * centerPoint.lat) / 180.0) * ky;
            var dx = Math.abs(centerPoint.lng - checkPoint.lng) * kx;
            var dy = Math.abs(centerPoint.lat - checkPoint.lat) * ky;
            return Math.sqrt(dx * dx + dy * dy) <= km;
        }

        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(showPosition, showError);
            } else {
                alert("Geolocation is not supported by this browser.");
            }
        }

        function showError(error) {
            switch (error.code) {
                case error.PERMISSION_DENIED:
                    alert("User denied the request for Geolocation.");
                    break;
                case error.POSITION_UNAVAILABLE:
                    alert("Location information is unavailable.");
                    break;
                case error.TIMEOUT:
                    alert("The request to get user location timed out.");
                    break;
                case error.UNKNOWN_ERROR:
                    alert("An unknown error occurred.");
                    break;
            }
        }

        async function showPosition(position) {

            var homelatlng = { lat: position.coords.latitude, lng: position.coords.longitude };
            var n = arePointsNear(homelatlng, emplatlng1, cabnoshowradius);
            if (n == true) {
                var confirmArrived = confirm('Do you want to mark the cab as no-show?');
                if (confirmArrived == true) {
                    const response = await ajaxRequestPromise("URL_UpdateCabNoShow", {"routeid": routeid, "empid": empid, "trackingaction": employeeid, "lat": '0', "lng": '0'}, "POST", null, null);
                    const details  = JSON.parse(response.d);
                    if(details != null){
                        console.log("cabNoShowData: ", details);
                        alert('Thank you for the NO Show alert, we will notify the driver immediately.');
                        cabNoShowButton.style.display = 'none';
                    }  
                }
                else {
                    console.log('cab no show cancelled')
                }
            }
            else {
                alert('Current location does not match pick-up location. Reach pick-up point to confirm Cab as No show. ');
            }
        }

        cabNoShowButton.addEventListener("click", function(event){
            event.preventDefault();
            getLocation();
        });

        function share() {

            var isMobile = {
                Android: function () {
                    return navigator.userAgent.match(/Android/i);
                },
                BlackBerry: function () {
                    return navigator.userAgent.match(/BlackBerry/i);
                },
                iOS: function () {
                    return navigator.userAgent.match(/iPhone|iPad|iPod/i);
                },
                Opera: function () {
                    return navigator.userAgent.match(/Opera Mini/i);
                },
                Windows: function () {
                    return navigator.userAgent.match(/IEMobile/i);
                },
                any: function () {
                    return (
                        isMobile.Android() ||
                        isMobile.BlackBerry() ||
                        isMobile.iOS() ||
                        isMobile.Opera() ||
                        isMobile.Windows()
                    );
                }
            };
            //alert(isMobile)
            if (isMobile.any()) {
                if (gender == 'M') {
                    var url = empname + " wants you to view his cab details. Kindly click on the link below : \n" + myUrl + "&s=s";
                }
                else if (gender == 'F') {
                    var url = empname + " wants you to view her cab details. Kindly click on the link below : \n" + myUrl + "&s=s";
                }
                else {
                    var url = empname + " wants you to view their cab details. Kindly click on the link below : \n" + myUrl + "&s=s";
                }
                var message = encodeURIComponent(url);
                //sharedStat=1;
                var whatsapp_url = "whatsapp://send?text=" + message;
                    window.location.href = whatsapp_url;
                } else {
                    alert("Please share this article in mobile device");
                }
        }

        function share1() {
            var getOS = function () {
                var userAgent = navigator.userAgent || navigator.vendor || window.opera;
                if (
                    userAgent.match(/iPad/i) ||
                    userAgent.match(/iPhone/i) ||
                    userAgent.match(/iPod/i)
                ) {
                    return "iOS";
                } else if (userAgent.match(/Android/i)) {
                    return "Android";
                } else {
                    return "unknown";
                }
            }

            var device = getOS();

            if (gender == 'M') {

                var url = empname + " wants you to view his cab details. Kindly click on the link below : \n" + myUrl + "&s=s";
            }
            else if (gender == 'F') {

                var url = empname + " wants you to view her cab details. Kindly click on the link below : \n" + myUrl + "&s=s";
            }
            else {
                var url = empname + " wants you to view their cab details. Kindly click on the link below : \n" + myUrl + "&s=s";
            }

            var message = encodeURIComponent(url);

            if (device == "iOS") {
                window.location.href = "sms: &body=" + message;
            }

            if (device == "Android") {
                window.location.href = "sms:?body=" + message;
            }
        }

        function secondsToHms(d) {
            d = Number(d);
            var h = Math.floor(d / 3600);
            var m = Math.floor(d % 3600 / 60);
            var s = Math.floor(d % 3600 % 60);

            var hDisplay = "", mDisplay = "", sDisplay = "";
            if (h > 0) {
                if (h == 1) {
                    hDisplay = h + " hr ";
                }
                else {
                    hDisplay = h + " hrs ";
                }
            }
            if (m > 0) {
                if (m == 1) {
                    mDisplay = m + " min ";
                } else {
                    mDisplay = m + " mins ";
                }
            }
            if (s > 0) {
                sDisplay = s + "s";

            }
            if (!(h > 0) && !(m > 0) && s > 0) {
                return "Soon";
            }

            return hDisplay + mDisplay; //+ sDisplay;
        }
        
        async function fetchGetClientDetailsById(value, value1, clientid){
            if(value || value1){
                const response = await ajaxRequestPromise("https://www.etmsdrive.in/appControlRest/api/v1/getClientDetailById", {CID: clientid}, "GET", "user1", "Acc@bang10");
                const details = JSON.parse(response);
                console.log("GetClientDetailByIdData: ", details);

                

                createUrlFromCleintDetails(details[0]);
            }
        }
        
        
        function createUrlFromCleintDetails(data){
            BASE_URL = data.trackurl
            URL_CabValidation = BASE_URL + "MyCabValidation";
            URL_ProfilePicture = data.photourl;
            URL_CallingAPI = BASE_URL + "CallingAPI";
            URL_RouteInfo = BASE_URL + "GetRouteInfoMyCab";
            console.log("URL_RouteInfo: ", URL_RouteInfo)
            URL_RouteDetail = BASE_URL + "GetRouteDetail";
            URL_GetGPSLogger = BASE_URL + "GetGPSLogger";
            URL_UpdateCabNoShow = BASE_URL + 'UpdateCabNoShow';
            URL_UpdateTrackingSelf = BASE_URL + 'UpdateTrackingSelf';

            fetchRouteInfoData();
        }


        async function fetchRouteInfoData(){
            const response = await ajaxRequestPromise(URL_RouteInfo, {RouteId: routeid}, "POST", "user1", "Acc@bang10");
            const details = JSON.parse(response);
            console.log("fetchRouteInfoData: ", details);
            
            displayDetails(details[0]);
        }

        function displayDetails(data){
            if(data.routeID != 'NA'){
                facility = data.facility
                loadMap(facility);
                    console.log("facility: " + facility)
                    if (data.actVehicleStartTime != null && data.actVehicleStartTime != '' && data.actVehicleStartTime != undefined) {

                    }

                    if(data.chatonlyforpwd == '0'){
                        chatButton.style.display = 'block';
                    }
                    else if(data.chatonlyforpwd == '1'){
                        if(data.is_pwd == '1'){
                            chatButton.style.display = 'block';
                        }
                        else{
                            chatButton.style.display = 'none';
                        }
                    }
                    else{
                        chatButton.style.display = 'none';
                    }
            }

            cabnoshowradius = data.cabnoshowradius / 1000;
            driver_contact.push(data.driverContact);
            driver_contact1 = data.driverContact;
            var profileUrl = URL_ProfilePicture + data.driverContact + ".jpeg";
            var guardImage = data.guardphotourl;

            //var profileurl =URL_ProfilePicture
            var p = data.vehicleRegNo;
            if (data.isb2b == "1") {
                b2bFlag = "3";
            } else {
                b2bFlag = "1";
            }
            if (data.guardid == '' || data.guardid == null) {

                console.log('no guard');
                carouselIndicators.style.display = 'none';
                carouselItem1.style.display = 'none';
                // const carousel = document.getElementById('carousel-inner');
                // carousel.setAttribute('data-bs-slide-to', null);
                const carouselExampleIndicators = document.getElementById('carouselExampleIndicators');
                carouselExampleIndicators.setAttribute('data-bs-touch', "false");
                //var carouselInstance = new bootstrap.Carousel(carouselExampleIndicators);
            }
            else {
                console.log('guard');

            }

            driverName = data.driverName;
            vehicleRegNo.push(p);
            vehicleType = data.vehicleType;
            tptContactNo = data.tptContactNo;
            
            guardName.innerText = data.guardname;
            escortId.innerText = data.guardid;

            tdName.innerText = driverName;
            tdName1.innerText = driverName;
            tdRegistrationNo.innerText = vehicleRegNo;
            tdRegistrationNo1.innerText = vehicleRegNo;
            // tdVacStatus.innerText = data.drivervactatus;
            // tdVacStatus1.innerText = data.drivervactatus;
            tdVehicleType.innerText = vehicleType;
            tdVehicleType1.innerText = vehicleType;

            
            document.getElementById("imageDriver").src = profileUrl;
            document.getElementById("imageDriver1").src = profileUrl;
            
            document.getElementById('imageGuard').src = guardImage;
            
            fetchRouteDetailData();
        }

        async function fetchRouteDetailData(){
            const response = await ajaxRequestPromise(URL_RouteDetail, {RouteId: routeid, flag: b2bFlag}, "POST", "user1", "Acc@bang10");
            const details = JSON.parse(response);
            const details1 = details;
            console.log("fetchRouteDetailData: ", details);
            
             
            const filteredData = details.filter(item => (item.id == empid));//|| item.trackingStatus !== "No-Show"
            console.log("filteredData: ", filteredData);
                                
            displayDetails1(filteredData[0], details1);
            
        }

        

        function displayDetails1(data, details){
            console.log('::::::::::>' + data.trackingStatus);
            console.log(data.id);
            console.log(data.tripType);
            console.log(data.empName);

            if(data.id == empid){
                gender = data.Gender;
                console.log(gender);
                employeeid = data.employeeID;
                tripType = data.tripType;


                if ((data.CabNoShow == 0) && (clientid == '10' || clientid == '14' || clientid == '15' || clientid == '22')) {
                    cabNoShowButton.style.display = 'block';
                }
                else {
                    cabNoShowButton.style.display = 'none';
                }

                if (data.tripType == 'D') {
                    cabNoShowButton.style.display = 'none';
                    chatButton.style.display = 'none';
                }

                if (clientid == '10' || clientid == '14' || clientid == '15' || clientid == '22' || clientid == '25') {
                    shareButton.style.display = 'block';
                    
                }
                else {
                    shareButton.style.display = 'none';
                }

                empname = data.empName;
                emp_contact = data.EmpMobile;
                console.log(emp_contact);

                // emplatlng = new L.LatLng(val.lat, val.lng);
                emplatlng1 = { lat: data.lat, lng: data.lng };
                console.log(emplatlng1);


                myTrackingStatus = data.trackingStatus
                if (myTrackingStatus != '----') {
                    boardingStatus.innerHTML = `<h3><strong>${myTrackingStatus.toUpperCase()}</strong></h3>`;
                    boardingStatus.style.display = 'inline-block';
                }
                else {
                    boardingStatus.style.display = 'none';
                    OTP = data.boardingOTP;
                    console.log(OTP);
                    if (OTP != null) {
                        Otp.innerHTML = `<h3><strong>OTP: ${OTP} </strong></h3>`;
                        Otp.style.display = 'inline-block';
                    }
                }

                

                if (myTrackingStatus == "No-Show" || data.tripType == 'D' || facility != 'BDC 10') {
                    callButton.style.display = 'none';
                    helpButton.style.display = 'block';
                    selfNoShowButton.style.display = 'none';
                    chatButton.style.display = 'none';
                    //etaDiv.style.display = 'none';
                    Otp.style.diplay = 'none';
                    //offCanvasBottom.style.display = 'none';
                    chatBox.style.display = 'none';
                } 
                else if (myTrackingStatus == "Boarded" || data.tripType == 'D' || facility != 'BDC 10') {
                    callButton.style.display = 'none';
                    helpButton.style.display = 'block';
                    selfNoShowButton.style.display = 'none';
                    chatButton.style.display = 'none';
                    //etaDiv.style.display = 'none';
                    Otp.style.diplay = 'none';
                    //offCanvasBottom.style.display = 'none';
                    chatBox.style.display = 'none';
                    cabNoShowButton.style.display = 'none';
    
                }
                else if (myTrackingStatus == "De-Boarded" || data.tripType == 'D' || facility != 'BDC 10') {
                    callButton.style.display = 'none';
                    helpButton.style.display = 'block';
                    selfNoShowButton.style.display = 'none';
                    chatButton.style.display = 'none';
                    //etaDiv.style.display = 'none';
                    Otp.style.diplay = 'none';
                    offCanvasBottom.style.display = 'none';
                    chatBox.style.display = 'none';
                    cabNoShowButton.style.display = 'none';
                    
                }
                else {
                    callButton.style.display = 'block';
                    helpButton.style.display = 'block';
                    etaDiv.style.display = 'block';
                    Otp.style.diplay = 'block';
                    
                }

                if (value1 == 's') {
                    callButton.style.display = 'none';
                    helpButton.style.display = 'block';
                    selfNoShowButton.style.display = 'none';
                    chatButton.style.display = 'none';
                    etaDiv.style.display = 'none';
                    Otp.style.diplay = 'none';
                    offCanvasBottom.style.display = 'none';
                    chatBox.style.display = 'none';
                    cabNoShowButton.style.display = 'none';
                    callAction.style.display = 'none';
                    
                }

                var aTag = document.getElementById('aTag');
                aTag.setAttribute('data-rel', 'external');
                aTag.setAttribute('href', 'tel:' + tptContactNo[0]);

                callButton.addEventListener('click', function(event){
                    console.log("driver clicked");
                    callLatch();
                });
                
                function callLatch() {
                    confirm1 = confirm("Do you wish to call the driver?");
                    if (confirm1 == true) {
                        callApi();
                    }
                }

                var lathome = data.lat;
                var lnghome = data.lng;
                
                toloc = data.lat + ',' + data.lng;

                if(true){
                    const currentEmployeeMarker = {
                        url: 'images/home.png', // URL to your custom icon  
                        scaledSize: new window.google.maps.Size(24, 24)
                    };
                    
                    const marker = new google.maps.Marker({
                        position: {lat: data.lat, lng: data.lng},
                        map: googleMap,
                        icon: currentEmployeeMarker,
                    });
                }
                // else if(123){
                //     //custom marker for showing home on the map
                //     const elEmployee = document.createElement("div");
                //     elEmployee.className = "employeeMarker";
                //     elEmployee.style.backgroundImage =
                //         "url('images/home.png')";
                //     elEmployee.style.backgroundSize = "cover";
                //     elEmployee.style.width = "25px";
                //     elEmployee.style.height = "25px";
                //     const currentEmployeeMarkernextbillion = new nextbillion.maps.Marker({
                //         element: elEmployee,
                //     })
                //     .setLngLat({lat: data.lat, lng: data.lng})
                //     .addTo(nbMap.map);
                // }
                else{
                    
                    const currentEmployeeMarker = new L.Marker(new L.LatLng(data.lat, data.lng), {
                        icon: L.icon({
                            iconUrl: "images/home.png",
                            iconSize: [25, 25],
                        })
                    }).addTo(mmiMap);    
                }
                

                fetchGpsLoggerData(details);
            }

        }

        

        async function callApi(){
            const response = await ajaxRequestPromise(URL_CallingAPI, {empid: empid, drivermobile: driver_contact[0], type: "sun"}, "POST", null, null);
            try{
                console.log("API call successfull: ", response);
                console.log("callApiData: ", response);
                alert("Please wait while your call is being connected");
            }
            catch(error){
                console.log("Api call failed: ", error);
            }
            
        }

        async function fetchGpsLoggerData(data){
            const response = await ajaxRequestPromise(URL_GetGPSLogger, {deviceId: routeid, vendorid: 0}, "POST", "user1", "Acc@bang10");
            const details = JSON.parse(response);
            console.log("fetchGpsLoggerData: ", details);
            console.log("response: ", data);
            
            displayDetails2(details[0], data);
            
        }
        
        function initGoogleMap(){
        
            distanceMatrixService = new google.maps.DistanceMatrixService();
            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer({
                suppressMarkers: true,
                suppressInfoWindows: true,
            });
             // The map, centered at the specified location
            googleMap = new google.maps.Map(document.getElementById('map'), {
                styles: [], 
                zoom: 14,
                zoomControl: true,
                zoomControlOptions: {
                    position: google.maps.ControlPosition.Right_CENTER
                },
                panControl: true,
                //VARIOUS GOOGLE MAP OPTIONS WHICH ARE TURNED OFF		 
                mapTypeControl: false,
                scaleControl: false,
                fullscreenControl: false,
                streetViewControl: false
            });
            directionsRenderer.setMap(googleMap);
        }

        function initNextbillionMap() {
            nextbillion.apiKey = "88db710a74e44bf59a27b365912e06bb";
            nbMap = new nextbillion.maps.Map({
                container: document.getElementById('map'),
                zoom: 11,
                style: "https://api.nextbillion.io/maps/openstreetmap/style.json"
            });
        }

        function initMMIMap(){
            mmiMap = new MapmyIndia.Map('map', {
                maxZoom: 20,
                zoomControl: true,
                hybrid: true,
                disableDoubleClickZoom: false,
            });
        }

        
        function displayDetails2(data, details){
            console.log("lat: ", data.lat);
            console.log("lng: ", data.lng);
                var lat = data.lat;
                var lng = data.lng;
                if (lat == null || lat == undefined) {
                    popupLocationNotAccessible.style.display = 'block';
                }
                else{
                    popupLocationNotAccessible.style.display = 'none';
                }
                console.log("null lat" + lat);
                var latlng = [];
                latlng.push(lat);
                latlng.push(lng);
                var lnglat = [];
                lnglat.push(lng);
                lnglat.push(lat);
                fromloc = latlng;
                console.log("fromloc: ", fromloc);
                pp.push(latlng);
                pp.push(latlng);
                driverlat = data.lat;
                driverlng = data.lng;
                position = [driverlat, driverlng];
                //dynamicInterval();

                
                if(true){
                    var car = "M17.402,0H5.643C2.526,0,0,3.467,0,6.584v34.804c0,3.116,2.526,5.644,5.643,5.644h11.759c3.116,0,5.644-2.527,5.644-5.644 V6.584C23.044,3.467,20.518,0,17.402,0z M22.057,14.188v11.665l-2.729,0.351v-4.806L22.057,14.188z M20.625,10.773 c-1.016,3.9-2.219,8.51-2.219,8.51H4.638l-2.222-8.51C2.417,10.773,11.3,7.755,20.625,10.773z M3.748,21.713v4.492l-2.73-0.349 V14.502L3.748,21.713z M1.018,37.938V27.579l2.73,0.343v8.196L1.018,37.938z M2.575,40.882l2.218-3.336h13.771l2.219,3.336H2.575z M19.328,35.805v-7.872l2.729-0.355v10.048L19.328,35.805z"; // SVG FOR THE CAR

                    var car_icon = {
                        path: car,
                        scale: 0.7,
                        strokeColor: "white",
                        strokeWeight: 0.1,
                        fillOpacity: 1,
                        fillColor: "#404040",
                        offset: "5%",
                        anchor: new google.maps.Point(10, 25) // orig 10,50 back of car, 10,0 front of car, 10,25 center of car
                    };
                    
                    driverMarker = {
                        url: "images/car.png",
                        scaledSize: new window.google.maps.Size(28, 28),
                        anchor: {x:14, y:14}
                    };

                    googleMap.setOptions({
                        center: {lat: fromloc[0], lng: fromloc[1]},
                    });
                    
                    marker = new google.maps.Marker({
                        position: {lat: fromloc[0], lng: fromloc[1]},
                        map: googleMap,
                        icon: car_icon,
                        // setRotation: {deg: -90},
                    });

                    // marker3 = new google.maps.Marker({
                    //     position: {lat: fromloc[0], lng: fromloc[1]},
                    //     map: googleMap,
                    //     icon: car_icon,
                    //     easing: "swing"
                    // });
                }
                // else if(123){
                //     // nbMap.setOptions({
                //     //     center: {lat: fromloc[0], lng: fromloc[1]},
                //     // });
                //     nbMap.map.setCenter({
                //         lat: fromloc[0], lng: fromloc[1],
                //     });
                        
                //     const elDriver = document.createElement("div");
                //     elDriver.className = "marker";
                //     elDriver.style.backgroundImage = "url('images/car.png')";
                //     elDriver.style.backgroundSize = "cover";
                //     elDriver.style.width = "40px";
                //     elDriver.style.height = "40px";
                //     nbMarker = new nextbillion.maps.Marker({
                //         element: elDriver,
                //     })
                //     .setLngLat({lat: fromloc[0], lng: fromloc[1]})
                //     .addTo(nbMap.map);
                // }
                else{
                    
                    mmiMap.panTo(new L.LatLng(fromloc[0], fromloc[1]));
                    driverMarkerMmi = L.marker(new L.LatLng(fromloc[0], fromloc[1]), {
                        icon: L.icon({
                            iconUrl: "https://www.mapmyindia.com/api/advanced-maps/doc/sample/images/car.png",
                            iconSize: [18, 38]
                        }), 
                    }).addTo(mmiMap);
                }
            
        }

        function loadMap(facility) {
            if (true) {
                loadGoogleMaps();
            } else{
                //loadNextbillionMaps();
                loadMMIMaps();
            }
        }

        function loadGoogleMaps(){
            loadScript('https://maps.googleapis.com/maps/api/js?libraries=geometry&key=AIzaSyDKatXVfQNHCj7iNP95PhsOkO9vFmYI-bA', function(){
                console.log('Google Maps Api loaded');
                initGoogleMap();
            });
        }

        function loadNextbillionMaps(){
            // Load CSS for NextBillion Maps
            const link = document.createElement('link');
            link.rel = 'stylesheet';
            link.href = 'https://maps-gl.nextbillion.io/maps/v2/api/css';
            document.head.appendChild(link);

            // Load JS for NextBillion Maps
            loadScript('https://maps-gl.nextbillion.io/maps/v2/api/js', function() {
                console.log('NextBillion Maps API loaded.');
                initNextbillionMap();
            });
        }

        function loadMMIMaps(){
            loadScript('https://apis.mapmyindia.com/advancedmaps/v1/fd0b726bc35998059cee40b4d331acf2/map_load?v=1.3&plugin=polylinedecorator,path.drag', function(){
                console.log("MMI Map loaded");
                initMMIMap();
            }); 
        }

        function loadScript(url, callback) {
            const script = document.createElement('script');
            script.src = url;
            script.type = 'text/javascript';
            //script.async = true;
            //script.defer = true;

            script.onload = callback; // Execute callback after the script is loaded
            document.head.appendChild(script);
        }


        
        let etaInterval; // Declare a variable to store the interval ID
        let currentInterval = 2000; // Initial interval time (2 seconds)

        function dynamicInterval() {
            clearInterval(etaInterval); // Clear the previous interval (if any)

            etaInterval = setInterval(function () {
                // Your code to be executed at the dynamic interval
                if ((toloc == "null,null") || (toloc == "0,0") || (toloc == ",") || (toloc == "undefined,undefined") || (toloc == "Nan,Nan") || (clientid == '25') ) {
                    //console.log("toloc");
                    if((clientid == '25')){
                        // if(facility != "KDC 1"){
                        //     $('#eta').show();
		                //     etaDiv.style.display = 'block';
                        //     if(myTrackingStatus == 'Boarded'){
                        //         etaDiv.style.display = 'none';
                        //     }
                        // }
                        // else{
                        //     etaDiv.style.display = 'none';
                        // }
                    }
                    return;
                }
                
                if ((myTrackingStatus == "Boarded" || tripType == 'D') || (myTrackingStatus == "No-Show" || tripType == 'D')) {
                    currentInterval = 10000000;
                }
                else if (first != true) {
                    currentInterval = 120000; // Set a 2-minute interval
                }
                else {
                    currentInterval = 2000;
                    first = false; // Set a 2-second interval (default)
                }
                // Clear and reset the interval with the updated interval time
                clearInterval(etainterval);
                etainterval = setInterval(dynamicInterval, currentInterval);
            }, currentInterval); // Initial interval time
        }

        
        
        async function moveMarker1(){
            const response = await ajaxRequestPromise(URL_GetGPSLogger, {deviceId: routeid, vendorid: 0}, "POST", "user1", "Acc@bang10");
            const details = JSON.parse(response);
            console.log("moveMarkerData: ", details);
            var lastGPSLocation;
            newPosition != null ? lastGPSLocation = newPosition : lastGPSLocation = fromloc;
            newPosition = [details[0].lat, details[0].lng];
            
            console.log("pp1: ", pp);
            transition(lastGPSLocation, newPosition);
            
            if(facility != "BDC 10"){
                if(newPosition[0] != pp[pp.length-1][0]){
                    pp.push(newPosition);
                    pp.shift();
                    driverMarkerMmi.remove();
                    drawCarMarkerOnPolyline(pp);
                }
            }
            
        }

        // function animateMarker(newPosition){
        //     marker.setPosition(newPosition);
        //     googleMap.setCenter(newPosition);
        // }
        
        // setInterval(moveMarker1, 5000);

        var numDeltas = 100;
        var delay = 10; //milliseconds
        var i = 0;
        var deltaLat;
        var deltaLng;
        var capture;
        var position1 = [];
        var result1 = [];
        function transition(lastGPSLocation, result){
            i = 0;
            // position1.push(new google.maps.LatLng(position[0], position[1])); 
            // result1.push(new google.maps.LatLng(result[0], result[1])); 
            // console.log("position1: ", position1);
            // console.log("result1: ", result1);
            deltaLat = (result[0] - position[0])/numDeltas;
            deltaLng = (result[1] - position[1])/numDeltas;
            var p1 = turf.point([result[1], result[0]]);
            var p2 = turf.point([position[1], position[0]]);
            var bearing = turf.bearing(p1, p2);
            
            // if(facility == 'BDC 10'){    
            //     //nbMarker.setRotation(bearing - 90);
            // }
            if(true) {
                var lastGPSLocRotation = { lat: lastGPSLocation[0], lng: lastGPSLocation[1] };
                var currentGPSLocRotation = { lat: result[0], lng: result[1] };
                const bearing = calculateBearing(lastGPSLocRotation, currentGPSLocRotation);
                console.log(":: Bearing" + bearing);
                // Animate the marker to the new location
                if(bearing != 0){
                    animateMarker(marker, lastGPSLocRotation, currentGPSLocRotation, bearing);
                }
                
            }
            else{
                //driverMarker.setRotation(bearing - 90);
                
                
            }
            
        }

        function drawCarMarkerOnPolyline(newPosition){
            mmiMap.panTo(new L.LatLng(newPosition[0][0], newPosition[0][1]));
            removePolyline();
            
            var offset = 0;
            var w = 18, h = 38;

            //Polyline css
            var linecss = {
                color: 'transparent',
                weight: 3,
                opacity: 1,
            }
            console.log("pp: ", pp);
            line = new L.polyline(pp, linecss).addTo(mmiMap);
            decorator = new L.polylineDecorator(line).addTo(mmiMap);

            interval = window.setInterval(function(){
                decorator.setPatterns([{
                    offset: offset + '%',
                    repeat: 0,
                    symbol: L.Symbol.marker({
                        rotate: true,
                        markerOptions: {
                            icon: L.icon({
                                iconUrl: 'https://www.mapmyindia.com/api/advanced-maps/doc/sample/images/car.png',
                                iconAnchor: [w/2, h/2],
                                iconSize: [18, 38]
                            })
                        }
                    })
                }]);

                if((offset += 0.33) > 100){
                    offset = 0;
                }
            }, 18);

            poly.push(line);
            poly.push(decorator);
        }

        var removePolyline = function () {
            var polylength = poly.length;
            if (polylength > 0) {
                for (var i = 0; i < polylength; i++) {
                    if (poly[i] !== undefined) {
                        mmiMap.removeLayer(poly[i]);
                    }
                }
                poly = new Array();
                window.clearInterval(interval);
            }
        }

        // Divyesh code changes
        function calculateBearing(start, end) {
            const startLat = degreesToRadians(start.lat);
            const startLng = degreesToRadians(start.lng);
            const endLat = degreesToRadians(end.lat);
            const endLng = degreesToRadians(end.lng);

            const dLng = endLng - startLng;
            const y = Math.sin(dLng) * Math.cos(endLat);
            const x = Math.cos(startLat) * Math.sin(endLat) - Math.sin(startLat) * Math.cos(endLat) * Math.cos(dLng);
            const bearing = radiansToDegrees(Math.atan2(y, x));

            return (bearing + 360) % 360; // Normalize to 0-360
        }

        function degreesToRadians(degrees) {
            return degrees * (Math.PI / 180);
        }

        function radiansToDegrees(radians) {
            return radians * (180 / Math.PI);
        }

        

        function animateMarker(marker, start, end, bearing) {
            const animationDuration = 2000; // Duration of the animation in milliseconds
            const frameRate = 60; // Frames per second
            const frameTime = 1000 / frameRate; // Time per frame
            const totalFrames = animationDuration / frameTime;

            let frame = 0;

            const deltaLat = (end.lat - start.lat) / totalFrames;
            const deltaLng = (end.lng - start.lng) / totalFrames;

            function step() {
                if (frame <= totalFrames) {
                    const lat = start.lat + deltaLat * frame;
                    const lng = start.lng + deltaLng * frame;

                    var car = "M17.402,0H5.643C2.526,0,0,3.467,0,6.584v34.804c0,3.116,2.526,5.644,5.643,5.644h11.759c3.116,0,5.644-2.527,5.644-5.644 V6.584C23.044,3.467,20.518,0,17.402,0z M22.057,14.188v11.665l-2.729,0.351v-4.806L22.057,14.188z M20.625,10.773 c-1.016,3.9-2.219,8.51-2.219,8.51H4.638l-2.222-8.51C2.417,10.773,11.3,7.755,20.625,10.773z M3.748,21.713v4.492l-2.73-0.349 V14.502L3.748,21.713z M1.018,37.938V27.579l2.73,0.343v8.196L1.018,37.938z M2.575,40.882l2.218-3.336h13.771l2.219,3.336H2.575z M19.328,35.805v-7.872l2.729-0.355v10.048L19.328,35.805z"; // SVG FOR THE CAR

                    var car_icon = {
                        path: car,
                        scale: 0.7,
                        strokeColor: "white",
                        strokeWeight: 0.1,
                        fillOpacity: 1,
                        rotation: bearing, // Apply the calculated bearing here
                        fillColor: "#404040",
                        offset: "5%",
                        anchor: new google.maps.Point(10, 25) // orig 10,50 back of car, 10,0 front of car, 10,25 center of car
                    };

                    marker.setIcon({
                        path: car,
                        scale: 0.7,
                        strokeColor: "white",
                        strokeWeight: 0.1,
                        fillOpacity: 1,
                        rotation: bearing, // Apply the calculated bearing here
                        fillColor: "#404040",
                        offset: "5%",
                        anchor: new google.maps.Point(10, 25)
                    });
                    marker.setPosition({ lat, lng });

                    frame++;
                    requestAnimationFrame(step);
                }
            }

            step();
        }

        function moveMarker(){
            position[0] += deltaLat;
            position[1] += deltaLng;
            if(true){
                var latlng = new google.maps.LatLng(position[0], position[1]);
                marker.setPosition(latlng);
                //marker3.setPosition(latlng);
            }
            else{
                nbMarker.setLngLat({lat: position[0], lng: position[1]});
            }
            if(i!=numDeltas){
                i++;
                setTimeout(moveMarker, delay);
            }
        }

        document.addEventListener("visibilitychange", () =>{
            if(document.hidden){
                clearInterval(locupdate);
                clearInterval(showMapUpdate);
                
                console.log('IntervalId stopped:');
                
            }
            else{
                startRouteDetUpdates();
            }
        });

        function startRouteDetUpdates() {
            setTimeout(function() {
                calculateEtaAndPlotPath();  // Call Routedet initially after 2 seconds
                

                locupdate = setInterval(calculateEtaAndPlotPath, 60000);
                showMapUpdate = setInterval(moveMarker1, 3000); // Start the interval for marker updates
            }, 3000);
        }


        // document.addEventListener("DOMContentLoaded", function() {
        //     startRouteDetUpdates();
        // });

    
        function addMarkerForEmployeesNotBoarded(stopNo, stopNos){
            if(stopNos.indexOf(stopNo) === 0){
                return;
            }
            else if(stopNos.indexOf(stopNo) > 0){
                pointsToBePlotted = stopNos[stopNos.indexOf(stopNo)] - stopNos[0];
                return pointsToBePlotted;
            }
        }

        function Routedet1(){
            console.log("Routedet1: ");
        }

        function googleDistanceMatrixApi(stopNos, originLatLngs, destinationLatLngs, currentEmployeeStopNo){
            
            const request = {
                origins: originLatLngs,
                destinations: destinationLatLngs,
                travelMode: google.maps.TravelMode.DRIVING,
                unitSystem: google.maps.UnitSystem.METRIC,
                avoidHighways: false,
                avoidTolls: false,
                drivingOptions: {
                    departureTime: new Date(Date.now()),
                }
            }

            distanceMatrixService.getDistanceMatrix(request).then((response) => {
                calculateCumulativeEtaGoogle(response, stopNos, currentEmployeeStopNo);
            })    
            
            // const response = await ajaxRequestPromise1(
            //     "https://maps.googleapis.com/maps/api/distancematrix/json?departure_time=now&destinations=" + encodeURIComponent(destinationLatLngs) + "&origins=" + encodeURIComponent(originLatLngs) + "&key=AIzaSyDKatXVfQNHCj7iNP95PhsOkO9vFmYI-bA",
            //     {}, "GET", null, null
            // );
            // const details = response;
            // console.log("googleDistanceMatrixdata: ", details);

        }

        async function nextbillionDistanceMatrixApi(stopNos, originLatLngs, destinationLatLngs, currentEmployeeStopNo){
            const response = await ajaxRequestPromise(
                "https://api.nextbillion.io/distancematrix/json?origins=" + encodeURIComponent(originLatLngs) + "&destinations=" + encodeURIComponent(destinationLatLngs) + "&mode=car&key=b160a9fc4f294504aaf36990ce9d829d",
                {}, "GET", null, null
            );
            const details = response;
            console.log("nextbillionDistanceMatrixdata: ", details);

            calculateCumulativeEtaNextbillion(details, stopNos, currentEmployeeStopNo);
        }

        function calculateCumulativeEtaGoogle(data, stopNos, currentEmployeeStopNo){
            console.log(data);
            var mappedDurations = data.rows.map((row, index) => {
                if(row.elements.length > index){
                    return row.elements[index].duration_in_traffic.value;
                }else{
                    return null;
                }
            });
            console.log("mappedDurations: ", mappedDurations);

            let totalEta = 0;


            const stopNoIndex = stopNos.indexOf(currentEmployeeStopNo);
            console.log("stopNoIndex: " + stopNoIndex);
            for(let i = 0; i <= stopNoIndex && i < mappedDurations.length; i++){
                totalEta += mappedDurations[i];
            }
                    
            totalEta += (stopNoIndex*0);
            console.log("totalEta: " + totalEta);
            const eta = secondsToHms(totalEta);
            console.log("eta: " + eta);
            document.getElementById('eta').innerHTML = '<small>Reaching in<br></small>' + eta;
            
            
        }

        function calculateCumulativeEtaNextbillion(data, stopNos, currentEmployeeStopNo){
            console.log(data);
            var mappedDurations = data.rows.map((row, index) => {
                if(row.elements.length > index){
                    return row.elements[index].duration.value;
                }else{
                    return null;
                }
            });
            console.log("mappedDurations: ", mappedDurations);

            let totalEta = 0;


            const stopNoIndex = stopNos.indexOf(currentEmployeeStopNo);
            console.log("stopNoIndex: " + stopNoIndex);
            for(let i = 0; i <= stopNoIndex && i < mappedDurations.length; i++){
                totalEta += mappedDurations[i];
            }
                    
            totalEta += (stopNoIndex*0);
            console.log("totalEta: " + totalEta);
            const eta = secondsToHms(totalEta);
            console.log("eta: " + eta);
            document.getElementById('eta').innerHTML = '<small>Reaching in<br></small>' + eta;
            
            
        }

        async function calculateEtaAndPlotPath(){
            if(clientid != '25'){
                return;
            }
            // if(facility != 'KDC 1'){
            //     return;
            // }

            if(myTrackingStatus == 'Boarded'){
                return;
            }
            else{
                console.log("routedetresumed");
            
                const response = await ajaxRequestPromise(URL_RouteDetail, {RouteId: routeid, flag: b2bFlag}, "POST", "user1", "Acc@bang10");
                const details = JSON.parse(response);
                console.log("calculateEtaAndPlotPathData: ", details);
            
                const parsedData = typeof data == "string" ? JSON.parse(details) : details;
                console.log("parsedData: " , parsedData);
                
                const hashMap = new Map();
                parsedData.map(item => hashMap.set(item.id, item.stopNo));
                console.log("hashMap: " , hashMap);
                console.log("empid: " + empid);
                const currentEmployeeStopNo = hashMap.get(parseInt(empid));
                console.log("stopNo: " + currentEmployeeStopNo);


                const filteredData = parsedData.filter(item => (item.trackingStatus == "----" ));//|| item.trackingStatus !== "No-Show"
                console.log("filteredData: " ,filteredData);
                
                
                const currentEmployeeDetails = filteredData.filter(item => (item.stopNo == currentEmployeeStopNo));
                console.log("currentEmployeeDetails: " , currentEmployeeDetails);

                const stopNos = filteredData.map(item => item.stopNo);
                console.log("stopNos: " + stopNos);
                

                const boardedData = parsedData.filter(item => (item.trackingStatus === "Boarded"));
                const stopNosBoarded = boardedData.map(item => item.stopNo);
                console.log("stopNosBoarded: " , stopNosBoarded);
                
                const boardedMarkerData = [];
                
                for(let i=0; i<boardedData.length; i++){
                    const item = boardedData[i];
                    boardedMarkerData.push({
                        lat: item.lat,
                        lng: item.lng,
                        stopNo: item.stopNo,
                    });
                }
                console.log("markerData: " , boardedMarkerData);

                if(true){
                    for(let i=0; i<boardedMarkerData.length; i++) {
                        const markerInfo = boardedMarkerData[i];
                        if(markerInfo.stopNo == currentEmployeeStopNo){
                            continue;
                        }
                        const boardedMarker = {
                            url: `images/boarded/number-${markerInfo.stopNo}.png`, // URL to your custom icon
                            scaledSize: new google.maps.Size(24, 24) // Scaled size of the icon (width, height)
                        };
                        new google.maps.Marker({
                            position: {lat: markerInfo.lat, lng: markerInfo.lng},
                            map:googleMap,
                            icon: boardedMarker,  
                        });
                
                    }
                }
                // else if(123){
                //     for(let i=0; i<boardedMarkerData.length; i++) {
                //         const markerInfo = boardedMarkerData[i];
                //         if(markerInfo.stopNo == currentEmployeeStopNo){
                //             continue;
                //         }
                //         const imagePath = `images/boarded/number-${markerInfo.stopNo}.png`;
                //         const boardedEmployee = document.createElement("div");
                //         boardedEmployee.className = "boardedEmployeeMarker";
                //         boardedEmployee.style.backgroundImage = `url('${imagePath}')`;
                //         boardedEmployee.style.backgroundSize = "cover";
                //         boardedEmployee.style.width = "24px";
                //         boardedEmployee.style.height = "24px";
                //         const boardedEmployeeMarker = new nextbillion.maps.Marker({
                //             element: boardedEmployee,
                //         }).setLngLat({lat: markerInfo.lat, lng: markerInfo.lng})
                //         .addTo(nbMap.map);
                //     }
                // }
                else{
                    for(let i=0; i<boardedMarkerData.length; i++){
                        const markerInfo = boardedMarkerData[i];
                        if(markerInfo.stopNo == currentEmployeeStopNo){
                            continue;
                        }
                        const boardedMarker = L.marker(new L.LatLng(markerInfo.lat, markerInfo.lng), {
                            icon: L.icon({
                                iconUrl: `images/boarded/number-${markerInfo.stopNo}.png`,
                                iconSize: [24, 24],
                            })
                        }).addTo(mmiMap);
                    }
                }
                
                const markerData = [];
                
                for(let i=0; i<filteredData.length; i++){
                    const item = filteredData[i];
                    markerData.push({
                        lat: item.lat,
                        lng: item.lng,
                        stopNo: item.stopNo,
                    });
                }
                console.log("markerData: " , markerData);

                if(true){
                    for(let i=0; i<markerData.length; i++){
                        const markerInfo = markerData[i];
                        if(markerInfo.stopNo == currentEmployeeStopNo){
                            continue;
                        }
                        const notBoardedMarker = {
                            url: `images/not_boarded/number-${markerInfo.stopNo}.png`, // URL to your custom icon
                            scaledSize: new google.maps.Size(24, 24) // Scaled size of the icon (width, height)
                        };
                        new google.maps.Marker({
                            position: {lat: markerInfo.lat, lng: markerInfo.lng},
                            map:googleMap,
                            icon: notBoardedMarker,  
                        });

                    }
                }
                // else if(123){
                //     for(let i=0; i<markerData.length; i++){
                //         const markerInfo = markerData[i];
                //         if(markerInfo.stopNo == currentEmployeeStopNo){
                //             continue;
                //         }
                //         const imagePath = `images/not_boarded/number-${markerInfo.stopNo}.png`;
                //         const elEmployee = document.createElement("div");
                //         elEmployee.className = "employeeMarker";
                //         elEmployee.style.backgroundImage = `url('${imagePath}')`; // Use default 'home.png' or custom icon
                //         elEmployee.style.backgroundSize = "cover";
                //         elEmployee.style.width = "24px";
                //         elEmployee.style.height = "24px";
                //         const employeeMarker = new nextbillion.maps.Marker({
                //             element: elEmployee,
                //         }).setLngLat({lat: markerInfo.lat, lng: markerInfo.lng})
                //         .addTo(nbMap.map);
                //     }
                // }
                else{
                    
                    for(let i=0; i<markerData.length; i++){
                        const markerInfo = markerData[i];
                        if(markerInfo.stopNo == currentEmployeeStopNo){
                            continue;
                        }
                        const notBoardedMarker = L.marker(new L.LatLng(markerInfo.lat, markerInfo.lng),{
                            icon: L.icon({
                                iconUrl: `images/not_boarded/number-${markerInfo.stopNo}.png`,
                                iconSize: [24, 24],
                            })
                        }).addTo(mmiMap);
                    }
                }
                


                const validData = filteredData.filter(item => {
                    const lat = item.lat;
                    const lng = item.lng;

                    return lat !== null && lng !== null &&
                    lat !== 0 && lng !== 0 &&
                    lat !== '' && lng !== '' &&
                    lat !== 'undefined' && lng !== 'undefined' &&
                    !isNaN(lat) && !isNaN(lng);
                });
                console.log("validData: ", validData);   
                // const waypoints = validData.map(item => ({
                //     lat: item.lat, 
                //     lng: item.lng,
                    
                // }));
                const waypoints = [];

                for (let i = 0; i < validData.length; i++) {
                    const item = validData[i];
                    if (item.stopNo !== currentEmployeeStopNo && item.stopNo < currentEmployeeStopNo) {
                        waypoints.push({
                            lat: item.lat,
                            lng: item.lng,
                        });
                    } else {
                        // Optional: Handle excluded waypoints here (e.g., log them)
                        continue;
                    }
                }
                console.log("waypoints: ", waypoints);

                console.log("validData: " ,validData);
                var originLatLngs; 
                var originLatLngsGoogle; 
                var destinationLatLngsGoogle;

                var newElement;
    
                newPosition != null ? newElement = {lat: newPosition[0], lng: newPosition[1]} : newElement = {lat: fromloc[0], lng: fromloc[1]};

                originLatLngsGoogle = filteredData.slice(0, -1).map(item => 
                    ({lat: item.lat, lng: item.lng})
                ); 
    
                originLatLngsGoogle.unshift(newElement);
    
                destinationLatLngsGoogle = filteredData.map(item => ({lat: item.lat, lng: item.lng}));
                console.log("originLatLngsGoogle: ", originLatLngsGoogle);
                console.log("destinationLatLngsGoogle: ", destinationLatLngsGoogle);
                
                newPosition != null ? originLatLngs = newPosition + '|' + filteredData.slice(0,-1).map(item => `${item.lat},${item.lng}`).join('|') : originLatLngs = fromloc + '|' + filteredData.slice(0,-1).map(item => `${item.lat},${item.lng}`).join('|');
                console.log("originLatLngs: ", originLatLngs);
                
                const destinationLatLngs = filteredData.map(item => `${item.lat},${item.lng}`).join("|");
                console.log("destinationLatLngs: ", destinationLatLngs);
                //console.log(Date.now());

                if(true){
                    googleDistanceMatrixApi(stopNos, originLatLngsGoogle, destinationLatLngsGoogle, currentEmployeeStopNo);
                }
                else{
                    //nextbillionDistanceMatrixApi(stopNos, originLatLngs, destinationLatLngs, currentEmployeeStopNo);
                }
                // Convert waypoints array to the required format
                var waypointsArray;
                if(true){
                    waypointsArray = waypoints.map(point => ({
                        location: new google.maps.LatLng(point.lat, point.lng),
                        stopover: true
                    }));
                }
                

                console.log("waypointsArray: ", waypointsArray);

                console.log(`fromlat: ${fromloc[0]}/t fromlng: ${fromloc[1]}`);
            
                if(true){
                    if(myTrackingStatus !== 'Boarded' || myTrackingStatus !== 'No-Show'){
                        getDirections(currentEmployeeDetails, waypointsArray);
                    }
                }
                // else if(facility != 'BDC 10'){
                //     if(myTrackingStatus !== 'Boarded' || myTrackingStatus !== 'No-Show'){
                //         const directionsService = new nextbillion.maps.DirectionsService();

                //         var origin1 = newPosition != null ? 
                //         {lat: newPosition[0], lng: newPosition[1]} : {lat:fromloc[0], lng: fromloc[1]};

                //         directionsService.route({
                //             origin: origin1,
                //             waypoints: waypoints,
                //             destination: {lat: currentEmployeeDetails[0].lat, lng: currentEmployeeDetails[0].lng},
                //         })
                //         .then((response) => {
                //             nbMap.map.addSource("route", {
                //                 type: "geojson",
                //                 data: {
                //                     type: "Feature",
                //                     properties: {},
                //                     geometry: {
                //                         type: "LineString",
                //                         coordinates: nextbillion.utils.polyline
                //                         .decode(response.routes[0].geometry, 6)
                //                         .map((c) => c.reverse())
                //                     }
                //                 }
                //             });
                //             nbMap.map.addLayer({
                //                 id: "route",
                //                 type: "line",
                //                 source: "route",
                //                 layout: {
                //                     "line-join": "round",
                //                     "line-cap": "round"
                //                 },
                //                 paint: {
                //                     "line-color": "#8D5A9E",
                //                     "line-width": 4
                //                 }   
                //             });
                //         });
                    
                //     }
                // }
                
            }
            
        }

        function getDirections(currentEmployeeDetails, waypointsArray){
            var origin = newPosition != null ? 
            {lat: newPosition[0], lng: newPosition[1]} : {lat:fromloc[0], lng: fromloc[1]};
            
            var request = {
                origin: origin,
                destination: {lat: currentEmployeeDetails[0].lat, lng: currentEmployeeDetails[0].lng},
                waypoints: waypointsArray,
                travelMode: 'DRIVING'
            };

            directionsService.route(request, function(result, status){
                if(status == 'OK'){
                    console.log("directionsResult: ", result);
                    directionsRenderer.setDirections(result);
                }
            });
        }


        function Routedet() {
            $.ajax({
                type: "POST",
                username: "user1",
                password: "Acc@bang10",
                url: URL_RouteDetail,
                data: "{RouteID: '" + routeid + "',flag:'" + b2bflag + "'}",
                crossDomain: true,
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: sucess1,
                error: err1
            });

            function sucess1(data, status) {
                if(clientid =='25'){
                    if(facility == "KDC 1"){
                    
                        console.log("routedetresumed ");
                        const parsedData = typeof data == "string" ? JSON.parse(data) : data;
                        console.log("parsedData: " , parsedData);
                
                        const hashMap = new Map();
                        parsedData.map(item => hashMap.set(item.id, item.stopNo));
                        console.log("hashMap: " , hashMap);
                        console.log("empid: " + empid);
                        const currentEmployeeStopNo = hashMap.get(parseInt(empid));
                        console.log("stopNo: " + currentEmployeeStopNo);


                        const filteredData = parsedData.filter(item => (item.trackingStatus === "----" ));//|| item.trackingStatus !== "No-Show"
                        console.log("filteredData: " ,filteredData);
                
                
                        const currentEmployeeDetails = filteredData.filter(item => (item.stopNo == currentEmployeeStopNo));
                        console.log("currentEmployeeDetails: " , currentEmployeeDetails);

                        const stopNos = filteredData.map(item => item.stopNo);
                        console.log("stopNos: " + stopNos);
                

                        const boardedData = parsedData.filter(item => (item.trackingStatus === "Boarded"));
                        const stopNosBoarded = boardedData.map(item => item.stopNo);
                        console.log("stopNosBoarded: " , stopNosBoarded);
                
                        const boardedMarkerData = [];
                
                        for(let i=0; i<boardedData.length; i++){
                            const item = boardedData[i];
                            boardedMarkerData.push({
                                lat: item.lat,
                                lng: item.lng,
                                stopNo: item.stopNo,
                            });
                        }
                        console.log("markerData: " , boardedMarkerData);
                
                        for(let i=0; i<boardedMarkerData.length; i++) {
                            const markerInfo = boardedMarkerData[i];
                            if(markerInfo.stopNo == currentEmployeeStopNo){
                                continue;
                            }
                            const imagePath = `images/boarded/number-${markerInfo.stopNo}.png`;
                            const boardedEmployee = document.createElement("div");
                            boardedEmployee.className = "boardedEmployeeMarker";
                            boardedEmployee.style.backgroundImage = `url('${imagePath}')`;
                            boardedEmployee.style.backgroundSize = "cover";
                            boardedEmployee.style.width = "24px";
                            boardedEmployee.style.height = "24px";
                            const boardedEmployeeMarker = new nextbillion.maps.Marker({
                                element: boardedEmployee,
                            }).setLngLat({lat: markerInfo.lat, lng: markerInfo.lng})
                            .addTo(nbmap.map);
                        }
                
                
                        //const pointsToBePlotted = addMarkerForEmployeesNotBoarded(stopNo, stopNos);
                
                        const markerData = [];
                
                        for(let i=0; i<filteredData.length; i++){
                            const item = filteredData[i];
                            markerData.push({
                                lat: item.lat,
                                lng: item.lng,
                                stopNo: item.stopNo,
                            });
                        }
                        console.log("markerData: " , markerData);

                        for(let i=0; i<markerData.length; i++){
                            const markerInfo = markerData[i];
                            if(markerInfo.stopNo == currentEmployeeStopNo){
                                continue;
                            }
                            const imagePath = `images/not_boarded/number-${markerInfo.stopNo}.png`;
                            const elEmployee = document.createElement("div");
                            elEmployee.className = "employeeMarker";
                            elEmployee.style.backgroundImage = `url('${imagePath}')`; // Use default 'home.png' or custom icon
                            elEmployee.style.backgroundSize = "cover";
                            elEmployee.style.width = "24px";
                            elEmployee.style.height = "24px";
                            const employeeMarker = new nextbillion.maps.Marker({
                                element: elEmployee,
                            }).setLngLat({lat: markerInfo.lat, lng: markerInfo.lng})
                            .addTo(nbmap.map);
                        }

                        const validData = filteredData.filter(item => {
                            const lat = item.lat;
                            const lng = item.lng;

                            return lat !== null && lng !== null &&
                                lat !== 0 && lng !== 0 &&
                                lat !== '' && lng !== '' &&
                                lat !== 'undefined' && lng !== 'undefined' &&
                                !isNaN(lat) && !isNaN(lng);
                        });
                
                            // const waypoints = validData.map(item => ({
                            //     lat: item.lat, 
                            //     lng: item.lng,
                    
                            // }));
                        const waypoints = [];

                        for (let i = 0; i < validData.length; i++) {
                            const item = validData[i];
                            if (item.stopNo !== currentEmployeeStopNo && item.stopNo < currentEmployeeStopNo) {
                                waypoints.push({
                                    lat: item.lat,
                                    lng: item.lng,
                                });
                            } else {
                                // Optional: Handle excluded waypoints here (e.g., log them)
                                continue;
                            }
                        }
                        console.log("waypoints: ", waypoints);

                        console.log("validData: " ,validData);
                        const originLatLngs = newPosition + '|' + filteredData.slice(0,-1).map(item => `${item.lat},${item.lng}`).join('|');
                        console.log(originLatLngs);
                        const destinationLatLngs = filteredData.map(item => `${item.lat},${item.lng}`).join("|");
                        console.log(destinationLatLngs);
                        //console.log(Date.now());

                
                        if(myTrackingStatus !== 'Boarded' || myTrackingStatus !== 'No-Show'){
                            const directionsService = new nextbillion.maps.DirectionsService();

                            // if (driverlat != null && driverlng != null && driverlat != "" && driverlng != "" && driverlat != " " && driverlng != " "
                            //  && currentEmployeeDetails[0].lat != null && currentEmployeeDetails[0].lng != null && currentEmployeeDetails[0].lat != "" && currentEmployeeDetails[0].lng != ""
                            //  && currentEmployeeDetails[0].lat != " " && currentEmployeeDetails[0].lng != " " && currentEmployeeDetails != null && !currentEmployeeDetails.isEmpty()) {
                                directionsService.route({
                                    origin: {lat: driverlat, lng: driverlng},
                                    waypoints: waypoints,
                                    destination: {lat: currentEmployeeDetails[0].lat, lng: currentEmployeeDetails[0].lng},
                                })
                                .then((response) => {
                                    nbmap.map.addSource("route", {
                                        type: "geojson",
                                        data: {
                                            type: "Feature",
                                            properties: {},
                                            geometry: {
                                                type: "LineString",
                                                coordinates: nextbillion.utils.polyline
                                                .decode(response.routes[0].geometry, 6)
                                                .map((c) => c.reverse())
                                            }
                                        }
                                    });
                                    nbmap.map.addLayer({
                                        id: "route",
                                        type: "line",
                                        source: "route",
                                        layout: {
                                            "line-join": "round",
                                            "line-cap": "round"
                                        },
                                        paint: {
                                            "line-color": "#8D5A9E",
                                            "line-width": 4
                                        }   
                                    });
                                });
                        // }

                        
                    }   

                    $.ajax({
                        cache: false,
                        type: "GET",
                        url: "https://api.nextbillion.io/distancematrix/json?origins=" + encodeURIComponent(originLatLngs) + "&destinations=" + encodeURIComponent(destinationLatLngs) + "&mode=car&key=b160a9fc4f294504aaf36990ce9d829d&avoid=highway",
                        crossDomain: true,
                        contentType: "application/json; charset=utf-8",
                        dataType: "json",
                        success: OnSuccessApi,
                        error: OnErrorApi
                    });
                
                    function OnSuccessApi(data, status){
                        console.log(data);
                        var mappedDurations = data.rows.map((row, index) => {
                            if(row.elements.length > index){
                                return row.elements[index].duration.value;
                            }else{
                                return null;
                            }
                        });
                        console.log(mappedDurations);

                        let totalEta = 0;


                        const stopNoIndex = stopNos.indexOf(currentEmployeeStopNo);
                        console.log("stopNoIndex: " + stopNoIndex);
                        for(let i = 0; i <= stopNoIndex && i < mappedDurations.length; i++){
                            totalEta += mappedDurations[i];
                        }
                    
                        totalEta += (stopNoIndex*300);
                        console.log("totalEta: " + totalEta);
                        const eta = secondsToHms(totalEta);
                        console.log("eta: " + eta);
                        document.getElementById('eta').innerHTML = '<small>Reaching in<br></small>' + eta;
                    }

                    function OnErrorApi(error){
                        console.log(error);
                    }
                }
                else{

                }
            }
                
                else{
                    console.log("routedetresumed ");
                    const parsedData = typeof data == "string" ? JSON.parse(data) : data;
                    console.log("parsedData: " , parsedData);
                
                    const hashMap = new Map();
                    parsedData.map(item => hashMap.set(item.id, item.stopNo));
                    console.log("hashMap: " , hashMap);
                    console.log("empid: " + empid);
                    const currentEmployeeStopNo = hashMap.get(parseInt(empid));
                    console.log("stopNo: " + currentEmployeeStopNo);


                    const filteredData = parsedData.filter(item => (item.trackingStatus === "----" ));//|| item.trackingStatus !== "No-Show"
                    console.log("filteredData: " ,filteredData);
                
                
                    const currentEmployeeDetails = filteredData.filter(item => (item.stopNo == currentEmployeeStopNo));
                    console.log("currentEmployeeDetails: " , currentEmployeeDetails);

                    const stopNos = filteredData.map(item => item.stopNo);
                    console.log("stopNos: " + stopNos);
                

                    const boardedData = parsedData.filter(item => (item.trackingStatus === "Boarded"));
                    const stopNosBoarded = boardedData.map(item => item.stopNo);
                    console.log("stopNosBoarded: " , stopNosBoarded);
                
                    const boardedMarkerData = [];
                
                    for(let i=0; i<boardedData.length; i++){
                        const item = boardedData[i];
                        boardedMarkerData.push({
                            lat: item.lat,
                            lng: item.lng,
                            stopNo: item.stopNo,
                        });
                    }
                    console.log("markerData: " , boardedMarkerData);
                
                    for(let i=0; i<boardedMarkerData.length; i++) {
                        const markerInfo = boardedMarkerData[i];
                        if(markerInfo.stopNo == currentEmployeeStopNo){
                            continue;
                        }
                        const imagePath = `images/boarded/number-${markerInfo.stopNo}.png`;
                        const boardedEmployee = document.createElement("div");
                        boardedEmployee.className = "boardedEmployeeMarker";
                        boardedEmployee.style.backgroundImage = `url('${imagePath}')`;
                        boardedEmployee.style.backgroundSize = "cover";
                        boardedEmployee.style.width = "24px";
                        boardedEmployee.style.height = "24px";
                        const boardedEmployeeMarker = new nextbillion.maps.Marker({
                            element: boardedEmployee,
                        }).setLngLat({lat: markerInfo.lat, lng: markerInfo.lng})
                        .addTo(nbmap.map);
                    }
                
                
                    //const pointsToBePlotted = addMarkerForEmployeesNotBoarded(stopNo, stopNos);
                
                    const markerData = [];
                
                    for(let i=0; i<filteredData.length; i++){
                        const item = filteredData[i];
                        markerData.push({
                            lat: item.lat,
                            lng: item.lng,
                            stopNo: item.stopNo,
                        });
                    }
                    console.log("markerData: " , markerData);

                    for(let i=0; i<markerData.length; i++){
                        const markerInfo = markerData[i];
                        if(markerInfo.stopNo == currentEmployeeStopNo){
                            continue;
                        }
                        const imagePath = `images/not_boarded/number-${markerInfo.stopNo}.png`;
                        const elEmployee = document.createElement("div");
                        elEmployee.className = "employeeMarker";
                        elEmployee.style.backgroundImage = `url('${imagePath}')`; // Use default 'home.png' or custom icon
                        elEmployee.style.backgroundSize = "cover";
                        elEmployee.style.width = "24px";
                        elEmployee.style.height = "24px";
                        const employeeMarker = new nextbillion.maps.Marker({
                            element: elEmployee,
                        }).setLngLat({lat: markerInfo.lat, lng: markerInfo.lng})
                        .addTo(nbmap.map);
                    }

                    const validData = filteredData.filter(item => {
                        const lat = item.lat;
                        const lng = item.lng;

                        return lat !== null && lng !== null &&
                            lat !== 0 && lng !== 0 &&
                            lat !== '' && lng !== '' &&
                            lat !== 'undefined' && lng !== 'undefined' &&
                            !isNaN(lat) && !isNaN(lng);
                    });
                
                    // const waypoints = validData.map(item => ({
                    //     lat: item.lat, 
                    //     lng: item.lng,
                    
                    // }));
                    const waypoints = [];

                    for (let i = 0; i < validData.length; i++) {
                        const item = validData[i];
                        if (item.stopNo !== currentEmployeeStopNo && item.stopNo < currentEmployeeStopNo) {
                            waypoints.push({
                                lat: item.lat,
                                lng: item.lng,
                            });
                        } else {
                            // Optional: Handle excluded waypoints here (e.g., log them)
                            continue;
                        }
                    }
                    console.log("waypoints: ", waypoints);

                    console.log("validData: " ,validData);
                    const originLatLngs = fromloc + '|' + filteredData.slice(0,-1).map(item => `${item.lat},${item.lng}`).join('|');
                    console.log(originLatLngs);
                    const destinationLatLngs = filteredData.map(item => `${item.lat},${item.lng}`).join("|");
                    console.log(destinationLatLngs);
                    //console.log(Date.now());

                

                
                    if(myTrackingStatus !== 'Boarded' || myTrackingStatus !== 'No-Show'){
                        const directionsService = new nextbillion.maps.DirectionsService();

                        // if (driverlat != null && driverlng != null && driverlat != "" && driverlng != "" && driverlat != " " && driverlng != " "
                        //  && currentEmployeeDetails[0].lat != null && currentEmployeeDetails[0].lng != null && currentEmployeeDetails[0].lat != "" && currentEmployeeDetails[0].lng != ""
                        //  && currentEmployeeDetails[0].lat != " " && currentEmployeeDetails[0].lng != " " && currentEmployeeDetails != null && !currentEmployeeDetails.isEmpty()) {
                            directionsService.route({
                                origin: {lat: driverlat, lng: driverlng},
                                waypoints: waypoints,
                                destination: {lat: currentEmployeeDetails[0].lat, lng: currentEmployeeDetails[0].lng},
                            })
                            .then((response) => {
                                nbmap.map.addSource("route", {
                                    type: "geojson",
                                    data: {
                                        type: "Feature",
                                        properties: {},
                                        geometry: {
                                            type: "LineString",
                                            coordinates: nextbillion.utils.polyline
                                                .decode(response.routes[0].geometry, 6)
                                                .map((c) => c.reverse())
                                        }
                                    }
                                });
                                nbmap.map.addLayer({
                                    id: "route",
                                    type: "line",
                                    source: "route",
                                    layout: {
                                        "line-join": "round",
                                        "line-cap": "round"
                                    },
                                    paint: {
                                        "line-color": "#8D5A9E",
                                        "line-width": 4
                                    }   
                                });
                            });
                        // }

                        
                    }
                
                

                
                $.ajax({
                    cache: false,
                    type: "GET",
                    url: "https://api.nextbillion.io/distancematrix/json?origins=" + encodeURIComponent(originLatLngs) + "&destinations=" + encodeURIComponent(destinationLatLngs) + "&mode=car&key=88db710a74e44bf59a27b365912e06bb&avoid=highway",
                    crossDomain: true,
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    success: OnSuccessApi,
                    error: OnErrorApi
                });
                
                function OnSuccessApi(data, status){
                    console.log(data);
                    var mappedDurations = data.rows.map((row, index) => {
                        if(row.elements.length > index){
                            return row.elements[index].duration.value;
                        }else{
                            return null;
                        }
                    });
                    console.log(mappedDurations);

                    let totalEta = 0;


                    const stopNoIndex = stopNos.indexOf(currentEmployeeStopNo);
                    console.log("stopNoIndex: " + stopNoIndex);
                    for(let i = 0; i <= stopNoIndex && i < mappedDurations.length; i++){
                        totalEta += mappedDurations[i];
                    }
                    
                    totalEta += (stopNoIndex*300);
                    console.log("totalEta: " + totalEta);
                    const eta = secondsToHms(totalEta);
                    console.log("eta: " + eta);
                    document.getElementById('eta').innerHTML = '<small>Reaching in<br></small>' + eta;
                }

                    function OnErrorApi(error){
                        console.log(error);
                    }
                }


                $.each(JSON.parse(data), function (key, val) {
                    if (val.id == empid) {
                        employeeid = val.employeeID;
                        gender = val.Gender;
                        console.log(val.CabNoShow);
                        if ((val.CabNoShow == 0) && (clientid == '10' || clientid == '14' || clientid == '15' || clientid == '22')) {
                            $('#cabnoshow').show();
                        }
                        else {
                            $('#cabnoshow').hide();
                        }
                        if (val.tripType == 'D') {
                            $('#cabnoshow').hide();
                        }

                        if (clientid == '10' || clientid == '14' || clientid == '15'  || clientid == '22' || clientid == '25') {
                            //|| clientid == '25' removed for the time being.
                            $("#sharebut").show();
                        }
                        else {
                            $("#sharebut").hide();
                        }

                        myTrackingStatus = val.trackingStatus
                        if (myTrackingStatus != '----') {
                            boardingStatus.innerHTML = '<strong >' + myTrackingStatus.toUpperCase() + '</strong>';
                            boardingStatus.style.display = 'block';
                        } else {
                            boardingStatus.style.display = 'none';

                        }

                        OTP = val.boardingOTP;
                        if (OTP != '') {
                            document.getElementById('Otp').innerHTML = '<strong>OTP:  </strong>' + ' ' + OTP;
                        }

                        // if (myTrackingStatus == "No-Show") {
                        //     var call_btn = document.getElementById('call_btn');
                        //     call_btn.style.display = 'none';
                        //     var help_btn = document.getElementById('help_btn');
                        //     help_btn.style.display = 'inherit';
                        //     var call_action = document.getElementById('call_action');
                        //     call_action.style.alignItems = 'center';
                        //     call_action.style.justifyContent = 'center';
                        //     call_action.style.textAlign = 'center';
                        //     var selfnoshow_btn = document.getElementById('selfNoShowButton');
                        //     selfnoshow_btn.style.display = 'none';
                        //     $("#Otp").hide();
                        //     $("#call_btn").hide();
                        //     $("#chat").hide();
                        //     // $("#boarding_status").hide();

                        //     clearInterval(etainterval);

                        //     $('#eta_div').hide();
                        //     $("#Otp").hide();
                        //     clearInterval(locupdate);
                        //     $('#chatBox').offcanvas('hide');

                        // } else if (myTrackingStatus == "Boarded" || val.tripType == 'D') {
                        //     callButton.style.display = 'none';
                        //     selfNoShowButton.style.display = 'none';
                        //     helpButton.style.display = 'block';
                        //     var call_action = document.getElementById('callAction');
                        //     call_action.style.alignItems = 'center';
                        //     call_action.style.justifyContent = 'center';
                        //     call_action.style.textAlign = 'center';
                        //     $('#cabnoshow').hide();
                        //     $("#Otp").hide();
                        //     $("#chat").hide();
                        //     //$("#boarding_status").hide();
                        //     $('#eta_div').hide();
                        //     $("#Otp").hide();
                        //     clearInterval(etainterval);

                        //     clearInterval(locupdate);
                        //     $('#offcanvasBottom').offcanvas('hide');
                        //     $('#offcanvasExample').offcanvas('hide');
                        //     $('#chatBox').offcanvas('hide');

                        // }
                        // else if (myTrackingStatus == "De-Boarded" || val.tripType == 'D') {
                        //     var call_btn = document.getElementById('call_btn');
                        //     call_btn.style.display = 'none';
                        //     var help_btn = document.getElementById('help_btn');
                        //     help_btn.style.display = 'inherit';
                        //     var call_action = document.getElementById('call_action');
                        //     call_action.style.alignItems = 'center';
                        //     call_action.style.justifyContent = 'center';
                        //     call_action.style.textAlign = 'center';
                        //     $('#cabnoshow').hide();
                        //     $("#Otp").hide();
                        //     $("#chat").hide();
                        //     //$("#boarding_status").hide();
                        //     $('#eta_div').hide();
                        //     $("#Otp").hide();
                        //     clearInterval(etainterval);
                        //     $("#sharebut").hide();

                        //     clearInterval(locupdate);
                        //     $('#offcanvasBottom').offcanvas('hide');
                        //     $('#offcanvas').offcanvas('hide');
                        //     $('#chatBox').offcanvas('hide');
                        // }

                        // else {
                        // }

                        if (value1 == 's') {
                            var call_btn = document.getElementById('call_btn');
                            call_btn.style.display = 'none';
                            var help_btn = document.getElementById('help_btn');
                            help_btn.style.display = 'inherit';
                            $("#Otp").hide();
                            //$("#boarding_status").hide();

                            clearInterval(etainterval);

                            $('#eta_div').hide();
                            $("#Otp").hide();
                            $("#cabnoshow").hide();
                            $("#sharebut").hide();
                            $('#hamburgernav').hide();

                            $('#call_action').hide();
                            

                            
                            const element = document.getElementById("call_action");

                            // Check if the element exists and hide it
                            if (element) {
                                element.style.display = "none";
                            }
                        }

                        var aTag = document.getElementById('aTag');
                        aTag.setAttribute('data-rel', 'external');
                        aTag.setAttribute('href', 'tel:' + tptContactNo[0]);

                    }

                });

            }

            function err1(request, status, error) {
                console.log('ERROR')

            }
        }

        function validateInput(inputElement) {
            // Define a regular expression to match emojis
            var emojiRegex = /[\u{1F600}-\u{1F64F}\u{1F300}-\u{1F5FF}\u{1F680}-\u{1F6FF}\u{1F700}-\u{1F77F}\u{1F780}-\u{1F7FF}\u{1F800}-\u{1F8FF}\u{1F900}-\u{1F9FF}\u{1FA00}-\u{1FA6F}\u{2600}-\u{26FF}\u{2700}-\u{27BF}]/gu;

            // Check if the input contains emojis
            if (emojiRegex.test(inputElement.value)) {
                alert('Emojis are not allowed in the input!');
                // Remove emojis from the input
                inputElement.value = inputElement.value.replace(emojiRegex, '');
            }
        }

        setTimeout(function () {

            // const shareLocationButton = document.getElementById("shareLocation");
            // shareLocationButton.addEventListener("click", () => {
            //     if ("geolocation" in navigator) {
            //         navigator.geolocation.getCurrentPosition(function (position) {
            //             const latitude = position.coords.latitude;
            //             const longitude = position.coords.longitude;

            //             const geoLink = `https://www.google.com/maps?q=${latitude},${longitude}`;
            //             var message = geoLink
            //             const messageText = message;
            //             if (messageText !== '') {
            //                 const newMessageRef = database.ref(`chats/trips/${routeID}/messages`).push();
            //                 newMessageRef.set({
            //                     sender: currentUserID,
            //                     receiver: driverID,
            //                     content: messageText,
            //                     timestamp: firebase.database.ServerValue.TIMESTAMP
            //                 });
            //                 console.log(':::>' + driverFCMToken);
            //                 sendPushNotification(driverFCMToken, messageText);
            //             }
            //             messageElement.appendChild(messageText);
            //             window.open(geoLink, "_blank")
            //         }, function (error) {
            //             alert(`Error getting location: $(error.message)`);
            //         });
            //     } else {
            //         alert("Geolocation is not supported in this browser.");
            //     }
            // });

            const tabs = document.querySelectorAll(".scrollable-tabs-container a");
            const rightArrow = document.querySelector(
                ".scrollable-tabs-container .right-arrow svg"
            );
            const leftArrow = document.querySelector(
                ".scrollable-tabs-container .left-arrow svg"
            );
            const tabsList = document.querySelector(".scrollable-tabs-container ul");
            const leftArrowContainer = document.querySelector(
                ".scrollable-tabs-container .left-arrow"
            );
            const rightArrowContainer = document.querySelector(
                ".scrollable-tabs-container .right-arrow"
            );

            const removeAllActiveClasses = () => {
                tabs.forEach((tab) => {
                    tab.classList.remove("active");
                });
            };

            tabs.forEach((tab) => {
                tab.addEventListener("click", () => {
                    removeAllActiveClasses();
                    tab.classList.add("active");
                });
            });

            const manageIcons = () => {
                if (tabsList.scrollLeft >= 20) {
                    leftArrowContainer.classList.add("active");
                } else {
                    leftArrowContainer.classList.remove("active");
                }

                let maxScrollValue = tabsList.scrollWidth - tabsList.clientWidth - 20;
                //console.log("scroll width: ", tabsList.scrollWidth);
                //console.log("client width: ", tabsList.clientWidth);

                if (tabsList.scrollLeft >= maxScrollValue) {
                    rightArrowContainer.classList.remove("active");
                } else {
                    rightArrowContainer.classList.add("active");
                }
            };

            rightArrow.addEventListener("click", () => {
                tabsList.scrollLeft += 200;
                manageIcons();
            });

            leftArrow.addEventListener("click", () => {
                tabsList.scrollLeft -= 200;
                manageIcons();
            });

            tabsList.addEventListener("scroll", manageIcons);

            let dragging = false;

            const drag = (e) => {
                if (!dragging) return;
                tabsList.classList.add("dragging");
                tabsList.scrollLeft -= e.movementX;
            };

            tabsList.addEventListener("mousedown", () => {
                dragging = true;
            });

            tabsList.addEventListener("mousemove", drag);

            document.addEventListener("mouseup", () => {
                dragging = false;
                tabsList.classList.remove("dragging");
            });

            var messageElement1 = document.getElementById('chat-messages1');
            $.ajax({
                url: 'https://www.etmsdrive.in/appControlRest/api/v1/application/chat/22/0',
                method: 'GET',
                success: OnSuccess,
                error: onError
            });
            function OnSuccess(response) {
                const parsedData = JSON.parse(response);
                const messageInput = document.getElementById("message-input");
                //const parent = document.getElementById('chat-messages1-div');
                const list = document.querySelector('#chat-messages1');
                for (let i = 0; i < parsedData.length; i++) {
                    const li = document.createElement('li');
                    const a = document.createElement('a');
                    a.href = "#";
                    a.textContent = parsedData[i].text;
                    li.addEventListener("click", function () {
                        //alert("You clicked: " + li.textContent);
                        const messageText = li.textContent;
                        if (messageText !== '') {
                            messageInput.value = messageText;
                        }
                        // if (messageText !== '') {
                        //     const newMessageRef = database.ref(`chats/trips/${routeID}/messages`).push();
                        //     newMessageRef.set({
                        //         sender: currentUserID,
                        //         receiver: driverID,
                        //         content: messageText,
                        //         timestamp: firebase.database.ServerValue.TIMESTAMP

                        //     });
                        //     console.log(':::>' + driverFCMToken);
                        //     sendPushNotification(driverFCMToken, messageText);
                        // }
                    });
                    li.appendChild(a);
                    list.appendChild(li);
                }
                // Process the parsed data here 
                //messageElement1.appendChild(list);
            };
            function onError(xhr, status, error) {
                // Handle any errors 
            }
            // Chat feature

            // Initialize Firebase
            const firebaseConfig = {
                apiKey: "AIzaSyA09UwnVN0gTIHXjZokBBBXCEGyWrZ9rBk",
                authDomain: "etmsdrive-89370.firebaseapp.com",
                databaseURL: "https://etmsdrive-89370.firebaseio.com/",
                projectId: "etmsdrive-89370",
                storageBucket: "etmsdrive-89370.appspot.com",
                messagingSenderId: "351746301370",
                appId: "1:351746301370:android:361973f28e3375bc"
            };
            let isNewMessage = false;
            // Get the URL parameters
            //const urlParams = new URLSearchParams(window.location.search);

            // Get the values using the parameter names
            var _routeId = routeid;
            var _driverNo = driver_contact1;
            var _empName = emp_contact;

            console.log('Route ID:', _routeId);
            console.log('Driver Number:', _driverNo);
            console.log('Employee Number:', _empName);

            firebase.initializeApp(firebaseConfig);
            const database = firebase.database();

            if (firebase.messaging.isSupported()) {
                const messaging = firebase.messaging();

                if ("serviceWorker" in navigator) {
                    navigator.serviceWorker
                        .register("/firebase-messaging-sw.js") // Path to your firebase-messaging-sw.js file
                        .then((registration) => {
                            messaging.useServiceWorker(registration); // Associate service worker with messaging instance
                        })
                        .catch((error) => {
                            console.error("Service Worker registration failed:", error);
                        });
                }

                messaging.requestPermission()
                    .then(() => {
                        return messaging.getToken();
                    })
                    .then(token => {
                        console.log('FCM Token:', token);

                    }).catch((error) => {
                        console.log('Error requesting permission:', error);
                    });

                messaging.onMessage(function (message) {
                    console.log("onMessage event fired", message);
                });
            }





            const messageInput = document.getElementById('message-input');
            const sendButton = document.getElementById('send-button');
            const chatMessages = document.getElementById('chat-messages');

            const routeID = _routeId;//'223523R0002';
            const driverID = _driverNo;//'9810025215';
            const currentUserID = _empName;
            const currentEmployeeId =  //'Anurag singh'; 
            console.log(driverID);
            console.log(currentUserID);
            //const empMobile = _empMobile;//1234567890
            var driverFCMToken;




            // const messagesRef = database.ref(`chats/trips/${routeID}/messages`); 
            // messagesRef.once("value")
            // .then(function(snapshot) {
            //   var data = snapshot.val();
            //   console.log(data); // Log the retrieved data
            //   const uniqueSenders = {};


            //   for (const key in data) {
            //       const driverFCMToken = data[key].driverFCMToken;
            //       if (driverFCMToken && typeof driverFCMToken === 'string' && driverFCMToken.trim() !== '') {
            //           uniqueSenders[driverFCMToken] = true;
            //       }
            //   }
            //   driverToken = Object.keys(uniqueSenders).join(', ');
            //   console.log(driverToken);
            // })
            // .catch(function(error) {
            //   console.error("Error fetching data:", error);
            // });

            // Assuming you have the routeID from somewhere

            const messagesRef = database.ref(`chats/trips/${routeID}`);

            messagesRef.once("value")
                .then(function (snapshot) {
                    const tripData = snapshot.val();
                    if (tripData) {
                        driverFCMToken = tripData.driverFCMToken;
                        if (driverFCMToken && typeof driverFCMToken === 'string' && driverFCMToken.trim() !== '') {
                            console.log("Driver's FCM Token:", driverFCMToken);


                        } else {
                            console.log("Driver's FCM Token is not available or invalid.");
                        }
                    } else {
                        console.log("Trip data not found.");
                    }
                })
                .catch(function (error) {
                    console.error("Error fetching trip data:", error);
                });

            messageInput.addEventListener('keyup', function (event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    const messageText = messageInput.value.trim();
                    if(driverFCMToken && typeof driverFCMToken === 'string' && driverFCMToken !== ''){
                        if (messageText !== '') {
                            const newMessageRef = database.ref(`chats/trips/${routeID}/messages`).push();
                            newMessageRef.set({
                                sender: currentUserID,
                                receiver: driverID,
                                content: messageText,
                                is_read: false,
                                timestamp: firebase.database.ServerValue.TIMESTAMP

                            });
                            const tokenReference = database.ref(`chats/trips/${routeID}`);
                            tokenReference.once("value").then(function(snapshot){
                            const tripData = snapshot.val();
                            if(tripData){
                                driverFCMToken = tripData.driverFCMToken;
                                if (driverFCMToken && typeof driverFCMToken === 'string' && driverFCMToken.trim() !== '') {
                                    console.log(':::>' + driverFCMToken);
                                    sendPushNotification(driverFCMToken, messageText);
                                    messageInput.value = '';
                                }
                            }

                        })
                            // console.log(':::>' + driverFCMToken);
                            // sendPushNotification(driverFCMToken, messageText);
                            // messageInput.value = '';
                        }
                    }  
                }
            });

            sendButton.addEventListener('click', () => {
                // scrollToBottom();
                const messageText = messageInput.value.trim();                
                    if (messageText !== '') {
                        const newMessageRef = database.ref(`chats/trips/${routeID}/messages`).push();
                        newMessageRef.set({
                            sender: currentUserID,
                            receiver: driverID,
                            content: messageText,
                            is_read: false,
                            timestamp: firebase.database.ServerValue.TIMESTAMP

                        });
                        const tokenReference = database.ref(`chats/trips/${routeID}`);
                        tokenReference.once("value").then(function(snapshot){
                            const tripData = snapshot.val();
                            if(tripData){
                                driverFCMToken = tripData.driverFCMToken;
                                if (driverFCMToken && typeof driverFCMToken === 'string' && driverFCMToken.trim() !== '') {
                                    console.log(':::>' + driverFCMToken);
                                    sendPushNotification(driverFCMToken, messageText);
                                    messageInput.value = '';
                                }
                            }

                        })
                        // console.log(':::>' + driverFCMToken);
                        // sendPushNotification(driverFCMToken, messageText);
                        // messageInput.value = '';
                    }
                                
            });



            database.ref(`chats/trips/${routeID}/messages`).on('child_added', snapshot => {
                const message = snapshot.val();

                if (message.receiver === currentUserID) {
                    //displayRedDot();
                    //playNotificationSound();

                }

                if (message.sender === currentUserID || message.receiver === currentUserID) {
                    console.log("this_user_message" + message);
                    const messageElement = document.createElement('div');
                    const messageContent = document.createElement('div');
                    const timestampElement = document.createElement('div');
                    messageContent.innerText = message.content;
                    const timestamp = new Date(message.timestamp);
                    const formattedTime = timestamp.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit', hour12: true });
                    timestampElement.classList.add('timestamp');
                    timestampElement.innerText = formattedTime;

                    // Determine message alignment based on sender
                    messageElement.appendChild(messageContent);
                    messageElement.appendChild(timestampElement);

                    if (message.sender === currentUserID) {
                        messageElement.classList.add('chats', 'sender');
                    } else {
                        // Show notification only for new messages
                        if (isNewMessage) {
                            showNotification('New Message', message.content);
                        }
                        isNewMessage = true; // Set the flag to true for the next messages
                        messageElement.classList.add('chats', 'recevier');
                    }
                    messageElement.classList.add('animate__animated', 'animate__headShake');
                    chatMessages.appendChild(messageElement);
                }
            });

            database.ref(`chats/trips/${routeID}/messages`).on('child_removed', snapshot => {
                const messageId = snapshot.key;
                const messageElementToRemove = document.querySelector(`[data-message-id="${messageId}"]`);

                if (messageElementToRemove) {
                    messageElementToRemove.remove();
                }
            });

            function sendPushNotification(recipientFCMToken, message) {
                fetch('https://fcm.googleapis.com/fcm/send', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        Authorization: 'Bearer AAAAUeW2nbo:APA91bFykoDdjXFrBo4qoRh0SvR7twUvPet-onaHvy29OGV7eJR7uMSaw042aEtC0VAEZmlYUd9eeVNfFz4DuifRAiePprBKf2cE7pHIkF1DZdY5fHG7NDqOazTna5rlFkxUlXrOcEpgtSJPL27-l_QGLlmhutR_Hg', // Replace with your FCM server key
                    },
                    body: JSON.stringify({
                        to: recipientFCMToken,
                        notification: {
                            title: 'New Message',
                            body: message,
                            click_action: 'your-action-url',
                        },
                    }),
                })
                    .then(response => response.json())
                    .then(data => {
                        console.log('Push notification sent:', data);
                    })
                    .catch(error => {
                        console.error('Error sending push notification:', error);
                    });
            }

            function showNotification(title, body) {
                // Check if the browser supports notifications
                if (!('Notification' in window)) {
                    console.log('This browser does not support notifications.');
                    return;
                }

                // Check if permission to show notifications has been granted
                if (Notification.permission === 'granted') {
                    // Create and show the notification
                    const notification = new Notification(title, { body });
                } else if (Notification.permission !== 'denied') {
                    // If permission is not denied, request permission
                    Notification.requestPermission().then(permission => {
                        if (permission === 'granted') {
                            // Create and show the notification
                            const notification = new Notification(title, { body });
                        }
                    });
                }
            }


            //Chat Feature

        }, 3000);        

        
    </script>
    <!-- <script
    src="https://maps.googleapis.com/maps/api/js?libraries=geometry&key=AIzaSyDKatXVfQNHCj7iNP95PhsOkO9vFmYI-bA&callback=initMap" async defer></script> -->
    
    
  </body>
</html>
